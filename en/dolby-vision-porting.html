<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent Flash of Incorrect Theme (FOIT) -->
    <script>
    (function(){var t=localStorage.getItem('android-media-framework-theme');if(t)document.documentElement.setAttribute('data-theme',t);else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches)document.documentElement.setAttribute('data-theme','light');})();
    </script>
    <title>Dolby Vision Porting Guide | Android Media Framework</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;900&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/design-system.css">

    <style>
        /* Page-specific styles */
        .alert {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .alert-title {
            font-weight: 600;
            color: #ffc107;
            margin-bottom: var(--spacing-sm);
        }

        .alert p {
            margin: 0;
            color: var(--color-text-secondary);
        }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-left: 4px solid var(--color-accent);
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .info-box-title {
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: var(--spacing-sm);
        }

        .success-box {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-left: 4px solid #22c55e;
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .success-box-title {
            font-weight: 600;
            color: #22c55e;
            margin-bottom: var(--spacing-sm);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: var(--spacing-sm);
        }

        .code-block {
            background: var(--color-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .code-block code {
            color: var(--color-text-primary);
        }

        .file-path {
            display: inline-block;
            background: rgba(0, 212, 255, 0.15);
            color: var(--color-accent);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            position: relative;
            padding-left: 28px;
            margin-bottom: var(--spacing-sm);
        }

        .checklist li::before {
            content: '☐';
            position: absolute;
            left: 0;
            color: var(--color-accent);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-lg) 0;
        }

        .comparison-table th,
        .comparison-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background: var(--color-surface);
            color: var(--color-accent);
            font-weight: 600;
        }

        .comparison-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tag-required {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .tag-optional {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .tag-android15 {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .tag-hdr {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
        }

        .mermaid-container {
            background: var(--color-surface);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            overflow-x: auto;
        }

        h3 {
            color: var(--color-accent);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            font-size: 1.3rem;
        }

        h4 {
            color: var(--color-text-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            font-size: 1.1rem;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }

        .profile-card {
            background: var(--color-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: var(--spacing-lg);
            transition: all 0.3s ease;
        }

        .profile-card:hover {
            border-color: var(--color-accent);
            transform: translateY(-4px);
        }

        .profile-card h4 {
            color: var(--color-accent);
            margin-top: 0;
            margin-bottom: var(--spacing-sm);
        }

        .profile-card p {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
        }

        .profile-meta {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <nav class="nav">
        <a href="dolby-codecs.html" class="nav-button">
            ← Dolby Codecs
        </a>
    </nav>

    <div class="container">
        <header>
            <h1 class="page-title">Dolby Vision Porting Guide</h1>
            <p class="page-subtitle">Comprehensive porting guide for integrating Dolby Vision HDR support into Android Codec2, MediaCodec, and Display HAL</p>
        </header>

        <!-- Section 1: Prerequisites -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">1</span>
                Prerequisites & Hardware
            </h2>
            <p class="section-description">
                Dolby Vision requires integration across the entire video pipeline (Decoder → Compositor → Display).
                It cannot be implemented with software alone; certified hardware is mandatory.
            </p>

            <div class="alert">
                <div class="alert-title">Hardware Certification Required</div>
                <p>Dolby Vision requires a <strong>Dolby Vision Certified SoC</strong> and an <strong>HDR-capable display panel</strong>.
                    Both hardware certification and software license must be obtained from Dolby Laboratories.</p>
            </div>

            <h3>1.1 Hardware Requirements</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Requirement</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Video Decoder</strong></td>
                        <td>HEVC Main 10 + Dolby Vision extension</td>
                        <td>10-bit decoding, RPU metadata parsing support</td>
                    </tr>
                    <tr>
                        <td><strong>Display Panel</strong></td>
                        <td>HDR10 or Dolby Vision certified</td>
                        <td>10-bit/12-bit color depth, PQ/HLG EOTF</td>
                    </tr>
                    <tr>
                        <td><strong>Display Processor</strong></td>
                        <td>Dolby Vision Processing Unit (VPU)</td>
                        <td>Dynamic tone mapping, metadata processing</td>
                    </tr>
                    <tr>
                        <td><strong>GPU/DPU</strong></td>
                        <td>BT.2020 color gamut support</td>
                        <td>Wide Color Gamut rendering</td>
                    </tr>
                    <tr>
                        <td><strong>HDMI (for TV)</strong></td>
                        <td>HDMI 2.0b+ with HDCP 2.2</td>
                        <td>Dolby Vision signal transmission</td>
                    </tr>
                </tbody>
            </table>

            <h3>1.2 Dolby Vision Support by Android Version</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Android Version</th>
                        <th>Supported Features</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Android 7.0+</td>
                        <td>Basic playback support</td>
                        <td>MediaCodec, ExoPlayer</td>
                    </tr>
                    <tr>
                        <td>Android 13+</td>
                        <td>Capture (recording) support</td>
                        <td>Profile 8.4, Camera2 API</td>
                    </tr>
                    <tr>
                        <td>Android 14+</td>
                        <td>AIDL HAL mandatory</td>
                        <td>Codec2 AIDL interface</td>
                    </tr>
                    <tr>
                        <td><strong>Android 15+</strong></td>
                        <td>HDR Headroom Control</td>
                        <td><code>setDesiredHdrHeadroom()</code> API</td>
                    </tr>
                </tbody>
            </table>

            <h3>1.3 Supported Dolby Vision Profiles</h3>
            <div class="profile-grid">
                <div class="profile-card">
                    <h4>Profile 5</h4>
                    <p>Primarily used by streaming services (Netflix, Disney+, etc.). Based on IPTPQc2 color space.</p>
                    <div class="profile-meta">
                        <span class="tag tag-required">Streaming</span>
                        <span class="tag tag-hdr">Single Layer</span>
                    </div>
                </div>
                <div class="profile-card">
                    <h4>Profile 7</h4>
                    <p>For Blu-ray media. Dual Layer (Base + Enhancement).</p>
                    <div class="profile-meta">
                        <span class="tag tag-optional">Blu-ray</span>
                        <span class="tag tag-hdr">Dual Layer</span>
                    </div>
                </div>
                <div class="profile-card">
                    <h4>Profile 8.1</h4>
                    <p>Backward compatible with HDR10. Cross-compatible metadata.</p>
                    <div class="profile-meta">
                        <span class="tag tag-required">HDR10 Compatible</span>
                        <span class="tag tag-hdr">Single Layer</span>
                    </div>
                </div>
                <div class="profile-card">
                    <h4>Profile 8.4</h4>
                    <p>HLG-based. Suitable for broadcast and user-generated content (UGC).</p>
                    <div class="profile-meta">
                        <span class="tag tag-android15">Android 13+ Capture</span>
                        <span class="tag tag-hdr">HLG Base</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Architecture -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">2</span>
                Integration Architecture
            </h2>
            <p class="section-description">
                Dolby Vision integration is divided into three main parts: <strong>Codec2 Component</strong> (decoding),
                <strong>SurfaceFlinger/HWC</strong> (composition), and <strong>Display HAL</strong> (tone mapping).
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph TD
                        subgraph Application
                            App[ExoPlayer / Media3]
                        end

                        subgraph MediaFramework ["Media Framework"]
                            MC[MediaCodec API]
                            Extractor[MediaExtractor<br/>dvcC / dvvC box parsing]
                        end

                        subgraph Codec2 ["Codec2 Framework"]
                            C2FW[C2 Component Store]
                            C2Comp[c2.vendor.dv.decoder]
                        end

                        subgraph VendorHW ["Vendor Hardware"]
                            HWDecoder[HW Video Decoder<br/>HEVC Main 10]
                            RPUParser[RPU Parser<br/>Metadata Extraction]
                        end

                        subgraph Graphics ["Graphics Pipeline"]
                            GB[GraphicBuffer<br/>YUV P010 + Metadata]
                            SF[SurfaceFlinger]
                            HWC[HWComposer]
                        end

                        subgraph Display ["Display HAL"]
                            VPU[Dolby VPU<br/>Tone Mapping]
                            Panel[HDR Display Panel]
                        end

                        App --> MC
                        App --> Extractor
                        Extractor --> MC
                        MC --> C2FW
                        C2FW --> C2Comp
                        C2Comp --> HWDecoder
                        C2Comp --> RPUParser
                        HWDecoder --> GB
                        RPUParser --> GB
                        GB --> SF
                        SF --> HWC
                        HWC --> VPU
                        VPU --> Panel
                </div>
            </div>

            <h3>2.1 Dolby Vision Stream Structure</h3>
            <div class="info-box">
                <div class="info-box-title">Stream Components</div>
                <p>
                    <strong>Base Layer (BL):</strong> HEVC Main 10 encoded base video<br>
                    <strong>Enhancement Layer (EL):</strong> Additional quality information (Profile 7 only)<br>
                    <strong>RPU (Reference Picture Unit):</strong> Dynamic metadata (per-scene brightness/color info)
                </p>
            </div>

            <div class="code-block">
<code># Dolby Vision Container Box (MP4/MKV)
dvcC / dvvC Box:
├── dv_version_major: 1
├── dv_version_minor: 0
├── dv_profile: 8 (Profile 8.x)
├── dv_level: 6 (4K60)
├── rpu_present_flag: 1
├── el_present_flag: 0 (Single Layer)
├── bl_present_flag: 1
└── dv_bl_signal_compatibility_id: 1 (HDR10 compatible)</code>
            </div>
        </section>

        <!-- Section 3: Codec2 Implementation -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">3</span>
                Codec2 Component Implementation
            </h2>

            <h3>3.1 C2 Component Registration</h3>
            <p>Register the Dolby Vision decoder in <span class="file-path">media_codecs.xml</span>:</p>

            <div class="code-block">
<code class="language-xml">&lt;MediaCodecs&gt;
    &lt;Decoders&gt;
        &lt;!-- Dolby Vision HEVC Decoder --&gt;
        &lt;MediaCodec name="c2.vendor.dv.decoder" type="video/dolby-vision"&gt;
            &lt;!-- Resolution limits --&gt;
            &lt;Limit name="size" min="176x144" max="3840x2160" /&gt;
            &lt;Limit name="alignment" value="2x2" /&gt;
            &lt;Limit name="block-size" value="16x16" /&gt;

            &lt;!-- Frame rate --&gt;
            &lt;Limit name="frame-rate" range="1-60" /&gt;

            &lt;!-- Bitrate (based on HEVC Main 10) --&gt;
            &lt;Limit name="bitrate" range="1-60000000" /&gt;

            &lt;!-- Concurrent instances --&gt;
            &lt;Limit name="concurrent-instances" max="16" /&gt;

            &lt;!-- Feature flags --&gt;
            &lt;Feature name="adaptive-playback" /&gt;
            &lt;Feature name="secure-playback" required="true" /&gt;
            &lt;Feature name="tunneled-playback" /&gt;

            &lt;!-- Dolby Vision profile support --&gt;
            &lt;!-- Profile 5, 8.1, 8.4 support specified --&gt;
        &lt;/MediaCodec&gt;

        &lt;!-- Secure Dolby Vision Decoder (for DRM content) --&gt;
        &lt;MediaCodec name="c2.vendor.dv.decoder.secure" type="video/dolby-vision"&gt;
            &lt;Limit name="size" min="176x144" max="3840x2160" /&gt;
            &lt;Feature name="secure-playback" required="true" /&gt;
            &lt;Feature name="tunneled-playback" required="true" /&gt;
        &lt;/MediaCodec&gt;
    &lt;/Decoders&gt;
&lt;/MediaCodecs&gt;</code>
            </div>

            <h3>3.2 C2 Component Implementation (Core)</h3>
            <p>Main implementation in <span class="file-path">C2DolbyVisionDec.cpp</span>:</p>

            <div class="code-block">
<code class="language-cpp">// C2DolbyVisionDec.cpp - Codec2 Dolby Vision Decoder

class C2DolbyVisionDec : public C2Component {
public:
    C2DolbyVisionDec(const char* name, c2_node_id_t id,
                     const std::shared_ptr&lt;C2ComponentInterface&gt;&amp; intf)
        : C2Component(intf), mName(name), mId(id) {
        // Initialize Dolby Vision decoder
        initDolbyVisionDecoder();
    }

    c2_status_t onInit() override {
        // Initialize HW decoder
        mHwDecoder = createHwDecoder(CODEC_HEVC_MAIN10);

        // Initialize RPU parser
        mRpuParser = createRpuParser();

        // Initialize metadata handler
        mMetadataHandler = createDvMetadataHandler();

        return C2_OK;
    }

    c2_status_t queue_nb(std::list&lt;std::unique_ptr&lt;C2Work&gt;&gt;* const items) override {
        for (auto&amp; work : *items) {
            processWork(std::move(work));
        }
        return C2_OK;
    }

private:
    void processWork(std::unique_ptr&lt;C2Work&gt; work) {
        // 1. Separate HEVC + RPU data from input buffer
        const C2ConstLinearBlock&amp; input = work-&gt;input.buffers[0]-&gt;data();
        uint8_t* data = const_cast&lt;uint8_t*&gt;(input.data());
        size_t size = input.size();

        HevcFrame hevcFrame;
        RpuData rpuData;
        separateDolbyVisionData(data, size, &amp;hevcFrame, &amp;rpuData);

        // 2. HEVC decoding (HW accelerated)
        DecodedFrame decodedFrame;
        mHwDecoder-&gt;decode(hevcFrame, &amp;decodedFrame);

        // 3. RPU metadata parsing
        DolbyVisionMetadata dvMetadata;
        mRpuParser-&gt;parse(rpuData, &amp;dvMetadata);

        // 4. Create output buffer (YUV P010 + metadata)
        std::shared_ptr&lt;C2GraphicBlock&gt; outputBlock;
        createOutputBuffer(&amp;outputBlock, decodedFrame, dvMetadata);

        // 5. Attach metadata to GraphicBuffer
        attachDvMetadata(outputBlock, dvMetadata);

        // 6. Complete work processing
        work-&gt;worklets.front()-&gt;output.buffers.push_back(
            createBuffer(outputBlock)
        );
        work-&gt;worklets.front()-&gt;output.ordinal = work-&gt;input.ordinal;
        work-&gt;result = C2_OK;

        // Notify listener of completion
        mListener-&gt;onWorkDone_nb(this, std::move(work));
    }

    void attachDvMetadata(std::shared_ptr&lt;C2GraphicBlock&gt;&amp; block,
                          const DolbyVisionMetadata&amp; metadata) {
        // Get native handle of GraphicBuffer
        native_handle_t* handle = block-&gt;handle();

        // Set Gralloc metadata
        android::gralloc4::MetadataType type =
            android::gralloc4::MetadataType_DolbyVisionMetadata;

        std::vector&lt;uint8_t&gt; metadataBlob;
        serializeMetadata(metadata, &amp;metadataBlob);

        android::gralloc4::set(handle, type, metadataBlob);

        // Set HDR Static Info (used by Display)
        HdrStaticInfo hdrInfo = {
            .maxDisplayLuminance = metadata.maxCll,
            .maxContentLightLevel = metadata.maxCll,
            .maxFrameAverageLightLevel = metadata.maxFall,
            .minDisplayLuminance = metadata.minLuminance,
        };
        setHdrStaticInfo(block, hdrInfo);
    }
};</code>
            </div>

            <h3>3.3 Extractor Integration</h3>
            <p>Extractor configuration for correctly parsing Dolby Vision content:</p>

            <div class="code-block">
<code class="language-cpp">// Configure MediaExtractor to recognize Dolby Vision format

// MIME type registration
static const char* kDolbyVisionMimeType = "video/dolby-vision";

// dvcC/dvvC box parsing
void parseDolbyVisionConfig(const uint8_t* data, size_t size,
                            DolbyVisionConfig* config) {
    // dvcC box structure
    // offset 0: dv_version_major (8 bits)
    // offset 1: dv_version_minor (8 bits)
    // offset 2-3: dv_profile (7 bits) + dv_level (6 bits) + ...

    config-&gt;profile = (data[2] &gt;&gt; 1) &amp; 0x7F;
    config-&gt;level = ((data[2] &amp; 0x01) &lt;&lt; 5) | ((data[3] &gt;&gt; 3) &amp; 0x1F);
    config-&gt;rpuPresentFlag = (data[3] &gt;&gt; 2) &amp; 0x01;
    config-&gt;elPresentFlag = (data[3] &gt;&gt; 1) &amp; 0x01;
    config-&gt;blPresentFlag = data[3] &amp; 0x01;
    config-&gt;blSignalCompatibilityId = (data[4] &gt;&gt; 4) &amp; 0x0F;
}

// Add Dolby Vision info to MediaFormat
void addDolbyVisionFormat(AMediaFormat* format,
                          const DolbyVisionConfig&amp; config) {
    AMediaFormat_setString(format, AMEDIAFORMAT_KEY_MIME, kDolbyVisionMimeType);
    AMediaFormat_setInt32(format, "dv-profile", config.profile);
    AMediaFormat_setInt32(format, "dv-level", config.level);
    AMediaFormat_setInt32(format, "dv-bl-compatibility-id",
                          config.blSignalCompatibilityId);
}</code>
            </div>
        </section>

        <!-- Section 4: Display HAL Integration -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">4</span>
                Display HAL Integration
            </h2>

            <h3>4.1 HWComposer Metadata Passing</h3>
            <p>Pass metadata from decoded Dolby Vision frames to the Display HAL:</p>

            <div class="code-block">
<code class="language-cpp">// HWC2 Implementation - Dolby Vision metadata handling

HWC2::Error HwcDisplay::setLayerBuffer(hwc2_layer_t layerId,
                                        buffer_handle_t buffer,
                                        int32_t acquireFence) {
    HwcLayer* layer = getLayer(layerId);

    // 1. Extract Dolby Vision metadata from GraphicBuffer
    DolbyVisionMetadata dvMetadata;
    if (extractDolbyVisionMetadata(buffer, &amp;dvMetadata)) {
        layer-&gt;setDolbyVisionMetadata(dvMetadata);

        // 2. Set display mode to Dolby Vision
        setDisplayHdrMode(HDR_MODE_DOLBY_VISION);

        // 3. Pass metadata to VPU
        mDolbyVpu-&gt;setMetadata(dvMetadata);
    }

    return HWC2::Error::None;
}

// Report HDR Capabilities
void HwcDisplay::getHdrCapabilities(uint32_t* outNumTypes,
                                    int32_t* outTypes,
                                    float* outMaxLuminance,
                                    float* outMaxAverageLuminance,
                                    float* outMinLuminance) {
    // Specify Dolby Vision support
    std::vector&lt;int32_t&gt; types = {
        HAL_HDR_DOLBY_VISION,
        HAL_HDR_HDR10,
        HAL_HDR_HLG,
    };

    *outNumTypes = types.size();
    std::copy(types.begin(), types.end(), outTypes);

    // Panel luminance characteristics
    *outMaxLuminance = mPanelMaxLuminance;        // e.g., 1000 nits
    *outMaxAverageLuminance = mPanelAvgLuminance; // e.g., 500 nits
    *outMinLuminance = mPanelMinLuminance;        // e.g., 0.01 nits
}</code>
            </div>

            <h3>4.2 Tone Mapping</h3>
            <p>The Dolby VPU performs tone mapping based on content dynamic metadata and display characteristics:</p>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph LR
                        subgraph Input ["Input Signal"]
                            Frame[YUV P010 Frame<br/>BT.2020 / PQ]
                            Meta[RPU Metadata<br/>Scene-by-scene]
                        end

                        subgraph VPU ["Dolby VPU"]
                            TM[Tone Mapping Engine]
                            CM[Color Mapping]
                        end

                        subgraph Output ["Output Signal"]
                            Panel[Display Panel<br/>Adapted to panel characteristics]
                        end

                        Frame --> TM
                        Meta --> TM
                        TM --> CM
                        CM --> Panel
                </div>
            </div>

            <div class="info-box">
                <div class="info-box-title">Key Tone Mapping Parameters</div>
                <p>
                    <strong>MaxCLL:</strong> Maximum Content Light Level (maximum brightness of content)<br>
                    <strong>MaxFALL:</strong> Maximum Frame-Average Light Level (maximum average brightness per frame)<br>
                    <strong>Panel Peak Luminance:</strong> Display maximum brightness (nits)<br>
                    <strong>Panel Min Luminance:</strong> Display minimum brightness (black level)
                </p>
            </div>

            <h3>4.3 Android 15 HDR Headroom Control</h3>
            <p><span class="tag tag-android15">Android 15</span> Support for the new <code>setDesiredHdrHeadroom</code> API:</p>

            <div class="code-block">
<code class="language-cpp">// SurfaceControl HDR Headroom handling

// Called from Framework
void SurfaceComposerClient::Transaction::setDesiredHdrHeadroom(
        const sp&lt;SurfaceControl&gt;&amp; sc, float desiredRatio) {
    // desiredRatio: HDR brightness ratio relative to SDR (e.g., 2.0 = HDR is 2x SDR)
    layer_state_t* s = getLayerState(sc);
    s-&gt;hdrHeadroom = desiredRatio;
}

// Handled in HWComposer
HWC2::Error HwcDisplay::setLayerHdrHeadroom(hwc2_layer_t layerId,
                                             float headroom) {
    HwcLayer* layer = getLayer(layerId);
    layer-&gt;setHdrHeadroom(headroom);

    // Pass headroom to Dolby VPU
    mDolbyVpu-&gt;setHdrHeadroom(headroom);

    return HWC2::Error::None;
}

// Adjust tone mapping in Dolby VPU
void DolbyVpu::setHdrHeadroom(float headroom) {
    // Adjust brightness balance in SDR/HDR mixed content
    // Lower headroom reduces peak brightness of HDR content
    mToneMappingParams.hdrHeadroom = headroom;
    updateToneMapping();
}</code>
            </div>
        </section>

        <!-- Section 5: Build Configuration -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">5</span>
                Build Configuration
            </h2>

            <h3>5.1 Android.bp (Codec2 Component)</h3>
            <div class="code-block">
<code class="language-json">cc_library_shared {
    name: "libcodec2_soft_dv_dec",
    vendor: true,

    srcs: [
        "C2DolbyVisionDec.cpp",
        "DolbyVisionRpuParser.cpp",
        "DolbyVisionMetadataHandler.cpp",
    ],

    shared_libs: [
        "libbase",
        "liblog",
        "libcodec2",
        "libcodec2_vndk",
        "libstagefright_foundation",
        "android.hardware.graphics.common-V4-ndk",
        // Dolby libraries
        "libdolbyvision",
        "libdolbyvision_rpu",
    ],

    static_libs: [
        "libcodec2_soft_common",
    ],

    cflags: [
        "-DDOLBY_VISION_ENABLED",
        "-Wall",
        "-Werror",
    ],
}

// C2 Component Store registration
cc_library_shared {
    name: "libcodec2_vendor_dv",
    vendor: true,

    srcs: [
        "C2VendorDvComponentStore.cpp",
    ],

    shared_libs: [
        "libcodec2_soft_dv_dec",
        "libcodec2_vndk",
    ],
}</code>
            </div>

            <h3>5.2 Display HAL Build</h3>
            <div class="code-block">
<code class="language-json">cc_binary {
    name: "android.hardware.composer.hwc3-service.dolby",
    relative_install_path: "hw",
    vendor: true,
    init_rc: ["hwc3-dolby.rc"],
    vintf_fragments: ["hwc3-dolby.xml"],

    srcs: [
        "HwcService.cpp",
        "HwcDisplay.cpp",
        "DolbyVpuWrapper.cpp",
    ],

    shared_libs: [
        "libbase",
        "libbinder_ndk",
        "libhardware",
        "libui",
        "libgralloctypes",
        "android.hardware.graphics.composer3-V2-ndk",
        // Dolby VPU library
        "libdolby_vpu",
    ],

    cflags: [
        "-DDOLBY_VISION_DISPLAY",
    ],
}</code>
            </div>

            <h3>5.3 Feature Flag Configuration</h3>
            <p>Add Dolby Vision feature flags in <span class="file-path">device.mk</span>:</p>

            <div class="code-block">
<code class="language-makefile"># Dolby Vision Support
PRODUCT_PROPERTY_OVERRIDES += \
    ro.vendor.dolby.vision.supported=true \
    ro.vendor.dolby.vision.profiles=5,8.1,8.4 \
    persist.vendor.dolby.vision.enabled=true

# HDR Capabilities
PRODUCT_PROPERTY_OVERRIDES += \
    ro.surface_flinger.has_HDR_display=true \
    ro.surface_flinger.has_wide_color_display=true \
    ro.surface_flinger.use_color_management=true

# Codec2 configuration
PRODUCT_PACKAGES += \
    libcodec2_vendor_dv \
    libcodec2_soft_dv_dec</code>
            </div>
        </section>

        <!-- Section 6: Testing & Verification -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">6</span>
                Testing & Verification
            </h2>

            <h3>6.1 Basic Verification Checklist</h3>
            <ul class="checklist">
                <li><strong>HDR Capabilities:</strong> <code>Display.getHdrCapabilities()</code> returns <code>HDR_TYPE_DOLBY_VISION</code></li>
                <li><strong>Decoder Registration:</strong> Query Dolby Vision decoder from <code>MediaCodecList</code></li>
                <li><strong>Visual Check:</strong> HDR mark displayed when playing Dolby Vision content</li>
                <li><strong>Brightness/Color:</strong> Confirm noticeable brightness and color difference compared to SDR content</li>
                <li><strong>Tone Mapping:</strong> Verify detail preservation in both dark and bright scenes</li>
            </ul>

            <h3>6.2 ADB Debugging Commands</h3>
            <div class="code-block">
<code class="language-bash"># 1. Check HDR Capabilities
adb shell dumpsys SurfaceFlinger | grep -i "HDR"

# 2. Display status check
adb shell dumpsys display | grep -i "hdr\|dolby"

# 3. MediaCodec supported formats check
adb shell dumpsys media.codec | grep -i "dolby-vision"

# 4. Currently playing video info
adb shell dumpsys media.player | grep -i "dolby\|hdr"

# 5. HWComposer layer info
adb shell dumpsys SurfaceFlinger --layers | grep -i "dataspace"

# 6. Dolby Vision related logs
adb logcat -s DolbyVision:V HWComposer:V SurfaceFlinger:V</code>
            </div>

            <h3>6.3 HDR Support Check with Java Code</h3>
            <div class="code-block">
<code class="language-java">// HDR support verification code
public boolean isDolbyVisionSupported(Context context) {
    Display display = context.getDisplay();
    Display.HdrCapabilities hdrCaps = display.getHdrCapabilities();

    if (hdrCaps != null) {
        int[] supportedTypes = hdrCaps.getSupportedHdrTypes();
        for (int type : supportedTypes) {
            if (type == Display.HdrCapabilities.HDR_TYPE_DOLBY_VISION) {
                Log.d(TAG, "Dolby Vision supported!");
                Log.d(TAG, "Max Luminance: " + hdrCaps.getDesiredMaxLuminance());
                Log.d(TAG, "Max Avg Luminance: " + hdrCaps.getDesiredMaxAverageLuminance());
                Log.d(TAG, "Min Luminance: " + hdrCaps.getDesiredMinLuminance());
                return true;
            }
        }
    }
    return false;
}

// Check for Dolby Vision decoder with MediaCodec
public boolean hasDolbyVisionDecoder() {
    MediaCodecList codecList = new MediaCodecList(MediaCodecList.ALL_CODECS);
    for (MediaCodecInfo codecInfo : codecList.getCodecInfos()) {
        if (!codecInfo.isEncoder()) {
            String[] types = codecInfo.getSupportedTypes();
            for (String type : types) {
                if (type.equals("video/dolby-vision")) {
                    Log.d(TAG, "Found DV decoder: " + codecInfo.getName());
                    return true;
                }
            }
        }
    }
    return false;
}</code>
            </div>

            <h3>6.4 Test Content</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Profile</th>
                        <th>Test Source</th>
                        <th>Verification Items</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Profile 5</td>
                        <td>Netflix Dolby Vision content</td>
                        <td>IPTPQc2 color space displays correctly</td>
                    </tr>
                    <tr>
                        <td>Profile 8.1</td>
                        <td>Dolby demo clip (HDR10 compatible)</td>
                        <td>Verify HDR10 fallback operation</td>
                    </tr>
                    <tr>
                        <td>Profile 8.4</td>
                        <td>HLG-based broadcast content</td>
                        <td>HLG tone curve applied correctly</td>
                    </tr>
                    <tr>
                        <td>Capture (8.4)</td>
                        <td>Camera2 API 10-bit recording</td>
                        <td>Verify Dolby Vision encoding</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 7: Troubleshooting -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">7</span>
                Troubleshooting
            </h2>

            <h3>7.1 Common Issues</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Symptom</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>HDR mark not displayed</td>
                        <td>HWC not reporting HDR Capabilities</td>
                        <td>Check <code>getHdrCapabilities()</code> implementation</td>
                    </tr>
                    <tr>
                        <td>Color abnormal (too bright)</td>
                        <td>Tone mapping not applied</td>
                        <td>Check VPU metadata passing path</td>
                    </tr>
                    <tr>
                        <td>Color abnormal (dull)</td>
                        <td>Incorrectly interpreted as BT.709</td>
                        <td>Check Dataspace settings (BT.2020)</td>
                    </tr>
                    <tr>
                        <td>Banding artifacts</td>
                        <td>Converted to 8-bit</td>
                        <td>Verify entire 10-bit pipeline</td>
                    </tr>
                    <tr>
                        <td>Decoding failure</td>
                        <td>RPU parsing error</td>
                        <td>Verify dvcC/dvvC box parsing logic</td>
                    </tr>
                    <tr>
                        <td>Frame drops</td>
                        <td>VPU processing delay</td>
                        <td>Optimize tone mapping performance</td>
                    </tr>
                </tbody>
            </table>

            <h3>7.2 Enable Debug Logs</h3>
            <div class="code-block">
<code class="language-bash"># Enable detailed Dolby Vision logs
adb shell setprop persist.vendor.dolby.vision.debug 1
adb shell setprop debug.sf.hdr.debug 1

# Restart SurfaceFlinger
adb shell stop surfaceflinger
adb shell start surfaceflinger

# Collect logs
adb logcat -v time | grep -E "DolbyVision|HDR|HWC|SurfaceFlinger" > dv_debug.log</code>
            </div>

            <div class="success-box">
                <div class="success-box-title">Example Logs for Normal Operation</div>
                <p>
                    <code>[SurfaceFlinger] Layer dataspace: 142671872 (STANDARD_BT2020 | TRANSFER_ST2084)</code><br>
                    <code>[HWComposer] Setting HDR mode: DOLBY_VISION</code><br>
                    <code>[DolbyVPU] Tone mapping with MaxCLL=1000, panel peak=800</code>
                </p>
            </div>
        </section>

        <!-- Section 8: References -->
        <section class="section">
            <h2 class="section-title">
                <span class="section-number">8</span>
                References
            </h2>

            <h3>8.1 Official Documentation</h3>
            <ul>
                <li><a href="https://source.android.com/docs/core/graphics/hdr" target="_blank">Android HDR Display Support</a></li>
                <li><a href="https://source.android.com/docs/core/graphics/color-mgmt" target="_blank">Android Color Management</a></li>
                <li><a href="https://developer.android.com/reference/android/view/Display.HdrCapabilities" target="_blank">Display.HdrCapabilities API</a></li>
                <li><a href="https://professional.dolby.com/" target="_blank">Dolby Professional Portal</a> (License required)</li>
            </ul>

            <h3>8.2 AOSP Source Paths</h3>
            <div class="code-block">
<code># Codec2 Interface
hardware/google/av/codec2/

# HWComposer HAL
hardware/interfaces/graphics/composer/

# SurfaceFlinger HDR Processing
frameworks/native/services/surfaceflinger/

# Media Extractor (dvcC parsing)
frameworks/av/media/extractors/

# Display HDR Capabilities
frameworks/base/core/java/android/view/Display.java</code>
            </div>
        </section>

        <a href="dolby-codecs.html" class="nav-button" style="margin-top: var(--spacing-2xl);">← Back to Dolby Codecs</a>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#00d4ff',
                primaryTextColor: '#e8eaed',
                primaryBorderColor: '#00d4ff',
                lineColor: '#5eead4',
                secondaryColor: '#1e293b',
                tertiaryColor: '#0f172a',
                background: '#0f172a',
                mainBkg: '#1e293b',
                secondBkg: '#0f172a',
                fontFamily: 'Archivo, sans-serif'
            }
        });
    </script>

    <script src="../scripts/mermaid-theme.js"></script>
    <script src="../scripts/copy-code.js"></script>
    <script src="../scripts/toc-generator.js"></script>
    <script src="../scripts/page-navigation.js"></script>
    <script src="../scripts/diagram-data.js"></script>
    <script src="../scripts/diagram-interactive.js"></script>
    <script src="../scripts/theme-toggle.js?v=2"></script>
    <script src="../scripts/lang-switch.js"></script>
</body>

</html>
