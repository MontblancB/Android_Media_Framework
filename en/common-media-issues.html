<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent Flash of Incorrect Theme (FOIT) -->
    <script>
    (function(){var t=localStorage.getItem('android-media-framework-theme');if(t)document.documentElement.setAttribute('data-theme',t);else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches)document.documentElement.setAttribute('data-theme','light');})();
    </script>
    <title>Common Media Issues</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;900&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/design-system.css">

        <style>
        /* Page-specific styles loaded from design-system.css */
    </style>
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-button">
            ‚Üê Android Media Framework
        </a>
    </nav>
    <div class="container">
        <header>
            <h1 class="page-title">Common Media Issues & Solutions</h1>
            <p class="page-subtitle">Android Media Framework Practical Troubleshooting Guide</p>
        </header>



        <!-- Section 1: Playback Issues -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">1</span>
                Playback Issues
            </h2>
            <p class="section-description">
                Common problems and solutions that occur during media playback.
            </p>

            <!-- Issue 1.1: Video Buffering -->
            <div id="issue-buffering" class="issue-card severity-high">
                <h3 class="issue-title">Issue 1.1: Video Keeps Buffering</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Loading indicator appears frequently during playback</li>
                        <li>BUFFERING_UPDATE events occur repeatedly</li>
                        <li>Frame drops occur</li>
                        <li>Degraded user experience</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Insufficient network bandwidth</strong>: Bitrate exceeds network speed</li>
                        <li><strong>Insufficient buffer size</strong>: DefaultLoadControl default values are too small</li>
                        <li><strong>Server response delay</strong>: CDN issues or server overload</li>
                        <li><strong>Insufficient decoder performance</strong>: Playing 4K video on low-spec device</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Increase ExoPlayer Buffer Size</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// Adjust buffer size (larger than default)
val loadControl = DefaultLoadControl.Builder()
    .setBufferDurationsMs(
        50000,  // minBufferMs (default 15000ms)
        120000, // maxBufferMs (default 50000ms)
        2500,   // bufferForPlaybackMs (default 1500ms)
        5000    // bufferForPlaybackAfterRebufferMs (default 5000ms)
    )
    .setPrioritizeTimeOverSizeThresholds(true)
    .build()

val player = ExoPlayer.Builder(context)
    .setLoadControl(loadControl)
    .build()

// Use Adaptive Bitrate Streaming (ABR)
val trackSelector = DefaultTrackSelector(context).apply {
    parameters = buildUponParameters()
        .setMaxVideoSizeSd() // Limit to SD if not on Wi-Fi
        .build()
}

val playerAdaptive = ExoPlayer.Builder(context)
    .setTrackSelector(trackSelector)
    .build()</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Monitor buffer status
adb logcat | grep -E "ExoPlayer|buffer"

# Check network speed
adb shell dumpsys netstats

# Check frame drops
adb shell dumpsys media.player | grep -i "frames dropped"</code></pre>
                </div>
            </div>

            <!-- Issue 1.2: A/V Sync Issue -->
            <div id="issue-av-sync" class="issue-card severity-critical">
                <h3 class="issue-title">Issue 1.2: Audio-Video Out of Sync (Lip Sync)</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Lip movements don't match audio</li>
                        <li>Audio is ahead of or behind video</li>
                        <li>Sync difference increases over longer playback</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Timestamp mismatch</strong>: PTS (Presentation Timestamp) processing error</li>
                        <li><strong>Audio latency</strong>: AudioTrack buffering delay</li>
                        <li><strong>Codec processing speed difference</strong>: Video decoding is slow</li>
                        <li><strong>Media file issue</strong>: Timestamp error during encoding</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">MediaCodec Timestamp Synchronization</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// Use correct PTS in MediaCodec
val bufferInfo = MediaCodec.BufferInfo()
val outputBufferId = videoCodec.dequeueOutputBuffer(bufferInfo, TIMEOUT_US)

if (outputBufferId >= 0) {
    // Calculate rendering timing based on PTS
    val presentationTimeUs = bufferInfo.presentationTimeUs

    // Render at exact timing
    videoCodec.releaseOutputBuffer(
        outputBufferId,
        true // render to surface
    )
}

// Tune A/V sync in ExoPlayer
class CustomRenderersFactory(context: Context) : DefaultRenderersFactory(context) {
    override fun buildVideoRenderers(/* ... */): ArrayList<Renderer> {
        val videoRenderer = MediaCodecVideoRenderer(
            context,
            mediaCodecSelector,
            allowedVideoJoiningTimeMs = 0, // Immediate join
            enableDecoderFallback = true
        )
        // ...
    }
}

// AudioTrack low-latency mode setup (API 26+)
val audioTrack = AudioTrack.Builder()
    .setAudioAttributes(audioAttributes)
    .setAudioFormat(audioFormat)
    .setPerformanceMode(AudioTrack.PERFORMANCE_MODE_LOW_LATENCY)
    .build()</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check timestamp difference
adb logcat | grep -E "presentationTimeUs|PTS"

# Measure audio latency
adb shell dumpsys media.audio_flinger | grep -i latency

# Acceptable sync tolerance is typically within +/-40ms</code></pre>
                </div>
            </div>

            <!-- Issue 1.3: Slow Seek -->
            <div id="issue-seek-slow" class="issue-card severity-medium">
                <h3 class="issue-title">Issue 1.3: Slow Seek Operation</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>More than 3 seconds to actually move after seekTo() call</li>
                        <li>Progress bar dragging feels unnatural</li>
                        <li>User complaints about inconvenience</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Wide keyframe interval</strong>: Only 1 I-frame every 10 seconds</li>
                        <li><strong>Media container not optimized</strong>: moov atom at end of file (MP4)</li>
                        <li><strong>Network streaming</strong>: Re-download required when seeking remote files</li>
                        <li><strong>Missing index table</strong>: MediaExtractor does sequential search</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Enable Fast Seek and File Optimization</span>
                            <span class="code-lang">Bash</span>
                        </div>
                        <pre><code># Optimize MP4 file (move moov atom to front)
ffmpeg -i input.mp4 -c copy -movflags +faststart output.mp4

# Adjust keyframe interval (during encoding)
ffmpeg -i input.mp4 -c:v libx264 -g 30 -keyint_min 30 output.mp4
# -g 30: GOP(Group of Pictures) size = 30 (1 I-frame per second at 30fps)</code></pre>
                    </div>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">ExoPlayer Seek Optimization</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// Exact Seek (slow) vs Fast Seek in ExoPlayer
player.setSeekParameters(SeekParameters.CLOSEST_SYNC) // Nearest keyframe (fast)
// or
player.setSeekParameters(SeekParameters.EXACT) // Exact position (slow)

// Preview Seek (Scrubbing)
player.setPlayWhenReady(false) // In paused state
player.seekTo(targetPositionMs)
// After drag complete
player.setPlayWhenReady(true)</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check keyframe interval
ffprobe -select_streams v:0 -show_frames -show_entries frame=pict_type input.mp4 | grep -E "pict_type=I"

# Measure seek time
adb logcat | grep -E "seekTo|onSeekComplete"</code></pre>
                </div>
            </div>

            <!-- Issue 1.4: Slow Playback Start -->
            <div id="issue-cold-start" class="issue-card severity-medium">
                <h3 class="issue-title">Issue 1.4: Slow Playback Start (Cold Start)</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>More than 3 seconds from play() call to first frame</li>
                        <li>Loading screen displayed for long time</li>
                        <li>Increased user drop-off rate</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Initial buffering</strong>: Waits for bufferForPlaybackMs</li>
                        <li><strong>Codec initialization delay</strong>: MediaCodec.configure() takes time</li>
                        <li><strong>DRM license acquisition</strong>: Widevine license server communication</li>
                        <li><strong>Network delay</strong>: DNS lookup, TCP handshake</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Fast Start Optimization</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// Minimize initial buffering time
val loadControl = DefaultLoadControl.Builder()
    .setBufferDurationsMs(
        15000,  // minBufferMs
        50000,  // maxBufferMs
        1000,   // bufferForPlaybackMs (default 1500ms -> reduced to 1000ms)
        2500    // bufferForPlaybackAfterRebufferMs
    )
    .build()

// DRM license prefetch
val drmSessionManager = DefaultDrmSessionManager.Builder()
    .setUuidAndExoMediaDrmProvider(C.WIDEVINE_UUID, FrameworkMediaDrm.DEFAULT_PROVIDER)
    .build(drmCallback)

// Call prepare in advance (in background)
lifecycleScope.launch(Dispatchers.IO) {
    player.prepare() // Prepare before UI display
}

// DNS prefetch (OkHttp)
val client = OkHttpClient.Builder()
    .dns(object : Dns {
        override fun lookup(hostname: String): List<InetAddress> {
            // Use cached DNS
            return Dns.SYSTEM.lookup(hostname)
        }
    })
    .build()</code></pre>
                </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Measure Time to First Frame (TTFF)
adb logcat | grep -E "playWhenReady|onRenderedFirstFrame"

# Measure time for each stage
# 1. prepare() -> onPrepared
# 2. play() -> onRenderedFirstFrame
# 3. Total TTFF = onRenderedFirstFrame time - play() time</code></pre>
                </div>
            </div>
        </section>

        <!-- Section 2: Codec Issues -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">2</span>
                Encoding/Decoding Issues (Codec Issues)
            </h2>
            <p class="section-description">
                Common problems and solutions related to MediaCodec.
            </p>

            <!-- Issue 2.1: Codec Configuration Failure -->
            <div id="issue-codec-configure" class="issue-card severity-critical">
                <h3 class="issue-title">Issue 2.1: MediaCodec.configure() Failure</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li><code>IllegalStateException</code> occurs</li>
                        <li><code>CodecException</code> occurs</li>
                        <li>"codec not found" error message</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Unsupported resolution</strong>: Requesting 4K from a 720p-only codec</li>
                        <li><strong>Wrong color format</strong>: YUV420Planar vs Semi-Planar mismatch</li>
                        <li><strong>Bitrate out of range</strong>: Outside codec capabilities range</li>
                        <li><strong>Missing MediaFormat parameters</strong>: width, height, mime type not set</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Check Capabilities and Safe Configuration</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. Check codec capabilities
fun checkCodecSupport(mimeType: String, width: Int, height: Int): Boolean {
    val codecList = MediaCodecList(MediaCodecList.REGULAR_CODECS)
    val codecInfo = codecList.findDecoderForFormat(
        MediaFormat.createVideoFormat(mimeType, width, height)
    ) ?: return false

    val caps = codecInfo.getCapabilitiesForType(mimeType)
    val videoCaps = caps.videoCapabilities

    return videoCaps.isSizeSupported(width, height)
}

// 2. Safe MediaCodec initialization
try {
    val codec = MediaCodec.createDecoderByType("video/avc")

    val format = MediaFormat.createVideoFormat("video/avc", 1920, 1080).apply {
        setInteger(MediaFormat.KEY_COLOR_FORMAT,
            MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible)
        setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, 1024 * 1024) // 1MB
        setInteger(MediaFormat.KEY_FRAME_RATE, 30)
    }

    codec.configure(format, surface, null, 0)
    codec.start()

} catch (e: IllegalStateException) {
    Log.e(TAG, "Codec configuration failed", e)
    // Fallback to software codec
    val softwareCodec = MediaCodec.createByCodecName("OMX.google.h264.decoder")
}

// 3. Find supported color format
fun getSupportedColorFormat(codecInfo: MediaCodecInfo, mimeType: String): Int {
    val caps = codecInfo.getCapabilitiesForType(mimeType)
    for (colorFormat in caps.colorFormats) {
        when (colorFormat) {
            MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible,
            MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Planar,
            MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420SemiPlanar -> {
                return colorFormat
            }
        }
    }
    return -1
}</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check available codec list
adb shell dumpsys media.codec

# Check if specific MIME type is supported
adb shell "dumpsys media.codec | grep -A 20 'video/avc'"

# Check supported resolution range
adb shell "dumpsys media.codec | grep -E 'size|resolution'"</code></pre>
                </div>
            </div>

            <!-- Issue 2.2: dequeueOutputBuffer Timeout -->
            <div id="issue-dequeue-timeout" class="issue-card severity-high">
                <h3 class="issue-title">Issue 2.2: dequeueOutputBuffer() Keeps Timing Out</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li><code>dequeueOutputBuffer()</code> returns -1 (INFO_TRY_AGAIN_LATER)</li>
                        <li>Cannot receive output buffer</li>
                        <li>Screen freezes</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>No input data</strong>: queueInputBuffer not called</li>
                        <li><strong>Missing EOS signal</strong>: BUFFER_FLAG_END_OF_STREAM not set on last frame</li>
                        <li><strong>Codec internal error</strong>: Decoder crash due to invalid data</li>
                        <li><strong>Output buffer not released</strong>: Buffer exhaustion due to missing releaseOutputBuffer calls</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Correct MediaCodec Flow</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>val codec = MediaCodec.createDecoderByType("video/avc")
codec.configure(format, surface, null, 0)
codec.start()

var inputDone = false
var outputDone = false

while (!outputDone) {
    // 1. Process input buffer
    if (!inputDone) {
        val inputBufferId = codec.dequeueInputBuffer(TIMEOUT_US)
        if (inputBufferId >= 0) {
            val inputBuffer = codec.getInputBuffer(inputBufferId)!!

            val sampleSize = extractor.readSampleData(inputBuffer, 0)
            if (sampleSize < 0) {
                // EOS signal
                codec.queueInputBuffer(inputBufferId, 0, 0, 0,
                    MediaCodec.BUFFER_FLAG_END_OF_STREAM)
                inputDone = true
            } else {
                val presentationTimeUs = extractor.sampleTime
                codec.queueInputBuffer(inputBufferId, 0, sampleSize,
                    presentationTimeUs, 0)
                extractor.advance()
            }
        }
    }

    // 2. Process output buffer
    val bufferInfo = MediaCodec.BufferInfo()
    val outputBufferId = codec.dequeueOutputBuffer(bufferInfo, TIMEOUT_US)

    when (outputBufferId) {
        MediaCodec.INFO_TRY_AGAIN_LATER -> {
            // Timeout: retry in next loop
        }
        MediaCodec.INFO_OUTPUT_FORMAT_CHANGED -> {
            val newFormat = codec.outputFormat
            Log.d(TAG, "Output format changed: $newFormat")
        }
        else -> {
            if (outputBufferId >= 0) {
                // Render frame
                codec.releaseOutputBuffer(outputBufferId, true)

                // Check EOS
                if ((bufferInfo.flags and MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0) {
                    outputDone = true
                }
            }
        }
    }
}

codec.stop()
codec.release()</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check MediaCodec status
adb logcat | grep -E "MediaCodec|dequeue|queueInput"

# Monitor buffer status
adb shell dumpsys media.player | grep -i "buffer"</code></pre>
                </div>
            </div>

            <!-- Issue 2.3: Unsupported Resolution/Framerate -->
            <div id="issue-resolution-unsupported" class="issue-card severity-medium">
                <h3 class="issue-title">Issue 2.3: Specific Resolution/Framerate Not Playing</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>4K video doesn't play</li>
                        <li>60fps video plays at 30fps</li>
                        <li>"Unsupported resolution" error</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Codec capabilities limitation</strong>: Max resolution limited in media_codecs.xml</li>
                        <li><strong>Insufficient hardware performance</strong>: GPU cannot decode 4K</li>
                        <li><strong>Insufficient memory</strong>: 4K frame buffer allocation failure</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Adaptive Resolution/Framerate</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. Adaptive playback after checking device capabilities
fun getMaxSupportedResolution(mimeType: String): Size {
    val codecList = MediaCodecList(MediaCodecList.REGULAR_CODECS)
    for (codecInfo in codecList.codecInfos) {
        if (codecInfo.isEncoder) continue

        try {
            val caps = codecInfo.getCapabilitiesForType(mimeType)
            val videoCaps = caps.videoCapabilities

            val maxWidth = videoCaps.supportedWidths.upper
            val maxHeight = videoCaps.supportedHeights.upper

            return Size(maxWidth, maxHeight)
        } catch (e: Exception) {
            continue
        }
    }
    return Size(1920, 1080) // Fallback
}

// 2. ExoPlayer ABR (Adaptive Bitrate) settings
val trackSelector = DefaultTrackSelector(context).apply {
    parameters = buildUponParameters()
        .setMaxVideoSize(1920, 1080) // Max 1080p
        .setMaxVideoFrameRate(30) // Max 30fps
        .setForceHighestSupportedBitrate(false) // Adjust based on network
        .build()
}

// 3. Fallback to software codec
fun createCodecWithFallback(mimeType: String): MediaCodec {
    return try {
        // Hardware codec first
        MediaCodec.createDecoderByType(mimeType)
    } catch (e: Exception) {
        // Fallback to software codec
        MediaCodec.createByCodecName("OMX.google.h264.decoder")
    }
}</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check supported resolution
adb shell dumpsys media.codec | grep -E "size.*max"

# Check actual playback resolution
adb logcat | grep -E "VideoSize|resolution"</code></pre>
                </div>
            </div>
        </section>

        <!-- Section 3: DRM Issues -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">3</span>
                DRM Issues
            </h2>
            <p class="section-description">
                Common problems and solutions related to Widevine DRM.
            </p>

            <!-- Issue 3.1: License Acquisition Failure -->
            <div id="issue-drm-license" class="issue-card severity-critical">
                <h3 class="issue-title">Issue 3.1: Widevine License Acquisition Failure</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li><code>ERROR_DRM_NO_LICENSE</code> occurs</li>
                        <li>DRM protected content won't play</li>
                        <li>"License server error" message</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Not provisioned</strong>: Widevine CDM initialization failed</li>
                        <li><strong>License server communication failure</strong>: Network error, authentication failure</li>
                        <li><strong>Wrong License URL</strong>: Server address typo</li>
                        <li><strong>HDCP not supported</strong>: L1 required but device only supports L3</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Widevine DRM Debugging</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. Check Widevine Security Level
fun getWidevineSecurityLevel(context: Context): String {
    return try {
        val mediaDrm = MediaDrm(C.WIDEVINE_UUID)
        val level = mediaDrm.getPropertyString(MediaDrm.PROPERTY_SECURITY_LEVEL)
        mediaDrm.release()
        level // "L1" or "L3"
    } catch (e: Exception) {
        "Unknown"
    }
}

// 2. Detailed logging for license requests
class MyDrmCallback(private val licenseUrl: String) : MediaDrmCallback {
    override fun executeProvisionRequest(
        uuid: UUID,
        request: ProvisionRequest
    ): ByteArray {
        Log.d(TAG, "Provisioning request: ${request.defaultUrl}")
        // Request to provisioning server
        return executePost(request.defaultUrl, request.data, null)
    }

    override fun executeKeyRequest(
        uuid: UUID,
        request: KeyRequest
    ): ByteArray {
        Log.d(TAG, "License request URL: $licenseUrl")
        Log.d(TAG, "Request data size: ${request.data.size}")

        try {
            val response = executePost(licenseUrl, request.data, null)
            Log.d(TAG, "License response size: ${response.size}")
            return response
        } catch (e: Exception) {
            Log.e(TAG, "License request failed", e)
            throw e
        }
    }

    private fun executePost(url: String, data: ByteArray, params: Map<String, String>?): ByteArray {
        val connection = URL(url).openConnection() as HttpURLConnection
        try {
            connection.requestMethod = "POST"
            connection.doOutput = true
            connection.setRequestProperty("Content-Type", "application/octet-stream")

            params?.forEach { (key, value) ->
                connection.setRequestProperty(key, value)
            }

            connection.outputStream.use { it.write(data) }

            val responseCode = connection.responseCode
            if (responseCode != 200) {
                throw IOException("HTTP $responseCode: ${connection.responseMessage}")
            }

            return connection.inputStream.readBytes()
        } finally {
            connection.disconnect()
        }
    }
}

// 3. Correct DrmSessionManager setup
val drmCallback = MyDrmCallback(LICENSE_URL)
val drmSessionManager = DefaultDrmSessionManager.Builder()
    .setUuidAndExoMediaDrmProvider(C.WIDEVINE_UUID, FrameworkMediaDrm.DEFAULT_PROVIDER)
    .setMultiSession(false)
    .build(drmCallback)

val player = ExoPlayer.Builder(context)
    .setDrmSessionManager(drmSessionManager)
    .build()</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check Widevine Security Level
adb shell getprop ro.vendor.drm.security_level

# Check DRM logs
adb logcat | grep -E "Widevine|MediaDrm|DRM"

# Check provisioning status
adb shell pm list packages | grep drm</code></pre>
                </div>
            </div>

            <!-- Issue 3.2: HDCP Issue -->
            <div id="issue-hdcp" class="issue-card severity-high">
                <h3 class="issue-title">Issue 3.2: HDCP Connection Failure (External Display)</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>DRM content won't play on TV connected via HDMI</li>
                        <li>"HDCP not supported" error</li>
                        <li>Black screen during mirroring</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>HDCP version mismatch</strong>: TV doesn't support HDCP 2.2</li>
                        <li><strong>Cable issue</strong>: Low-cost cable without HDCP support</li>
                        <li><strong>Widevine L1 required</strong>: L1 is mandatory for external displays</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Check HDCP Status</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// Check HDCP support with DisplayManager
val displayManager = getSystemService(Context.DISPLAY_SERVICE) as DisplayManager
val displays = displayManager.displays

for (display in displays) {
    val hdrCapabilities = display.hdrCapabilities
    Log.d(TAG, "Display ${display.displayId}: HDR types = ${hdrCapabilities?.supportedHdrTypes?.joinToString()}")

    // Check HDCP level (API 28+)
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
        val isWideColorGamut = display.isWideColorGamut
        Log.d(TAG, "Wide color gamut: $isWideColorGamut")
    }
}

// Check L1 requirement when external display detected
fun checkHdcpForExternalDisplay(): Boolean {
    val widevineLevel = getWidevineSecurityLevel(this)
    if (widevineLevel != "L1") {
        showError("External display requires Widevine L1 (current: $widevineLevel)")
        return false
    }
    return true
}</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check HDCP status
adb shell dumpsys display | grep -i hdcp

# Widevine Security Level
adb shell getprop | grep drm</code></pre>
                </div>
            </div>
        </section>

        <!-- Section 4: Audio Issues -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">4</span>
                Audio Issues
            </h2>
            <p class="section-description">
                Common issues related to audio playback and focus.
            </p>

            <!-- Issue 4.1: Audio Focus Issue -->
            <div id="issue-audio-focus" class="issue-card severity-high">
                <h3 class="issue-title">Issue 4.1: Cannot Obtain Audio Focus</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>No sound when play button is pressed</li>
                        <li>Audio overlaps with other apps playing</li>
                        <li>Music doesn't stop when phone call comes in</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Audio Focus not requested</strong>: requestAudioFocus() not called</li>
                        <li><strong>Wrong Focus Type</strong>: AUDIOFOCUS_GAIN vs AUDIOFOCUS_GAIN_TRANSIENT</li>
                        <li><strong>Focus Change Listener not implemented</strong>: No handling when other app takes focus</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Correct Audio Focus Usage</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>val audioManager = getSystemService(Context.AUDIO_SERVICE) as AudioManager

// Define AudioAttributes
val audioAttributes = AudioAttributes.Builder()
    .setUsage(AudioAttributes.USAGE_MEDIA)
    .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
    .build()

// Create AudioFocusRequest (API 26+)
val focusRequest = AudioFocusRequest.Builder(AudioManager.AUDIOFOCUS_GAIN)
    .setAudioAttributes(audioAttributes)
    .setAcceptsDelayedFocusGain(true) // Allow getting focus later
    .setOnAudioFocusChangeListener { focusChange ->
        when (focusChange) {
            AudioManager.AUDIOFOCUS_GAIN -> {
                // Focus gained: resume playback
                player.setVolume(1.0f)
                if (playbackDelayed || resumeOnFocusGain) {
                    player.play()
                }
            }
            AudioManager.AUDIOFOCUS_LOSS -> {
                // Focus completely lost: stop playback
                playbackDelayed = false
                player.pause()
            }
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -> {
                // Temporarily lost (phone call): pause
                playbackDelayed = false
                player.pause()
                resumeOnFocusGain = true
            }
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK -> {
                // Temporarily lost (notification): lower volume (Ducking)
                player.setVolume(0.2f)
            }
        }
    }
    .build()

// Request focus
val result = audioManager.requestAudioFocus(focusRequest)
when (result) {
    AudioManager.AUDIOFOCUS_REQUEST_GRANTED -> {
        // Focus obtained: start playback
        player.play()
    }
    AudioManager.AUDIOFOCUS_REQUEST_FAILED -> {
        // Failed to get focus
        Log.e(TAG, "Audio focus request failed")
    }
    AudioManager.AUDIOFOCUS_REQUEST_DELAYED -> {
        // Will get later
        playbackDelayed = true
    }
}

// Return focus when playback ends
audioManager.abandonAudioFocusRequest(focusRequest)</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check Audio Focus status
adb shell dumpsys audio | grep -A 10 "Audio Focus"

# Current focus owner
adb shell dumpsys media.audio_flinger | grep -i focus</code></pre>
                </div>
            </div>

            <!-- Issue 4.2: Audio Routing Issue (Automotive) -->
            <div id="issue-audio-routing" class="issue-card severity-critical">
                <h3 class="issue-title">Issue 4.2: Audio Output to Wrong Speaker in Vehicle</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Media sound comes from phone speaker</li>
                        <li>Navigation voice heard from rear seat</li>
                        <li>Zone settings not applied</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Wrong AudioAttributes Usage</strong>: USAGE_MEDIA vs USAGE_VOICE_COMMUNICATION</li>
                        <li><strong>Car Audio Zone not configured</strong>: CarAudioManager not used</li>
                        <li><strong>audio_policy_configuration.xml error</strong>: Routing rules misconfigured</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Car Audio Routing (AAOS)</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// Use CarAudioManager (AAOS)
val car = Car.createCar(this)
val carAudioManager = car.getCarManager(Car.AUDIO_SERVICE) as CarAudioManager

// Play media in Primary Zone (driver seat)
val primaryZone = CarAudioManager.PRIMARY_AUDIO_ZONE
val audioAttributes = AudioAttributes.Builder()
    .setUsage(AudioAttributes.USAGE_MEDIA) // Media usage
    .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
    .build()

val player = ExoPlayer.Builder(this).build()
player.setAudioAttributes(audioAttributes, true)

// Volume control per zone
val maxVolume = carAudioManager.getGroupMaxVolume(primaryZone, groupId)
val currentVolume = carAudioManager.getGroupVolume(primaryZone, groupId)
carAudioManager.setGroupVolume(primaryZone, groupId, newVolume, flags)

// Navigation TTS uses different Usage
val navAudioAttributes = AudioAttributes.Builder()
    .setUsage(AudioAttributes.USAGE_ASSISTANCE_NAVIGATION_GUIDANCE)
    .setContentType(AudioAttributes.CONTENT_TYPE_SPEECH)
    .build()</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check Car Audio Zones
adb shell dumpsys car_service --services CarAudioService

# Check audio routing
adb shell dumpsys media.audio_flinger | grep -E "stream|device"

# Check audio_policy
adb shell cat /vendor/etc/audio_policy_configuration.xml</code></pre>
                </div>
            </div>

            <!-- Issue 4.3: High Audio Latency -->
            <div id="issue-audio-latency" class="issue-card severity-medium">
                <h3 class="issue-title">Issue 4.3: Audio Latency Too High (>100ms)</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Touch sounds are delayed</li>
                        <li>Game audio response is slow</li>
                        <li>Delay in real-time music apps</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Large buffer size</strong>: AudioTrack buffer is too large</li>
                        <li><strong>Software mixer</strong>: Hardware mixer not used</li>
                        <li><strong>Resampling</strong>: 48kHz to 44.1kHz conversion overhead</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Low Latency Audio Settings</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. Use minimum buffer size
val minBufferSize = AudioTrack.getMinBufferSize(
    44100,
    AudioFormat.CHANNEL_OUT_STEREO,
    AudioFormat.ENCODING_PCM_16BIT
)

// 2. AudioAttributes for game/real-time usage
val audioAttributes = AudioAttributes.Builder()
    .setUsage(AudioAttributes.USAGE_GAME) // Game/real-time usage
    .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
    .build()

// 3. Set Performance Mode
val audioFormat = AudioFormat.Builder()
    .setSampleRate(44100) // Use native sample rate
    .setChannelMask(AudioFormat.CHANNEL_OUT_STEREO)
    .setEncoding(AudioFormat.ENCODING_PCM_16BIT)
    .build()

val audioTrack = AudioTrack.Builder()
    .setAudioAttributes(audioAttributes)
    .setAudioFormat(audioFormat)
    .setBufferSizeInBytes(minBufferSize)
    .setTransferMode(AudioTrack.MODE_STREAM)
    .setPerformanceMode(AudioTrack.PERFORMANCE_MODE_LOW_LATENCY) // Low latency mode
    .build()

// 4. Check native sample rate
val audioManager = getSystemService(Context.AUDIO_SERVICE) as AudioManager
val nativeSampleRate = audioManager.getProperty(AudioManager.PROPERTY_OUTPUT_SAMPLE_RATE)
val nativeBufferSize = audioManager.getProperty(AudioManager.PROPERTY_OUTPUT_FRAMES_PER_BUFFER)
Log.d(TAG, "Native: $nativeSampleRate Hz, buffer: $nativeBufferSize frames")</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Measure audio latency
adb shell dumpsys media.audio_flinger | grep -i latency

# Check native sample rate
adb shell getprop | grep audio.sample

# Check buffer size
adb logcat | grep -E "AudioTrack|buffer"</code></pre>
                </div>
            </div>
        </section>

        <!-- Section 5: Automotive Specific Issues -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">5</span>
                Automotive-Specific Issues
            </h2>
            <p class="section-description">
                Issues specific to Android Automotive OS (AAOS).
            </p>

            <!-- Issue 5.1: UX Restrictions Violation -->
            <div id="issue-ux-restrictions" class="issue-card severity-critical">
                <h3 class="issue-title">Issue 5.1: Video Playing While Driving (UX Restrictions Violation)</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Video continues to play while driving</li>
                        <li>Potential regulatory violation</li>
                        <li>Safety concern</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>CarUxRestrictionsManager not used</strong>: Driving state not monitored</li>
                        <li><strong>Distraction Optimization not applied</strong>: No video blocking logic</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Handle CarUxRestrictions</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>val car = Car.createCar(this)
val carUxRestrictionsManager = car.getCarManager(Car.CAR_UX_RESTRICTION_SERVICE)
    as CarUxRestrictionsManager

// Register restrictions change listener
carUxRestrictionsManager.registerListener { restrictions ->
    if (restrictions.isRequiresDistractionOptimization) {
        // Driving: block video, audio only
        Log.w(TAG, "Driving detected - switching to audio only")

        // Hide video
        playerView.visibility = View.GONE

        // Disable video track (audio only playback)
        val trackSelector = player.trackSelector as DefaultTrackSelector
        trackSelector.parameters = trackSelector.buildUponParameters()
            .setMaxVideoSize(0, 0) // Disable video
            .build()

        // UI restrictions (disable buttons, etc.)
        disableComplexUI()

    } else {
        // Parked: allow video playback
        Log.i(TAG, "Parked - enabling video playback")

        playerView.visibility = View.VISIBLE

        val trackSelector = player.trackSelector as DefaultTrackSelector
        trackSelector.parameters = trackSelector.buildUponParameters()
            .clearVideoSizeConstraints()
            .build()

        enableFullUI()
    }
}

fun disableComplexUI() {
    // Disable text input
    searchEditText.isEnabled = false

    // Limit list items (max 6)
    adapter.maxItems = 6

    // Stop complex animations
    complexAnimation.cancel()
}

// Unregister listener when app exits
override fun onDestroy() {
    super.onDestroy()
    carUxRestrictionsManager.unregisterListener()
    car.disconnect()
}</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check vehicle speed (VHAL simulator)
adb shell dumpsys car_service --services VehicleHal | grep SPEED

# UX Restrictions status
adb shell dumpsys car_service --services CarUxRestrictionService

# Simulate driving mode
adb shell cmd car_service inject-vhal-event 0x11600207 1 -i 30 # 30 km/h</code></pre>
                </div>
            </div>

            <!-- Issue 5.2: CarMediaService Integration Issue -->
            <div id="issue-car-media" class="issue-card severity-high">
                <h3 class="issue-title">Issue 5.2: App Not Showing in Vehicle Media Control</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Media app not displayed in instrument cluster/HUD</li>
                        <li>Cannot control with steering wheel buttons</li>
                        <li>Not registered in Last Media Source</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>MediaBrowserService not implemented</strong>: Required for Car Media integration</li>
                        <li><strong>MediaSession not configured</strong>: External control not possible</li>
                        <li><strong>AndroidManifest settings missing</strong>: No media-browse intent filter</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Implement MediaBrowserService (AAOS)</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. AndroidManifest.xml
/*
<service android:name=".MusicService"
         android:exported="true">
    <intent-filter>
        <action android:name="android.media.browse.MediaBrowserService" />
    </intent-filter>
</service>
*/

// 2. MediaBrowserServiceCompat implementation
class MusicService : MediaBrowserServiceCompat() {

    private lateinit var mediaSession: MediaSessionCompat

    override fun onCreate() {
        super.onCreate()

        // Create MediaSession
        mediaSession = MediaSessionCompat(this, TAG).apply {
            setFlags(
                MediaSessionCompat.FLAG_HANDLES_MEDIA_BUTTONS or
                MediaSessionCompat.FLAG_HANDLES_TRANSPORT_CONTROLS
            )
            setCallback(MediaSessionCallback())
            isActive = true
        }

        sessionToken = mediaSession.sessionToken
    }

    override fun onGetRoot(
        clientPackageName: String,
        clientUid: Int,
        rootHints: Bundle?
    ): BrowserRoot? {
        // Allow connection from Car Media Service
        return BrowserRoot("root", null)
    }

    override fun onLoadChildren(
        parentId: String,
        result: Result<List<MediaBrowserCompat.MediaItem>>
    ) {
        // Provide media library
        val mediaItems = listOf(
            MediaBrowserCompat.MediaItem(
                MediaDescriptionCompat.Builder()
                    .setMediaId("song1")
                    .setTitle("Song Title")
                    .setSubtitle("Artist Name")
                    .setIconUri(Uri.parse("https://..."))
                    .build(),
                MediaBrowserCompat.MediaItem.FLAG_PLAYABLE
            )
        )
        result.sendResult(mediaItems)
    }

    inner class MediaSessionCallback : MediaSessionCompat.Callback() {
        override fun onPlay() {
            // Start playback
            player.play()
            updatePlaybackState(PlaybackStateCompat.STATE_PLAYING)
        }

        override fun onPause() {
            player.pause()
            updatePlaybackState(PlaybackStateCompat.STATE_PAUSED)
        }

        override fun onSkipToNext() {
            player.seekToNext()
        }

        override fun onSkipToPrevious() {
            player.seekToPrevious()
        }
    }

    private fun updatePlaybackState(state: Int) {
        val playbackState = PlaybackStateCompat.Builder()
            .setState(state, player.currentPosition, 1.0f)
            .setActions(
                PlaybackStateCompat.ACTION_PLAY or
                PlaybackStateCompat.ACTION_PAUSE or
                PlaybackStateCompat.ACTION_SKIP_TO_NEXT or
                PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS
            )
            .build()
        mediaSession.setPlaybackState(playbackState)
    }
}</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check MediaBrowserService registration
adb shell dumpsys media_session | grep -A 10 "MediaBrowser"

# Check Last Media Source
adb shell dumpsys car_service --services CarMediaService

# MediaSession status
adb shell dumpsys media_session</code></pre>
                </div>
            </div>
        </section>

        <!-- Section 6: Performance Issues -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">6</span>
                Performance Issues
            </h2>
            <p class="section-description">
                Issues and optimization methods related to media playback performance.
            </p>

            <!-- Issue 6.1: Frame Drop -->
            <div id="issue-frame-drop" class="issue-card severity-high">
                <h3 class="issue-title">Issue 6.1: Video Frame Drops</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li>Playback stutters or is choppy</li>
                        <li>Frame skips occur</li>
                        <li>Non-smooth playback</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>CPU/GPU overload</strong>: Other apps consuming resources</li>
                        <li><strong>Main thread blocking</strong>: Heavy work on UI thread</li>
                        <li><strong>Insufficient decoder performance</strong>: Playing 4K video with software decoder</li>
                        <li><strong>Buffer shortage</strong>: Consumption faster than network speed</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Frame Drop Optimization</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. Prefer hardware decoder
val renderersFactory = object : DefaultRenderersFactory(context) {
    override fun buildVideoRenderers(/* ... */): ArrayList<Renderer> {
        val renderers = ArrayList<Renderer>()
        renderers.add(
            MediaCodecVideoRenderer(
                context,
                MediaCodecSelector.DEFAULT,
                allowedVideoJoiningTimeMs = 5000,
                enableDecoderFallback = false, // Disable software fallback
                handler,
                videoRendererEventListener,
                MAX_DROPPED_VIDEO_FRAME_COUNT_TO_NOTIFY
            )
        )
        return renderers
    }
}

// 2. Process heavy work in background thread
lifecycleScope.launch(Dispatchers.IO) {
    // Thumbnail loading, etc.
}

// 3. Monitor frame drops
player.addAnalyticsListener(object : AnalyticsListener {
    override fun onDroppedVideoFrames(
        eventTime: AnalyticsListener.EventTime,
        droppedFrames: Int,
        elapsedMs: Long
    ) {
        Log.w(TAG, "Dropped $droppedFrames frames in ${elapsedMs}ms")

        if (droppedFrames > 30) {
            // Severe drops: lower resolution
            val trackSelector = player.trackSelector as DefaultTrackSelector
            trackSelector.parameters = trackSelector.buildUponParameters()
                .setMaxVideoSizeSd()
                .build()
        }
    }
})

// 4. Surface optimization
val surfaceView = findViewById<SurfaceView>(R.id.surface)
surfaceView.holder.setFormat(PixelFormat.RGBA_8888)

// 5. CPU Governor settings (root required)
// adb shell "echo performance > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor"</code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check frame drops
adb shell dumpsys media.player | grep -i "frames dropped"

# CPU usage
adb shell top -n 1 | grep <package-name>

# GPU rendering profiling
adb shell setprop debug.hwui.profile visual_bars</code></pre>
                </div>
            </div>

            <!-- Issue 6.2: Out of Memory -->
            <div id="issue-oom" class="issue-card severity-critical">
                <h3 class="issue-title">Issue 6.2: OutOfMemoryError</h3>

                <div class="issue-section">
                    <span class="issue-label">Symptoms</span>
                    <ul>
                        <li><code>java.lang.OutOfMemoryError</code> crash</li>
                        <li>App terminates suddenly</li>
                        <li>Memory shortage after long playback</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Root Cause</span>
                    <ul>
                        <li><strong>Memory leak</strong>: MediaCodec, Surface not released</li>
                        <li><strong>Bitmap caching</strong>: Excessive memory usage from thumbnail images</li>
                        <li><strong>Large buffer allocation</strong>: 4K frame buffer too large</li>
                    </ul>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Solution</span>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-title">Memory Management</span>
                            <span class="code-lang">Kotlin</span>
                        </div>
                        <pre><code>// 1. Clean up MediaCodec
override fun onDestroy() {
    super.onDestroy()

    try {
        codec?.stop()
        codec?.release()
        codec = null
    } catch (e: Exception) {
        Log.e(TAG, "Error releasing codec", e)
    }

    surface?.release()
    surface = null
}

// 2. Clean up ExoPlayer
override fun onStop() {
    super.onStop()
    player.release()
}

// 3. Image loading optimization (Glide)
Glide.with(context)
    .load(thumbnailUrl)
    .override(200, 200) // Size limit
    .diskCacheStrategy(DiskCacheStrategy.RESOURCE)
    .into(imageView)

// 4. Memory monitoring
val activityManager = getSystemService(Context.ACTIVITY_SERVICE) as ActivityManager
val memoryInfo = ActivityManager.MemoryInfo()
activityManager.getMemoryInfo(memoryInfo)

if (memoryInfo.lowMemory) {
    Log.w(TAG, "Low memory detected - clearing cache")
    Glide.get(this).clearMemory()
    player.stop()
}

// 5. Use largeHeap (AndroidManifest.xml)
// <application android:largeHeap="true"></code></pre>
                    </div>
                </div>

                <div class="issue-section">
                    <span class="issue-label">Verification</span>
                    <pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto;">
<code># Check memory usage
adb shell dumpsys meminfo <package-name>

# Memory leak detection (LeakCanary)
# Add to build.gradle: debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.x'

# Heap dump
adb shell am dumpheap <package-name> /data/local/tmp/heap.hprof
adb pull /data/local/tmp/heap.hprof</code></pre>
                </div>
            </div>
        </section>

        <!-- Section 7: Quick Diagnosis Flowchart -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">7</span>
                Quick Diagnosis Flowchart
            </h2>
            <p class="section-description">
                Quick diagnosis flow by problem type.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    flowchart TD
                    START[Media Issue Occurred] --> Q1{Is there sound?}

                    Q1 -->|Yes| Q2{Is video showing?}
                    Q1 -->|No| AUDIO_ISSUE[Audio Issue<br/>See Section 4]

                    Q2 -->|Yes| Q3{Buffering/Stuttering?}
                    Q2 -->|No| CODEC_ISSUE[Codec Issue<br/>See Section 2]

                    Q3 -->|Yes| PLAYBACK_ISSUE[Playback Issue<br/>See Section 1]
                    Q3 -->|No| Q4{DRM Content?}

                    Q4 -->|Yes| DRM_ISSUE[DRM Issue<br/>See Section 3]
                    Q4 -->|No| Q5{Automotive?}

                    Q5 -->|Yes| AUTO_ISSUE[Automotive Issue<br/>See Section 5]
                    Q5 -->|No| PERF_ISSUE[Performance Issue<br/>See Section 6]
                </div>
            </div>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                Quick Checklist by Symptom
            </h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        No Sound
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Check Audio Focus</li>
                            <li>Check volume settings</li>
                            <li>Check mute status</li>
                            <li>Check AudioAttributes</li>
                            <li>Automotive: Check Zone/Routing</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        No Video
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Check MediaCodec initialization</li>
                            <li>Check Surface settings</li>
                            <li>Check resolution support</li>
                            <li>Check dequeueOutputBuffer logs</li>
                            <li>Verify hardware decoder usage</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Buffering
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Check network speed</li>
                            <li>Check buffer size</li>
                            <li>Check ABR settings</li>
                            <li>Check server response time</li>
                            <li>Check CDN status</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        DRM Error
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Check Widevine Level (L1/L3)</li>
                            <li>Check Provisioning status</li>
                            <li>Check License URL</li>
                            <li>Check HDCP support (external display)</li>
                            <li>Check authentication token</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 8: Related Documents -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">8</span>
                Related Detailed Documents
            </h2>
            <p class="section-description">
                Detailed document links for each problem type.
            </p>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Media Playback
                    </h3>
                    <div class="card-description">
                        <p>Media playback pipeline details</p>
                        <a href="media-playback.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Codec 2.0
                    </h3>
                    <div class="card-description">
                        <p>MediaCodec architecture and usage</p>
                        <a href="codec2.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Widevine DRM
                    </h3>
                    <div class="card-description">
                        <p>DRM security and license management</p>
                        <a href="widevine.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Audio Framework
                    </h3>
                    <div class="card-description">
                        <p>Audio system architecture</p>
                        <a href="audio-framework.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Car Media Service
                    </h3>
                    <div class="card-description">
                        <p>AAOS media system</p>
                        <a href="carmedia.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        Media App Layer
                    </h3>
                    <div class="card-description">
                        <p>MediaPlayer/ExoPlayer/Media3 API</p>
                        <a href="media-app-layer.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        MediaSession
                    </h3>
                    <div class="card-description">
                        <p>Media session framework</p>
                        <a href="mediasession.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon"></span>
                        AOSP Architecture
                    </h3>
                    <div class="card-description">
                        <p>Android overall system structure</p>
                        <a href="aosp.html" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">
                            View Document ->
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer
            style="text-align: center; padding: 40px 20px; color: var(--text-muted); border-top: 1px solid var(--border-color); margin-top: 60px;">
            <p>Common Media Issues & Solutions</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                Android Media Framework Practical Troubleshooting Guide
            </p>
            <p style="margin-top: 20px;">
                <a href="index.html" style="color: var(--accent-primary); text-decoration: none;">
                    <- Back to AOSP Media Framework
                </a>
            </p>
        </footer>
    </div>

    <script src="../scripts/mermaid-theme.js"></script>
    <!-- Navigation & Copy Features -->
    <script src="../scripts/copy-code.js"></script>
    <script src="../scripts/toc-generator.js"></script>
    <script src="../scripts/page-navigation.js"></script>
    <!-- Interactive Diagram Features -->
    <script src="../scripts/diagram-data.js"></script>
    <script src="../scripts/diagram-data-en-partial.js"></script>
    <script src="../scripts/diagram-interactive.js"></script>

    <script src="../scripts/theme-toggle.js?v=2"></script>
    <script src="../scripts/lang-switch.js"></script>
</body>
</html>
