<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent Flash of Incorrect Theme (FOIT) -->
    <script>
    (function(){var t=localStorage.getItem('android-media-framework-theme');if(t)document.documentElement.setAttribute('data-theme',t);else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches)document.documentElement.setAttribute('data-theme','light');})();
    </script>
    <title>Android MediaSession Framework</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
    // Mermaid theme initialization (Light/Dark mode support)
    (function() {
        const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        const config = isDark ? {
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                darkMode: true,
                background: '#1a2030',
                primaryColor: '#8b5cf6',
                primaryTextColor: '#e8eaed',
                primaryBorderColor: '#8b5cf6',
                secondaryColor: '#ec4899',
                secondaryTextColor: '#e8eaed',
                secondaryBorderColor: '#ec4899',
                tertiaryColor: '#3b82f6',
                tertiaryTextColor: '#e8eaed',
                tertiaryBorderColor: '#3b82f6',
                lineColor: '#4b5563',
                textColor: '#e8eaed',
                mainBkg: '#1a2030',
                nodeBorder: '#8b5cf6',
                clusterBkg: '#1a2030',
                clusterBorder: '#4b5563',
                defaultLinkColor: '#4b5563',
                titleColor: '#e8eaed',
                edgeLabelBackground: '#1a2030',
                nodeTextColor: '#e8eaed',
                actorBorder: '#8b5cf6',
                actorBkg: '#1a2030',
                actorTextColor: '#e8eaed',
                actorLineColor: '#4b5563',
                signalColor: '#e8eaed',
                signalTextColor: '#e8eaed',
                labelBoxBkgColor: '#1a2030',
                labelBoxBorderColor: '#4b5563',
                labelTextColor: '#e8eaed',
                loopTextColor: '#e8eaed',
                activationBorderColor: '#8b5cf6',
                activationBkgColor: '#1a2030',
                sequenceNumberColor: '#e8eaed'
            }
        } : {
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                darkMode: false,
                background: '#fafaf9',
                primaryColor: '#dbeafe',
                primaryTextColor: '#292524',
                primaryBorderColor: '#0369a1',
                secondaryColor: '#fee2e2',
                secondaryTextColor: '#292524',
                secondaryBorderColor: '#dc2626',
                tertiaryColor: '#e0e7ff',
                tertiaryTextColor: '#292524',
                tertiaryBorderColor: '#1d4ed8',
                lineColor: '#a8a29e',
                textColor: '#292524',
                mainBkg: '#fafaf9',
                nodeBorder: '#0369a1',
                clusterBkg: '#f5f5f4',
                clusterBorder: '#a8a29e',
                defaultLinkColor: '#a8a29e',
                titleColor: '#292524',
                edgeLabelBackground: '#fafaf9',
                nodeTextColor: '#292524',
                actorBorder: '#0369a1',
                actorBkg: '#fafaf9',
                actorTextColor: '#292524',
                actorLineColor: '#a8a29e',
                signalColor: '#292524',
                signalTextColor: '#292524',
                labelBoxBkgColor: '#fafaf9',
                labelBoxBorderColor: '#a8a29e',
                labelTextColor: '#292524',
                loopTextColor: '#292524',
                activationBorderColor: '#0369a1',
                activationBkgColor: '#e0f2fe',
                sequenceNumberColor: '#292524'
            }
        };
        mermaid.initialize(config);
    })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;900&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/design-system.css">

        <style>
        /* Page-specific styles loaded from design-system.css */
    </style>
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-button">
            ‚Üê AOSP Media Framework
        </a>
    </nav>

    <div class="container">
        <header>
            <h1 class="page-title">MediaSession</h1>
            <p class="page-subtitle">Android Media Playback Control Framework</p>
        </header>

        <!-- Section 1: Overview -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">1</span>
                MediaSession Overview
            </h2>
            <p class="section-description">
                MediaSession is a core framework in Android that controls media playback and makes it accessible from external sources.
            </p>

            <div class="highlight-box">
                <strong>What is MediaSession?</strong> A framework that advertises your app's media player to the system and external apps,
                receives playback commands from various sources (notifications, Android Auto, Google Assistant, etc.) to provide unified media playback control.
            </div>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéØ</span>
                        Main Purposes
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Advertise media playback state to the system</li>
                            <li>Enable external media control</li>
                            <li>Provide consistent media experience</li>
                            <li>Support background playback</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üîå</span>
                        Control Sources
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li><strong>Notification</strong>: Notification media controls</li>
                            <li><strong>Android Auto</strong>: Vehicle display</li>
                            <li><strong>Wear OS</strong>: Smartwatch</li>
                            <li><strong>Google Assistant</strong>: Voice commands</li>
                            <li><strong>Media Buttons</strong>: Headphone buttons</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">‚öôÔ∏è</span>
                        Core Features
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Play/Pause/Stop/Skip</li>
                            <li>Playback state and metadata transmission</li>
                            <li>Queue management</li>
                            <li>Media button event handling</li>
                            <li>Communication with external controllers</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìö</span>
                        Media3 vs Legacy
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li><strong>Legacy</strong>: MediaSessionCompat</li>
                            <li><strong>Media3</strong>: androidx.media3.session</li>
                            <li>Media3 has unified Player interface</li>
                            <li>ExoPlayer built-in integration</li>
                            <li>Simpler architecture</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Architecture -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">2</span>
                MediaSession Architecture
            </h2>
            <p class="section-description">
                The MediaSession framework manages communication between media apps and external controllers using a Client-Server architecture.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph TB
                    UI["üì± UI Activity<br />(MediaBrowser + MediaController)"]

                    SERVICE["üéµ MediaBrowserService / MediaSessionService<br />(Background Service)"]

                    SESSION["MediaSession<br />(Hub / Middleware)"]

                    PLAYER["üé∂ Player<br />(ExoPlayer / MediaPlayer)"]

                    EXTERNAL["External Controllers"]
                    NOTIF["üì¢ Notification<br />MediaStyle"]
                    AUTO["üöó Android Auto"]
                    WEAR["‚åö Wear OS"]
                    ASSISTANT["üé§ Google Assistant"]
                    BUTTON["üéß Media Buttons"]

                    UI -->|Browse Media| SERVICE
                    UI -->|Control Commands| SESSION
                    SERVICE -->|Contains| SESSION
                    SESSION -->|Delegates| PLAYER

                    NOTIF -->|Commands| SESSION
                    AUTO -->|Commands| SESSION
                    WEAR -->|Commands| SESSION
                    ASSISTANT -->|Commands| SESSION
                    BUTTON -->|Commands| SESSION

                    SESSION -->|State/Metadata Updates| UI
                    SESSION -->|State/Metadata Updates| EXTERNAL

                    EXTERNAL -.->|Group| NOTIF
                    EXTERNAL -.->|Group| AUTO
                    EXTERNAL -.->|Group| WEAR
                    EXTERNAL -.->|Group| ASSISTANT
                    EXTERNAL -.->|Group| BUTTON

                </div>
            </div>
        </section>

        <!-- Section 3: Components -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">3</span>
                Key Components
            </h2>
            <p class="section-description">
                Explains the core components and roles of the MediaSession framework.
            </p>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéµ</span>
                        MediaSession
                    </h3>
                    <div class="card-description">
                        <p><strong>Media Playback Hub</strong></p>
                        <ul>
                            <li>Advertises player to the system</li>
                            <li>Forwards external commands to player</li>
                            <li>Transmits playback state and metadata</li>
                            <li>Identified by SessionToken</li>
                            <li>Receives commands via Callback</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéÆ</span>
                        MediaController
                    </h3>
                    <div class="card-description">
                        <p><strong>Media Control Interface</strong></p>
                        <ul>
                            <li>Connects to MediaSession</li>
                            <li>Sends playback commands (play, pause, skip)</li>
                            <li>Receives state updates</li>
                            <li>Implements Player interface (Media3)</li>
                            <li>Separates UI from player</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üîç</span>
                        MediaBrowser
                    </h3>
                    <div class="card-description">
                        <p><strong>Media Library Browser</strong></p>
                        <ul>
                            <li>Connects to MediaBrowserService</li>
                            <li>Browses media content hierarchy</li>
                            <li>Creates MediaController</li>
                            <li>Android Auto/Wear integration</li>
                            <li>Background service access</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">‚öôÔ∏è</span>
                        MediaBrowserService
                    </h3>
                    <div class="card-description">
                        <p><strong>Background Media Service</strong></p>
                        <ul>
                            <li>Hosts MediaSession</li>
                            <li>Exposes media library</li>
                            <li>Manages background playback</li>
                            <li>Allows external app connections</li>
                            <li>Automatic lifecycle management</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üé∂</span>
                        Player
                    </h3>
                    <div class="card-description">
                        <p><strong>Actual Media Player</strong></p>
                        <ul>
                            <li>Audio/Video playback</li>
                            <li>Decoding and buffering</li>
                            <li>MediaPlayer (default)</li>
                            <li>ExoPlayer (recommended, Media3)</li>
                            <li>Implements Player interface</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üì¢</span>
                        MediaStyle Notification
                    </h3>
                    <div class="card-description">
                        <p><strong>Media Notification</strong></p>
                        <ul>
                            <li>NotificationCompat.MediaStyle</li>
                            <li>MediaSession integration</li>
                            <li>Display playback controls</li>
                            <li>Show album art</li>
                            <li>Auto/Wear automatic bridging</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: Playback Control Flow -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">4</span>
                Playback Control Flow
            </h2>
            <p class="section-description">
                The complete flow of how user commands are delivered to the Player through MediaSession.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                    participant User as üë§ User
                    participant Notif as üì¢ Notification
                    participant Controller as üéÆ MediaController
                    participant Session as üéµ MediaSession
                    participant Player as üé∂ Player

                    User->>Notif: Click Play button
                    Notif->>Controller: play() command
                    Controller->>Session: onPlay() callback
                    Session->>Player: player.play()
                    Player->>Player: Start playback

                    Player->>Session: State change (PLAYING)
                    Session->>Controller: onPlaybackStateChanged()
                    Controller->>Notif: UI update (Playing)
                    Notif->>User: Play icon ‚Üí Pause icon

                    Note over Session,Player: Metadata transmission
                    Player->>Session: Track info
                    Session->>Controller: onMetadataChanged()
                    Controller->>Notif: Display album art, title, artist
                </div>
            </div>

            <div class="highlight-box" style="margin-top: 30px;">
                <strong>Core Process:</strong>
                <ol style="margin-top: 10px; padding-left: 20px;">
                    <li>User clicks play button from Notification, Auto, Wear, etc.</li>
                    <li>The controller sends play() command to MediaSession</li>
                    <li>MediaSession's Callback calls onPlay()</li>
                    <li>Actual playback command is forwarded to Player</li>
                    <li>Player starts playback and changes state</li>
                    <li>MediaSession updates state to all connected controllers</li>
                    <li>UI automatically refreshes (Notification, Auto, Wear updated simultaneously)</li>
                </ol>
            </div>
        </section>

        <!-- Section 5: Integration -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">5</span>
                Auto & Wear Integration
            </h2>
            <p class="section-description">
                Using MediaSession automatically enables Android Auto and Wear OS integration.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph TB
                    APP["üì± Media App<br />(Phone)"]
                    SESSION["üéµ MediaSession"]
                    NOTIF["üì¢ MediaStyle<br />Notification"]

                    AUTO_SYS["üöó Android Auto<br />System"]
                    WEAR_SYS["‚åö Wear OS<br />System"]

                    AUTO_UI["Car Display<br />Media Controls"]
                    WEAR_UI["Watch Display<br />Media Controls"]

                    APP --> SESSION
                    SESSION --> NOTIF
                    NOTIF -.->|Auto Bridge| AUTO_SYS
                    NOTIF -.->|Auto Bridge| WEAR_SYS

                    AUTO_SYS --> AUTO_UI
                    WEAR_SYS --> WEAR_UI

                    AUTO_UI -->|Commands| SESSION
                    WEAR_UI -->|Commands| SESSION

                </div>
            </div>

            <div class="content-grid" style="margin-top: 30px;">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üöó</span>
                        Android Auto Integration
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li><strong>Auto Bridging</strong>: MediaStyle notifications auto-transmitted</li>
                            <li><strong>MediaBrowserService</strong>: Expose content library</li>
                            <li><strong>Vehicle Display</strong>: Native media UI</li>
                            <li><strong>Voice Commands</strong>: Google Assistant integration</li>
                            <li>No separate Auto-specific code needed</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">‚åö</span>
                        Wear OS Integration
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li><strong>Auto Bridging</strong>: Notifications sent to Watch</li>
                            <li><strong>Ongoing Activity</strong>: Watch Face display during playback</li>
                            <li><strong>Media Controls</strong>: Album art, playback buttons</li>
                            <li><strong>Media3 Auto Support</strong>: No additional implementation needed</li>
                            <li>Automatic sync with paired devices</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üí°</span>
                        Implementation Tips
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Must create MediaSession</li>
                            <li>Set up Notification with MediaStyle</li>
                            <li>Call setMediaSession(token)</li>
                            <li>Implement MediaBrowserService (for content browsing)</li>
                            <li>Update metadata and state accurately</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 6: Implementation -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">6</span>
                Implementation Examples
            </h2>
            <p class="section-description">
                Basic media app implementation structure using MediaSession.
            </p>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">1Ô∏è‚É£</span>
                        Create MediaSession
                    </h3>
                    <div class="card-description">
                        <p><strong>Create in Service</strong></p>
                        <ul>
                            <li><code>MediaSession(context, TAG)</code></li>
                            <li>Set up Callback</li>
                            <li>Connect Player</li>
                            <li>Obtain SessionToken</li>
                            <li>Set Active state</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">2Ô∏è‚É£</span>
                        Implement Callback
                    </h3>
                    <div class="card-description">
                        <p><strong>MediaSession.Callback</strong></p>
                        <ul>
                            <li><code>onPlay()</code>: Start playback</li>
                            <li><code>onPause()</code>: Pause</li>
                            <li><code>onStop()</code>: Stop</li>
                            <li><code>onSkipToNext()</code>: Next track</li>
                            <li><code>onSeekTo()</code>: Seek</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">3Ô∏è‚É£</span>
                        Set Up Notification
                    </h3>
                    <div class="card-description">
                        <p><strong>MediaStyle Notification</strong></p>
                        <ul>
                            <li><code>NotificationCompat.MediaStyle()</code></li>
                            <li><code>setMediaSession(token)</code></li>
                            <li>Add Actions (play, pause, skip)</li>
                            <li>Set album art</li>
                            <li>Ongoing notification</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">4Ô∏è‚É£</span>
                        Connect UI
                    </h3>
                    <div class="card-description">
                        <p><strong>MediaController in Activity</strong></p>
                        <ul>
                            <li>Connect Service via MediaBrowser</li>
                            <li>Create Controller with SessionToken</li>
                            <li>Call transport controls</li>
                            <li>Update UI via Callback</li>
                            <li>Manage connection release</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">5Ô∏è‚É£</span>
                        Update State
                    </h3>
                    <div class="card-description">
                        <p><strong>PlaybackState and Metadata</strong></p>
                        <ul>
                            <li><code>setPlaybackState()</code></li>
                            <li>STATE_PLAYING, STATE_PAUSED, etc.</li>
                            <li><code>setMetadata()</code></li>
                            <li>Title, artist, album art</li>
                            <li>Duration, Position info</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">6Ô∏è‚É£</span>
                        Lifecycle Management
                    </h3>
                    <div class="card-description">
                        <p><strong>Service Lifecycle</strong></p>
                        <ul>
                            <li>onCreate(): Create MediaSession</li>
                            <li>onStartCommand(): Start playback</li>
                            <li>startForeground(): Notification</li>
                            <li>onDestroy(): Cleanup and release()</li>
                            <li>MediaBrowser connection management</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 7: Code Examples -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">7</span>
                Actual Code Examples
            </h2>
            <p class="section-description">
                Provides actual implementation code using MediaSession in both Legacy and Media3 approaches.
            </p>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-bottom: 20px;">
                üì± Legacy: MediaSessionCompat + MediaBrowserServiceCompat
            </h3>

            <h4 style="color: var(--text-primary); font-size: 1.2rem; margin-top: 30px; margin-bottom: 15px;">
                1. MediaBrowserServiceCompat Implementation
            </h4>

            <pre style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid var(--accent-primary);"><code style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">// MusicService.kt (Legacy)
class MusicService : MediaBrowserServiceCompat() {
    private var mediaSession: MediaSessionCompat? = null
    private lateinit var stateBuilder: PlaybackStateCompat.Builder
    private lateinit var player: MediaPlayer

    override fun onCreate() {
        super.onCreate()

        // Create MediaSession
        mediaSession = MediaSessionCompat(baseContext, "MusicService").apply {
            // Set Callback
            setCallback(MediaSessionCallback())

            // Set Flags
            setFlags(
                MediaSessionCompat.FLAG_HANDLES_MEDIA_BUTTONS or
                MediaSessionCompat.FLAG_HANDLES_TRANSPORT_CONTROLS
            )

            // Initialize PlaybackState
            stateBuilder = PlaybackStateCompat.Builder()
                .setActions(
                    PlaybackStateCompat.ACTION_PLAY or
                    PlaybackStateCompat.ACTION_PAUSE or
                    PlaybackStateCompat.ACTION_SKIP_TO_NEXT or
                    PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS
                )
            setPlaybackState(stateBuilder.build())

            // Activate Session
            isActive = true
        }

        // Set SessionToken
        sessionToken = mediaSession?.sessionToken

        // Initialize Player
        player = MediaPlayer()
    }

    override fun onGetRoot(
        clientPackageName: String,
        clientUid: Int,
        rootHints: Bundle?
    ): BrowserRoot? {
        // Allow Android Auto/Wear OS access
        return BrowserRoot("root", null)
    }

    override fun onLoadChildren(
        parentId: String,
        result: Result<MutableList<MediaBrowserCompat.MediaItem>>
    ) {
        val mediaItems = mutableListOf<MediaBrowserCompat.MediaItem>()

        when (parentId) {
            "root" -> {
                // Top-level menu
                mediaItems.add(
                    MediaBrowserCompat.MediaItem(
                        MediaDescriptionCompat.Builder()
                            .setMediaId("albums")
                            .setTitle("Albums")
                            .setSubtitle("Browse by album")
                            .build(),
                        MediaBrowserCompat.MediaItem.FLAG_BROWSABLE
                    )
                )
            }
        }

        result.sendResult(mediaItems)
    }

    inner class MediaSessionCallback : MediaSessionCompat.Callback() {
        override fun onPlay() {
            player.start()
            updatePlaybackState(PlaybackStateCompat.STATE_PLAYING)
            showNotification()
        }

        override fun onPause() {
            player.pause()
            updatePlaybackState(PlaybackStateCompat.STATE_PAUSED)
        }

        override fun onStop() {
            player.stop()
            updatePlaybackState(PlaybackStateCompat.STATE_STOPPED)
            stopForeground(true)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        mediaSession?.release()
        player.release()
    }
}</code></pre>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                üöÄ Media3: MediaSessionService + MediaSession
            </h3>

            <h4 style="color: var(--text-primary); font-size: 1.2rem; margin-top: 30px; margin-bottom: 15px;">
                1. MediaSessionService Implementation
            </h4>

            <pre style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid var(--accent-primary);"><code style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">// MusicService.kt (Media3)
class MusicService : MediaSessionService() {
    private var mediaSession: MediaSession? = null

    override fun onCreate() {
        super.onCreate()

        // Create ExoPlayer
        val player = ExoPlayer.Builder(this).build()

        // Create MediaSession
        mediaSession = MediaSession.Builder(this, player)
            .setCallback(MediaSessionCallback())
            .build()
    }

    override fun onGetSession(controllerInfo: MediaSession.ControllerInfo): MediaSession? {
        return mediaSession
    }

    private inner class MediaSessionCallback : MediaSession.Callback {
        override fun onConnect(
            session: MediaSession,
            controller: MediaSession.ControllerInfo
        ): MediaSession.ConnectionResult {
            val connectionResult = super.onConnect(session, controller)

            // Set Session Commands
            val sessionCommands = connectionResult.availableSessionCommands.buildUpon()
                .add(SessionCommand("CUSTOM_COMMAND", Bundle()))
                .build()

            return MediaSession.ConnectionResult.accept(
                sessionCommands,
                connectionResult.availablePlayerCommands
            )
        }
    }

    override fun onDestroy() {
        mediaSession?.run {
            player.release()
            release()
            mediaSession = null
        }
        super.onDestroy()
    }
}</code></pre>

            <div class="highlight-box" style="margin-top: 30px;">
                <strong>üí° Key Differences in Code Examples:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>Legacy</strong>: MediaBrowserServiceCompat, MediaSessionCompat.Callback, manual PlaybackState management</li>
                    <li><strong>Media3</strong>: MediaSessionService, ExoPlayer integration, automatic state sync, Player.Listener</li>
                    <li><strong>Code Simplicity</strong>: Media3 is about 40% shorter and more concise</li>
                    <li><strong>Maintenance</strong>: Media3 integrates with ExoPlayer for automated buffering and error handling</li>
                </ul>
            </div>
        </section>

        <!-- Section 8: Media3 vs Legacy Comparison -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">8</span>
                Media3 vs Legacy Comparison
            </h2>
            <p class="section-description">
                A detailed comparison of Media3 and Legacy MediaSession APIs.
            </p>

            <div class="highlight-box">
                <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--accent-primary);">
                            <th style="padding: 12px; text-align: left; color: var(--accent-primary);">Item</th>
                            <th style="padding: 12px; text-align: left; color: var(--accent-primary);">Legacy (MediaSessionCompat)</th>
                            <th style="padding: 12px; text-align: left; color: var(--accent-primary);">Media3 (androidx.media3)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Package</strong></td>
                            <td style="padding: 10px;">android.support.v4.media<br />androidx.media</td>
                            <td style="padding: 10px;">androidx.media3.session<br />androidx.media3.exoplayer</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Service Class</strong></td>
                            <td style="padding: 10px;">MediaBrowserServiceCompat</td>
                            <td style="padding: 10px;">MediaSessionService (simplified)</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Player Integration</strong></td>
                            <td style="padding: 10px;">Manual MediaPlayer or ExoPlayer integration</td>
                            <td style="padding: 10px;">Native ExoPlayer integration</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>State Management</strong></td>
                            <td style="padding: 10px;">PlaybackStateCompat.Builder<br />Manual setState() calls</td>
                            <td style="padding: 10px;">Player.Listener<br />Automatic state propagation</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Notification</strong></td>
                            <td style="padding: 10px;">NotificationCompat.MediaStyle<br />Manual build</td>
                            <td style="padding: 10px;">MediaNotification<br />Auto-generated</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Maintenance Status</strong></td>
                            <td style="padding: 10px;">‚ö†Ô∏è Maintenance mode (bug fixes only)</td>
                            <td style="padding: 10px;">‚úÖ Active development and updates</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;"><strong>Recommendation</strong></td>
                            <td style="padding: 10px;">‚ö†Ô∏è Not recommended for new projects</td>
                            <td style="padding: 10px;">‚úÖ Recommended for all new projects</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                üîÑ Migration Guide
            </h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">1Ô∏è‚É£</span>
                        Dependency Change
                    </h3>
                    <div class="card-description">
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 10px;"><code>// build.gradle.kts
// Remove Legacy
// implementation("androidx.media:media:1.x.x")

// Add Media3
implementation("androidx.media3:media3-session:1.2.0")
implementation("androidx.media3:media3-exoplayer:1.2.0")</code></pre>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">2Ô∏è‚É£</span>
                        Service Migration
                    </h3>
                    <div class="card-description">
                        <ul style="margin-top: 10px;">
                            <li><code>MediaBrowserServiceCompat</code> ‚Üí <code>MediaSessionService</code></li>
                            <li>Remove <code>onGetRoot()</code>, <code>onLoadChildren()</code></li>
                            <li>Implement <code>onGetSession()</code></li>
                            <li>Create and connect ExoPlayer</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">3Ô∏è‚É£</span>
                        Callback Simplification
                    </h3>
                    <div class="card-description">
                        <ul style="margin-top: 10px;">
                            <li>Can remove <code>onPlay()</code>, <code>onPause()</code></li>
                            <li>Player automatically handles commands</li>
                            <li>Override only custom logic</li>
                            <li>Remove manual <code>PlaybackStateCompat</code> updates</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">4Ô∏è‚É£</span>
                        Controller Change
                    </h3>
                    <div class="card-description">
                        <ul style="margin-top: 10px;">
                            <li><code>MediaBrowserCompat</code> ‚Üí <code>ListenableFuture&lt;MediaController&gt;</code></li>
                            <li><code>transportControls.play()</code> ‚Üí <code>controller.play()</code></li>
                            <li><code>MediaControllerCompat.Callback</code> ‚Üí <code>Player.Listener</code></li>
                            <li>Apply async connection pattern</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="warning-box" style="margin-top: 30px;">
                <strong>üöÄ Recommended Migration Timing:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>New Projects</strong>: Must use Media3</li>
                    <li><strong>Existing Projects</strong>: Consider migration during major refactoring</li>
                    <li><strong>Using ExoPlayer</strong>: Significant integration benefits when migrating to Media3</li>
                    <li><strong>Using MediaPlayer</strong>: Can maintain Legacy but Media3 + ExoPlayer recommended</li>
                    <li>Google designated Media3 as the official recommended library starting 2024</li>
                </ul>
            </div>
        </section>

        <!-- Section 9: Audio Focus & Session Management -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">9</span>
                Audio Focus & Session Management
            </h2>
            <p class="section-description">
                Explains multi-app audio playback coordination via AudioFocus and session priority management.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                    participant App as Music App
                    participant AM as AudioManager
                    participant Phone as Phone Call
                    participant Nav as Navigation

                    App->>AM: requestAudioFocus()<br />AUDIOFOCUS_GAIN
                    AM-->>App: AUDIOFOCUS_REQUEST_GRANTED
                    App->>App: player.play()

                    Note over Phone: Incoming call
                    Phone->>AM: requestAudioFocus()<br />AUDIOFOCUS_GAIN_TRANSIENT
                    AM->>App: onAudioFocusChange()<br />AUDIOFOCUS_LOSS_TRANSIENT
                    App->>App: player.pause()
                    AM-->>Phone: AUDIOFOCUS_REQUEST_GRANTED

                    Note over Phone: Call ended
                    Phone->>AM: abandonAudioFocus()
                    AM->>App: onAudioFocusChange()<br />AUDIOFOCUS_GAIN
                    App->>App: player.play() (resume)

                    Note over Nav: Navigation guidance
                    Nav->>AM: requestAudioFocus()<br />AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK
                    AM->>App: onAudioFocusChange()<br />AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK
                    App->>App: player.setVolume(0.2f) (Ducking)
                    AM-->>Nav: AUDIOFOCUS_REQUEST_GRANTED

                    Nav->>AM: abandonAudioFocus()
                    AM->>App: onAudioFocusChange()<br />AUDIOFOCUS_GAIN
                    App->>App: player.setVolume(1.0f) (Volume restored)
                </div>
            </div>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                üéß AudioFocus Request and Handling
            </h3>

            <pre style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid var(--accent-primary);"><code style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">// AudioFocus Management
class MusicService : MediaBrowserServiceCompat() {
    private lateinit var audioManager: AudioManager
    private lateinit var audioFocusRequest: AudioFocusRequest

    private val afChangeListener = AudioManager.OnAudioFocusChangeListener { focusChange ->
        when (focusChange) {
            AudioManager.AUDIOFOCUS_GAIN -> {
                // Focus gained: Resume playback and restore volume
                player.volume = 1.0f
                if (shouldResumeOnFocusGain) {
                    player.play()
                }
            }
            AudioManager.AUDIOFOCUS_LOSS -> {
                // Permanent focus loss: Stop playback
                player.pause()
                shouldResumeOnFocusGain = false
            }
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -> {
                // Transient focus loss (call, etc.): Pause, resume later
                if (player.isPlaying) {
                    player.pause()
                    shouldResumeOnFocusGain = true
                }
            }
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK -> {
                // Transient focus loss (ducking allowed, navigation, etc.): Lower volume
                player.volume = 0.2f
            }
        }
    }
}</code></pre>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                üìä AudioFocus Type Comparison
            </h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéµ</span>
                        AUDIOFOCUS_GAIN
                    </h3>
                    <div class="card-description">
                        <p><strong>Permanent Focus Acquisition</strong></p>
                        <ul>
                            <li><strong>Use Case</strong>: Music playback, podcasts</li>
                            <li><strong>Impact on Other Apps</strong>: Stop or duck playback</li>
                            <li><strong>On Loss</strong>: Stop playback</li>
                            <li><strong>On Regain</strong>: Resume playback</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìû</span>
                        AUDIOFOCUS_GAIN_TRANSIENT
                    </h3>
                    <div class="card-description">
                        <p><strong>Transient Focus (Cannot Duck)</strong></p>
                        <ul>
                            <li><strong>Use Case</strong>: Phone calls, alarms</li>
                            <li><strong>Impact on Other Apps</strong>: Force pause</li>
                            <li><strong>On Loss</strong>: Pause</li>
                            <li><strong>On Regain</strong>: Auto resume</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üó∫Ô∏è</span>
                        AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK
                    </h3>
                    <div class="card-description">
                        <p><strong>Transient Focus (Ducking Allowed)</strong></p>
                        <ul>
                            <li><strong>Use Case</strong>: Navigation guidance, notifications</li>
                            <li><strong>Impact on Other Apps</strong>: Lower volume (20%)</li>
                            <li><strong>On Loss</strong>: Ducking (continue playing)</li>
                            <li><strong>On Regain</strong>: Restore volume</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="warning-box" style="margin-top: 30px;">
                <strong>‚ö†Ô∏è AudioFocus Best Practices:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>Required</strong>: Must request AudioFocus before media playback</li>
                    <li><strong>Proper Type Selection</strong>: Set USAGE_MEDIA, CONTENT_TYPE_MUSIC, etc. accurately</li>
                    <li><strong>Distinguish LOSS vs LOSS_TRANSIENT</strong>: LOSS doesn't resume, LOSS_TRANSIENT resumes</li>
                    <li><strong>Ducking Handling</strong>: Lower volume instead of pausing for LOSS_TRANSIENT_CAN_DUCK (better UX)</li>
                    <li><strong>Focus Release</strong>: Must call abandonAudioFocus() when playback completes/stops</li>
                    <li><strong>Media3 Auto Handling</strong>: Media3 + ExoPlayer automatically manages AudioFocus (no manual implementation needed)</li>
                </ul>
            </div>
        </section>

        <!-- Section 10: Media Buttons & Custom Commands -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">10</span>
                Media Buttons & Custom Commands
            </h2>
            <p class="section-description">
                Explains handling headphone buttons, Bluetooth controls, and adding custom commands.
            </p>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-bottom: 20px;">
                üéß MediaButtonReceiver Setup
            </h3>

            <h4 style="color: var(--text-primary); font-size: 1.2rem; margin-top: 30px; margin-bottom: 15px;">
                1. AndroidManifest.xml Configuration
            </h4>

            <pre style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid var(--accent-primary);"><code style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">&lt;!-- AndroidManifest.xml --&gt;
&lt;manifest&gt;
    &lt;application&gt;
        &lt;!-- MediaBrowserService declaration --&gt;
        &lt;service
            android:name=".MusicService"
            android:exported="true"&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.media.browse.MediaBrowserService" /&gt;
            &lt;/intent-filter&gt;
        &lt;/service&gt;

        &lt;!-- MediaButtonReceiver declaration --&gt;
        &lt;receiver
            android:name="androidx.media.session.MediaButtonReceiver"
            android:exported="true"&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MEDIA_BUTTON" /&gt;
            &lt;/intent-filter&gt;
        &lt;/receiver&gt;
    &lt;/application&gt;

    &lt;!-- Required permissions --&gt;
    &lt;uses-permission android:name="android.permission.FOREGROUND_SERVICE" /&gt;
    &lt;uses-permission android:name="android.permission.WAKE_LOCK" /&gt;
&lt;/manifest&gt;</code></pre>

            <div class="highlight-box" style="margin-top: 30px;">
                <strong>üí° Media Button and Custom Command Key Points:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>MediaButtonReceiver</strong>: Must register in AndroidManifest.xml, process with handleIntent()</li>
                    <li><strong>Headset Button</strong>: Use KEYCODE_HEADSETHOOK to distinguish single/double/triple clicks</li>
                    <li><strong>Custom Actions</strong>: Auto-displayed in Notification and Auto/Wear, max 5 recommended</li>
                    <li><strong>Queue Management</strong>: Expose playlist with setQueue(), browsable from Auto/Wear</li>
                    <li><strong>Media3 Automation</strong>: Media3 automatically handles media buttons and Queue</li>
                </ul>
            </div>
        </section>

        <!-- Section 11: Performance Profiling & Debugging -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">11</span>
                Performance Profiling & Debugging
            </h2>
            <p class="section-description">
                Introduces tools and methods for MediaSession performance analysis and troubleshooting.
            </p>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-bottom: 20px;">
                üìä dumpsys Commands
            </h3>

            <pre style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid var(--accent-primary);"><code style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;"># Query all MediaSession information
adb shell dumpsys media.session

# View only active MediaSessions
adb shell dumpsys media.session | grep -A 20 "Active sessions"

# Specific app's MediaSession
adb shell dumpsys media.session | grep -A 30 "com.example.musicapp"

# MediaController information
adb shell cmd media_session list-sessions

# Volume and AudioFocus status
adb shell dumpsys audio | grep -i "focus"</code></pre>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                üîß adb Media Control Commands
            </h3>

            <pre style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid var(--accent-primary);"><code style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;"># List MediaSessions
adb shell cmd media_session list-sessions

# Play/Pause toggle
adb shell cmd media_session dispatch play
adb shell cmd media_session dispatch pause

# Next/Previous track
adb shell cmd media_session dispatch next
adb shell cmd media_session dispatch previous

# Volume control
adb shell cmd media_session volume --show
adb shell cmd media_session volume --set 10

# Simulate media button
adb shell input keyevent KEYCODE_MEDIA_PLAY_PAUSE
adb shell input keyevent KEYCODE_MEDIA_NEXT
adb shell input keyevent KEYCODE_HEADSETHOOK</code></pre>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px;">
                üêõ Troubleshooting Guide
            </h3>

            <div class="highlight-box">
                <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--accent-primary);">
                            <th style="padding: 12px; text-align: left; color: var(--accent-primary);">Symptom</th>
                            <th style="padding: 12px; text-align: left; color: var(--accent-primary);">Cause</th>
                            <th style="padding: 12px; text-align: left; color: var(--accent-primary);">Solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Playback controls not showing in Notification</strong></td>
                            <td style="padding: 10px;">MediaStyle not set or setMediaSession() missing</td>
                            <td style="padding: 10px;">1. Use NotificationCompat.MediaStyle()<br>2. Call setMediaSession(token)<br>3. Add buttons with addAction()</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>App not appearing in Android Auto</strong></td>
                            <td style="padding: 10px;">MediaBrowserService not implemented or onGetRoot() returning null</td>
                            <td style="padding: 10px;">1. Extend MediaBrowserServiceCompat<br>2. Return BrowserRoot in onGetRoot()<br>3. Add intent-filter in AndroidManifest.xml</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Headphone buttons not working</strong></td>
                            <td style="padding: 10px;">MediaButtonReceiver not registered or FLAG missing</td>
                            <td style="padding: 10px;">1. Register receiver in AndroidManifest.xml<br>2. Set FLAG_HANDLES_MEDIA_BUTTONS<br>3. Call setMediaButtonReceiver()</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Playback stops in background</strong></td>
                            <td style="padding: 10px;">Foreground Service not used</td>
                            <td style="padding: 10px;">1. Call startForeground(id, notification)<br>2. Add FOREGROUND_SERVICE permission<br>3. Set FOREGROUND_SERVICE_MEDIA_PLAYBACK type for Android 12+</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 10px;"><strong>Audio overlaps with other apps</strong></td>
                            <td style="padding: 10px;">AudioFocus not requested</td>
                            <td style="padding: 10px;">1. Call requestAudioFocus()<br>2. Implement OnAudioFocusChangeListener<br>3. Stop playback on AUDIOFOCUS_LOSS</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="warning-box" style="margin-top: 30px;">
                <strong>üí° Debugging Best Practices:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>Check active session state in real-time with dumpsys media.session</li>
                    <li>Test commands with adb cmd media_session (debug without UI)</li>
                    <li>Simulate Auto environment with Android Auto Desktop Head Unit (DHU)</li>
                    <li>Logcat filter: <code>adb logcat -s MediaSession MediaController</code></li>
                    <li>Media3 provides detailed logs, check ExoPlayer logs together</li>
                </ul>
            </div>
        </section>

        <!-- Section 12: AOSP Source Code Reference -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">12</span>
                AOSP Source Code Reference
            </h2>
            <p class="section-description">
                Introduces AOSP source code locations and core logic for understanding MediaSession implementation.
            </p>

            <h3 style="color: var(--accent-primary); font-size: 1.5rem; margin-bottom: 20px;">
                üìÇ Key Source File Locations
            </h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üì±</span>
                        Framework (Java)
                    </h3>
                    <div class="card-description">
                        <p><strong>Public API</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; font-size: 0.75rem; margin-top: 10px;"><code>frameworks/base/media/java/android/media/session/
‚îú‚îÄ‚îÄ MediaSession.java
‚îú‚îÄ‚îÄ MediaController.java
‚îú‚îÄ‚îÄ MediaSessionManager.java
‚îú‚îÄ‚îÄ PlaybackState.java
‚îî‚îÄ‚îÄ MediaMetadata.java</code></pre>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">‚öôÔ∏è</span>
                        System Service (Java)
                    </h3>
                    <div class="card-description">
                        <p><strong>MediaSessionService</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; font-size: 0.75rem; margin-top: 10px;"><code>frameworks/base/services/core/java/com/android/server/media/
‚îú‚îÄ‚îÄ MediaSessionService.java
‚îú‚îÄ‚îÄ MediaSessionRecord.java
‚îî‚îÄ‚îÄ MediaSessionStack.java</code></pre>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìö</span>
                        AndroidX (Legacy)
                    </h3>
                    <div class="card-description">
                        <p><strong>MediaSessionCompat</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; font-size: 0.75rem; margin-top: 10px;"><code>androidx/media/media/src/main/java/androidx/media/
‚îú‚îÄ‚îÄ MediaSessionCompat.java
‚îú‚îÄ‚îÄ MediaControllerCompat.java
‚îî‚îÄ‚îÄ MediaBrowserServiceCompat.java</code></pre>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üöÄ</span>
                        Media3
                    </h3>
                    <div class="card-description">
                        <p><strong>androidx.media3.session</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; font-size: 0.75rem; margin-top: 10px;"><code>androidx/media3/libraries/session/src/main/java/
‚îú‚îÄ‚îÄ MediaSession.kt
‚îú‚îÄ‚îÄ MediaController.kt
‚îî‚îÄ‚îÄ MediaSessionService.kt</code></pre>
                    </div>
                </div>
            </div>

            <div class="highlight-box" style="margin-top: 30px;">
                <strong>üîó AOSP Source Code Exploration Links:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/media/java/android/media/session/" target="_blank" style="color: var(--accent-primary);">MediaSession Framework (Java)</a></li>
                    <li><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/media/" target="_blank" style="color: var(--accent-primary);">MediaSessionService (System Server)</a></li>
                    <li><a href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:media/media/src/main/java/androidx/media/" target="_blank" style="color: var(--accent-primary);">MediaSessionCompat (AndroidX Legacy)</a></li>
                    <li><a href="https://github.com/androidx/media/tree/release/libraries/session/src/main/java/androidx/media3/session" target="_blank" style="color: var(--accent-primary);">Media3 Session (GitHub)</a></li>
                </ul>
            </div>
        </section>

        <!-- Section 13: Media Source Change -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">13</span>
                Media Source Change
            </h2>
            <p class="section-description">
                Detailed explanation of media source change scenarios in MediaSession and their internal operations at the API level.
            </p>

            <div class="highlight-box">
                <strong>What is Source Change?</strong> It refers to switching from the currently playing media source to a different source.
                This includes various scenarios such as inter-app switching (Spotify ‚Üí YouTube Music), in-app track changes, and media app switching in AAOS.
            </div>

            <h3 style="color: var(--accent-primary); margin: 30px 0 20px 0; font-size: 1.4rem;">üìä Source Change Types</h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üîÑ</span>
                        Inter-App Session Switch
                    </h3>
                    <div class="card-description">
                        <p><strong>Inter-App Session Switch</strong></p>
                        <ul>
                            <li>Switch active session from one app to another</li>
                            <li>Example: Playing Spotify ‚Üí Start YouTube Music</li>
                            <li>Deactivate existing session, activate new session</li>
                            <li>MediaSessionService mediates</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéµ</span>
                        In-App Track Change
                    </h3>
                    <div class="card-description">
                        <p><strong>In-App Track Change</strong></p>
                        <ul>
                            <li>Change playback content within the same app</li>
                            <li>Example: Play next song in playlist</li>
                            <li>ExoPlayer MediaSource replacement</li>
                            <li>MediaMetadata update</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üöó</span>
                        AAOS Source Change
                    </h3>
                    <div class="card-description">
                        <p><strong>CarMediaService Source Change</strong></p>
                        <ul>
                            <li>Media source switching in vehicle environment</li>
                            <li>CarMediaManager.setMediaSource() call</li>
                            <li>MediaSourceChangedListener callback</li>
                            <li>Last Media Source save/restore</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üèóÔ∏è Source Change Architecture</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Overall architecture where MediaSession source changes occur.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph TB
                        subgraph APPS["Media Applications"]
                            APP_A["App A<br/>(Spotify)"]
                            APP_B["App B<br/>(YouTube Music)"]
                            APP_C["App C<br/>(Local Player)"]
                        end

                        subgraph SESSIONS["MediaSessions"]
                            SESSION_A["MediaSession A<br/>(Active)"]
                            SESSION_B["MediaSession B<br/>(Inactive)"]
                            SESSION_C["MediaSession C<br/>(Inactive)"]
                        end

                        subgraph SYSTEM["System Server"]
                            MSS["MediaSessionService<br/>‚Ä¢ Session Priority Queue<br/>‚Ä¢ Active Session Management"]
                            AMSF["ActiveMediaSessionFinder<br/>‚Ä¢ Determine Active Session"]
                        end

                        subgraph CONTROLLERS["MediaControllers"]
                            NOTIFICATION["Notification<br/>MediaStyle"]
                            AUTO["Android Auto<br/>MediaBrowser"]
                            ASSISTANT["Google<br/>Assistant"]
                            WEAR["Wear OS"]
                        end

                        subgraph AAOS["AAOS Layer (Optional)"]
                            CMS["CarMediaService"]
                            CMM["CarMediaManager"]
                        end

                        APP_A --> SESSION_A
                        APP_B --> SESSION_B
                        APP_C --> SESSION_C

                        SESSION_A & SESSION_B & SESSION_C --> MSS
                        MSS --> AMSF

                        AMSF -->|Active Session| CONTROLLERS

                        CMS --> MSS
                        CMM --> CMS
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üì± Inter-App Session Switch Flow</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Detailed flow when App B starts playback while App A is playing.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                        autonumber
                        participant AppA as App A (Spotify)
                        participant SessionA as MediaSession A
                        participant MSS as MediaSessionService
                        participant AF as AudioFocusManager
                        participant AppB as App B (YouTube Music)
                        participant SessionB as MediaSession B
                        participant Controller as MediaController

                        Note over AppA,Controller: App A is playing
                        AppA->>SessionA: setPlaybackState(PLAYING)
                        SessionA->>MSS: onPlaybackStateChanged()
                        MSS->>Controller: Active Session = Session A

                        Note over AppA,Controller: App B requests playback
                        AppB->>AF: requestAudioFocus()
                        AF->>AF: Check focus policy
                        AF-->>AppA: onAudioFocusChange(LOSS)

                        Note over AppA: Handle audio focus loss
                        AppA->>AppA: pause() or duck()
                        AppA->>SessionA: setPlaybackState(PAUSED)
                        SessionA->>MSS: onPlaybackStateChanged()

                        AF-->>AppB: onAudioFocusChange(GAIN)
                        AppB->>AppB: Start playback
                        AppB->>SessionB: setActive(true)
                        AppB->>SessionB: setPlaybackState(PLAYING)

                        SessionB->>MSS: onSessionCreated/onPlaybackStateChanged
                        MSS->>MSS: Reorder Priority Queue
                        MSS->>MSS: Active Session = Session B

                        MSS->>Controller: onActiveSessionChanged()
                        Controller->>Controller: Connect to Session B

                        Note over Controller: UI Update
                        Controller->>SessionB: getMetadata()
                        SessionB-->>Controller: MediaMetadata (new app)
                        Controller->>Controller: Update notification/UI
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üéµ In-App Media Source Change Flow</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Detailed flow of replacing the currently playing track with another track in ExoPlayer.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                        autonumber
                        participant UI as Player UI
                        participant Player as ExoPlayer
                        participant MS as MediaSession
                        participant MSS as MediaSessionService
                        participant Controller as MediaController

                        Note over UI,Controller: User selects next track
                        UI->>Player: seekToNextMediaItem()

                        Note over Player: MediaSource transition
                        Player->>Player: Stop current track
                        Player->>Player: Load new MediaSource
                        Player->>Player: Start buffering

                        Player->>MS: Listener.onMediaItemTransition()
                        MS->>MS: Update MediaMetadata
                        MS->>MSS: onMetadataChanged()
                        MSS->>Controller: onMetadataChanged()

                        Note over Controller: Metadata refresh
                        Controller->>Controller: Update title/artist/album art

                        Player->>Player: Buffering complete
                        Player->>MS: Listener.onPlaybackStateChanged(READY)
                        Player->>Player: Start playback

                        MS->>MSS: onPlaybackStateChanged()
                        MSS->>Controller: onPlaybackStateChanged(PLAYING)

                        Note over Controller: Playback state refresh
                        Controller->>Controller: Update play button state
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üöó AAOS Source Change Flow</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Media source change flow through CarMediaService.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                        autonumber
                        participant User as User/System
                        participant CMM as CarMediaManager
                        participant CMS as CarMediaService
                        participant MSS as MediaSessionService
                        participant OldApp as Old App (Spotify)
                        participant NewApp as New App (Radio)
                        participant UI as Car Media UI

                        Note over User,UI: Source change request
                        User->>CMM: setMediaSource(Radio)
                        CMM->>CMS: setMediaSource(ComponentName)

                        CMS->>CMS: Save current source (Last Media)
                        CMS->>MSS: getActiveSessions()

                        Note over OldApp: Stop old app
                        CMS->>OldApp: pause() via MediaController
                        OldApp->>OldApp: Stop playback

                        Note over NewApp: Activate new app
                        CMS->>NewApp: MediaBrowser.connect()
                        NewApp->>NewApp: Service bind
                        NewApp-->>CMS: onConnected()

                        CMS->>NewApp: play() via MediaController
                        NewApp->>NewApp: Start playback
                        NewApp->>MSS: setActive(true)

                        MSS->>MSS: Change Active Session

                        CMS->>CMS: Call MediaSourceChangedListener
                        CMS->>UI: onMediaSourceChanged(Radio)

                        UI->>UI: Refresh media UI
                        UI->>NewApp: getMetadata()
                        NewApp-->>UI: MediaMetadata
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üîß Core API Details</h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üì°</span>
                        MediaSessionService API
                    </h3>
                    <div class="card-description">
                        <p><strong>Core Session Management API</strong></p>
                        <ul>
                            <li><code>getActiveSessions()</code>: Active session list</li>
                            <li><code>addOnActiveSessionsChangedListener()</code>: Detect active session changes</li>
                            <li><code>getSession2Tokens()</code>: Media3 session tokens</li>
                        </ul>
                        <p style="margin-top: 10px; color: var(--text-tertiary); font-size: 0.85rem;">
                            Permission: <code>MEDIA_CONTENT_CONTROL</code> required
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéÆ</span>
                        MediaController API
                    </h3>
                    <div class="card-description">
                        <p><strong>Session Control and State Receiving</strong></p>
                        <ul>
                            <li><code>getTransportControls()</code>: play/pause/stop</li>
                            <li><code>registerCallback()</code>: Receive state changes</li>
                            <li><code>getPlaybackState()</code>: Current playback state</li>
                            <li><code>getMetadata()</code>: Current media info</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üîî</span>
                        MediaController.Callback
                    </h3>
                    <div class="card-description">
                        <p><strong>Source Change Detection Callback</strong></p>
                        <ul>
                            <li><code>onSessionDestroyed()</code>: Session ended</li>
                            <li><code>onPlaybackStateChanged()</code>: Playback state changed</li>
                            <li><code>onMetadataChanged()</code>: Metadata changed</li>
                            <li><code>onQueueChanged()</code>: Queue changed</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üìû External Interrupt Handling (BT Call, Navigation, etc.)</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                When high-priority external interrupts like Bluetooth calls or navigation guidance occur, current media playback is paused or volume is reduced.
            </p>

            <div class="highlight-box">
                <strong>Audio Focus Priority:</strong> Android manages priority between audio streams through the audio focus system.
                <br/>Phone Call (USAGE_VOICE_COMMUNICATION) > Navigation (USAGE_ASSISTANCE_NAVIGATION_GUIDANCE) > Media (USAGE_MEDIA)
            </div>

            <h4 style="color: var(--text-primary); margin: 30px 0 15px 0;">üèóÔ∏è External Interrupt Architecture</h4>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph TB
                        subgraph INTERRUPT_SOURCES["Interrupt Sources"]
                            BT_CALL["üìû BT Call<br/>(Bluetooth HFP)"]
                            NAVI["üó∫Ô∏è Navigation<br/>(TBT Guidance)"]
                            ALARM["‚è∞ Alarm<br/>(System Alert)"]
                            ASSIST["üé§ Voice Assistant<br/>(Google Assistant)"]
                            NOTIF["üîî Notification<br/>(Ringtone)"]
                        end

                        subgraph AUDIO_SYSTEM["Android Audio System"]
                            AF_MGR["AudioFocusManager<br/>‚Ä¢ Focus Request/Release<br/>‚Ä¢ Priority Decision"]
                            AUDIO_POLICY["AudioPolicyService<br/>‚Ä¢ Ducking Policy<br/>‚Ä¢ Stream Routing"]
                            AUDIO_FLINGER["AudioFlinger<br/>‚Ä¢ Volume Control<br/>‚Ä¢ Mixing"]
                        end

                        subgraph MEDIA_APPS["Media Apps"]
                            PLAYER["ExoPlayer<br/>MediaSession"]
                            FOCUS_LISTENER["OnAudioFocusChangeListener"]
                        end

                        subgraph AAOS_LAYER["AAOS Layer (Optional)"]
                            CAR_AUDIO["CarAudioService<br/>‚Ä¢ Audio Zones<br/>‚Ä¢ Duck Policy"]
                            CAR_AUDIO_FOCUS["CarAudioFocus<br/>‚Ä¢ Per-Zone Focus Management"]
                        end

                        BT_CALL -->|requestAudioFocus<br/>USAGE_VOICE_COMMUNICATION| AF_MGR
                        NAVI -->|requestAudioFocus<br/>USAGE_ASSISTANCE_NAVIGATION| AF_MGR
                        ALARM -->|requestAudioFocus<br/>USAGE_ALARM| AF_MGR
                        ASSIST -->|requestAudioFocus<br/>USAGE_ASSISTANT| AF_MGR
                        NOTIF -->|requestAudioFocus<br/>USAGE_NOTIFICATION| AF_MGR

                        AF_MGR -->|AUDIOFOCUS_LOSS<br/>AUDIOFOCUS_LOSS_TRANSIENT<br/>AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK| FOCUS_LISTENER
                        AF_MGR --> AUDIO_POLICY
                        AUDIO_POLICY --> AUDIO_FLINGER

                        FOCUS_LISTENER -->|pause/duck| PLAYER

                        CAR_AUDIO --> AF_MGR
                        CAR_AUDIO_FOCUS --> CAR_AUDIO
                </div>
            </div>

            <h4 style="color: var(--text-primary); margin: 30px 0 15px 0;">üìä Audio Focus Type Behavior</h4>

            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <thead>
                    <tr style="background: var(--bg-tertiary);">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--accent-primary);">Focus Change</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--accent-primary);">Trigger Example</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--accent-primary);">Media App Response</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--accent-primary);">Recovery</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                        <td style="padding: 12px;"><code>AUDIOFOCUS_LOSS</code></td>
                        <td style="padding: 12px;">Another app starts long playback<br/>(YouTube Music launched)</td>
                        <td style="padding: 12px;"><strong>Stop playback</strong><br/>Release resources</td>
                        <td style="padding: 12px;">No auto recovery<br/>User restart required</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                        <td style="padding: 12px;"><code>AUDIOFOCUS_LOSS_TRANSIENT</code></td>
                        <td style="padding: 12px;"><strong>üìû BT Call incoming</strong><br/>Voice guidance</td>
                        <td style="padding: 12px;"><strong>Pause</strong><br/>Save state</td>
                        <td style="padding: 12px;"><strong>Auto resume</strong><br/>On AUDIOFOCUS_GAIN</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                        <td style="padding: 12px;"><code>AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK</code></td>
                        <td style="padding: 12px;"><strong>üó∫Ô∏è Navigation TBT</strong><br/>Notification sound</td>
                        <td style="padding: 12px;"><strong>Reduce volume (Duck)</strong><br/>Continue playback</td>
                        <td style="padding: 12px;"><strong>Restore volume</strong><br/>On AUDIOFOCUS_GAIN</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px;"><code>AUDIOFOCUS_GAIN</code></td>
                        <td style="padding: 12px;">Call ended<br/>Guidance complete</td>
                        <td style="padding: 12px;"><strong>Resume playback</strong><br/>Restore volume</td>
                        <td style="padding: 12px;">-</td>
                    </tr>
                </tbody>
            </table>

            <h4 style="color: var(--text-primary); margin: 30px 0 15px 0;">üìû BT Call Interrupt Detailed Flow</h4>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Complete flow where media playback is paused when a Bluetooth call is received and automatically resumed after the call ends.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                        autonumber
                        participant BT as Bluetooth HFP
                        participant Telecom as TelecomManager
                        participant AF as AudioFocusManager
                        participant Policy as AudioPolicyService
                        participant Player as MediaPlayer/ExoPlayer
                        participant MS as MediaSession
                        participant UI as Notification/UI

                        Note over BT,UI: üì± Media playing
                        Player->>AF: holdAudioFocus(USAGE_MEDIA)
                        Player->>MS: setPlaybackState(PLAYING)

                        Note over BT,UI: üìû BT Call incoming
                        BT->>Telecom: Incoming Call (HFP)
                        Telecom->>Telecom: Call State: RINGING

                        Telecom->>AF: requestAudioFocus(<br/>USAGE_VOICE_COMMUNICATION,<br/>AUDIOFOCUS_GAIN_TRANSIENT)

                        AF->>AF: Priority comparison<br/>VOICE > MEDIA

                        AF->>Player: onAudioFocusChange(<br/>AUDIOFOCUS_LOSS_TRANSIENT)

                        Note over Player: üîá Pause media
                        Player->>Player: pause()
                        Player->>Player: Save playback position
                        Player->>MS: setPlaybackState(PAUSED)
                        MS->>UI: onPlaybackStateChanged(PAUSED)

                        AF-->>Telecom: Focus Granted
                        Telecom->>BT: Audio Route to BT SCO

                        Note over BT,UI: üìû On call...
                        BT->>BT: Voice Communication Active

                        Note over BT,UI: üìû Call ended
                        BT->>Telecom: Call Ended (HFP)
                        Telecom->>Telecom: Call State: IDLE
                        Telecom->>AF: abandonAudioFocus()

                        AF->>Player: onAudioFocusChange(<br/>AUDIOFOCUS_GAIN)

                        Note over Player: ‚ñ∂Ô∏è Resume media
                        Player->>Player: play()
                        Player->>MS: setPlaybackState(PLAYING)
                        MS->>UI: onPlaybackStateChanged(PLAYING)
                </div>
            </div>

            <h4 style="color: var(--text-primary); margin: 30px 0 15px 0;">üó∫Ô∏è Navigation Ducking Flow</h4>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Flow where media volume is reduced (ducked) during navigation Turn-by-Turn (TBT) guidance and restored after guidance ends.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    sequenceDiagram
                        autonumber
                        participant Navi as Navigation App
                        participant AF as AudioFocusManager
                        participant Flinger as AudioFlinger
                        participant Player as MediaPlayer
                        participant MS as MediaSession

                        Note over Navi,MS: üéµ Media playing (Volume: 100%)
                        Player->>MS: setPlaybackState(PLAYING)

                        Note over Navi,MS: üó∫Ô∏è TBT guidance starts
                        Navi->>AF: requestAudioFocus(<br/>USAGE_ASSISTANCE_NAVIGATION_GUIDANCE,<br/>AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK)

                        AF->>Player: onAudioFocusChange(<br/>AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK)

                        Note over Player: üîâ Volume reduction (Duck)
                        alt Auto Ducking (Android 8.0+)
                            AF->>Flinger: setStreamVolume(MUSIC, 20%)
                            Note over Flinger: System auto ducking
                        else Manual Ducking (Legacy)
                            Player->>Player: setVolume(0.2f)
                            Note over Player: App-level ducking
                        end

                        Navi->>Navi: "Turn left in 300m"
                        Navi->>Navi: TTS Playback

                        Note over Navi,MS: üó∫Ô∏è TBT guidance ends
                        Navi->>AF: abandonAudioFocus()

                        AF->>Player: onAudioFocusChange(<br/>AUDIOFOCUS_GAIN)

                        Note over Player: üîä Volume restored (100%)
                        alt Auto Ducking
                            AF->>Flinger: setStreamVolume(MUSIC, 100%)
                        else Manual Ducking
                            Player->>Player: setVolume(1.0f)
                        end
                </div>
            </div>

            <h4 style="color: var(--text-primary); margin: 30px 0 15px 0;">üöó Interrupt Handling in AAOS</h4>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                In AAOS, CarAudioService applies additional audio policies.
            </p>

            <div class="mermaid-container">
                <div class="mermaid">
                    graph TB
                        subgraph AAOS_INTERRUPT["AAOS Interrupt Handling"]
                            subgraph ZONE_1["Primary Audio Zone (Driver)"]
                                MEDIA_Z1["Media<br/>(Music App)"]
                                CALL_Z1["Phone Call<br/>(BT HFP)"]
                                NAVI_Z1["Navigation<br/>(TBT)"]
                            end

                            subgraph ZONE_2["Secondary Audio Zone (Rear)"]
                                MEDIA_Z2["Media<br/>(Video App)"]
                                GAME_Z2["Game Audio"]
                            end

                            subgraph CAR_AUDIO["CarAudioService"]
                                FOCUS_MGR["CarAudioFocus<br/>‚Ä¢ Per-Zone Focus Management<br/>‚Ä¢ Cross-zone Policy"]
                                DUCK_POLICY["Duck Policy<br/>‚Ä¢ DUCK_MEDIA<br/>‚Ä¢ PAUSE_MEDIA<br/>‚Ä¢ MUTE_MEDIA"]
                                CONTEXT["Audio Context<br/>‚Ä¢ CALL<br/>‚Ä¢ NAVIGATION<br/>‚Ä¢ MUSIC"]
                            end
                        end

                        CALL_Z1 -->|Highest Priority| FOCUS_MGR
                        NAVI_Z1 -->|High Priority| FOCUS_MGR
                        MEDIA_Z1 -->|Normal Priority| FOCUS_MGR

                        FOCUS_MGR -->|Zone 1: Duck Media| DUCK_POLICY
                        FOCUS_MGR -->|Zone 2: No Change| MEDIA_Z2

                        DUCK_POLICY --> CONTEXT
                </div>
            </div>

            <div class="content-grid" style="margin-top: 20px;">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéØ</span>
                        Per-Zone Independent Processing
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Rear seat media unaffected during driver call</li>
                            <li>Independent Audio Focus per zone</li>
                            <li><code>CarAudioManager.getAudioZoneIds()</code></li>
                            <li>Cross-zone interrupt policy configurable</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìã</span>
                        Duck Policy Options
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li><code>DUCK_MEDIA</code>: Reduce volume (default)</li>
                            <li><code>PAUSE_MEDIA</code>: Pause</li>
                            <li><code>MUTE_MEDIA</code>: Mute</li>
                            <li>Configured in <code>car_audio_configuration.xml</code></li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">‚ö°</span>
                        Emergency Handling
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Emergency calls affect all zones</li>
                            <li><code>USAGE_EMERGENCY</code> highest priority</li>
                            <li>eCall (emergency call) system integration</li>
                            <li>Immediately mute all media</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h4 style="color: var(--text-primary); margin: 30px 0 15px 0;">üíª External Interrupt Handling Implementation</h4>

            <pre style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; overflow-x: auto; margin: 20px 0;"><code style="color: var(--text-primary); font-family: var(--font-mono);">// Audio focus listener implementation (handles BT Call, Navigation, etc.)
class MediaPlayerService : Service() {
    private lateinit var player: ExoPlayer
    private lateinit var audioManager: AudioManager
    private var playbackDelayed = false
    private var resumeOnFocusGain = false
    private var wasPlayingBeforeInterrupt = false

    // Audio focus request
    private val focusRequest = AudioFocusRequest.Builder(AudioManager.AUDIOFOCUS_GAIN)
        .setAudioAttributes(
            AudioAttributes.Builder()
                .setUsage(AudioAttributes.USAGE_MEDIA)
                .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
                .build()
        )
        .setAcceptsDelayedFocusGain(true)  // Allow delayed focus gain
        .setOnAudioFocusChangeListener(focusChangeListener)
        .build()

    // üìû Core: Audio focus change listener
    private val focusChangeListener = AudioManager.OnAudioFocusChangeListener { focusChange ->
        when (focusChange) {
            // üîá Complete loss - another app started long playback
            AudioManager.AUDIOFOCUS_LOSS -> {
                Log.d(TAG, "AUDIOFOCUS_LOSS - Stop playback")
                wasPlayingBeforeInterrupt = player.isPlaying
                player.pause()
                resumeOnFocusGain = false  // No auto resume
            }

            // ‚è∏Ô∏è Transient loss - BT Call, voice guidance, etc.
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -> {
                Log.d(TAG, "AUDIOFOCUS_LOSS_TRANSIENT - BT Call interrupt")
                wasPlayingBeforeInterrupt = player.isPlaying
                if (wasPlayingBeforeInterrupt) {
                    player.pause()
                    resumeOnFocusGain = true  // Auto resume after interrupt
                }
            }

            // üîâ Transient loss with duck - Navigation TBT, etc.
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK -> {
                Log.d(TAG, "AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK - Navigation")
                // Android 8.0+ handles auto ducking
                // Manual volume control if needed
                if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) {
                    player.volume = 0.2f  // Reduce to 20%
                }
                // Continue playback
            }

            // ‚ñ∂Ô∏è Focus gained - recovery after interrupt
            AudioManager.AUDIOFOCUS_GAIN -> {
                Log.d(TAG, "AUDIOFOCUS_GAIN - Focus recovered")

                // Restore volume
                player.volume = 1.0f

                // Resume if was paused
                if (resumeOnFocusGain && wasPlayingBeforeInterrupt) {
                    Log.d(TAG, "Interrupt ended, resuming playback")
                    player.play()
                    resumeOnFocusGain = false
                }

                // Handle delayed playback
                if (playbackDelayed) {
                    playbackDelayed = false
                    player.play()
                }
            }

            // Transient focus gain
            AudioManager.AUDIOFOCUS_GAIN_TRANSIENT,
            AudioManager.AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK -> {
                Log.d(TAG, "AUDIOFOCUS_GAIN_TRANSIENT")
                player.volume = 1.0f
                if (resumeOnFocusGain) {
                    player.play()
                    resumeOnFocusGain = false
                }
            }
        }
    }

    // Request focus when starting playback
    fun startPlayback() {
        val result = audioManager.requestAudioFocus(focusRequest)

        when (result) {
            AudioManager.AUDIOFOCUS_REQUEST_GRANTED -> {
                Log.d(TAG, "Focus granted, start playback")
                player.play()
            }
            AudioManager.AUDIOFOCUS_REQUEST_DELAYED -> {
                Log.d(TAG, "Focus delayed (on call, etc.), waiting")
                playbackDelayed = true
            }
            AudioManager.AUDIOFOCUS_REQUEST_FAILED -> {
                Log.d(TAG, "Focus request failed")
            }
        }
    }

    // Release focus when stopping playback
    fun stopPlayback() {
        player.stop()
        audioManager.abandonAudioFocusRequest(focusRequest)
    }
}</code></pre>

            <h4 style="color: var(--text-primary); margin: 20px 0 15px 0;">AAOS CarAudioFocus Handling</h4>

            <pre style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; overflow-x: auto; margin: 20px 0;"><code style="color: var(--text-primary); font-family: var(--font-mono);">// Audio focus handling in AAOS environment
class CarMediaPlayerService : Service() {
    private lateinit var car: Car
    private lateinit var carAudioManager: CarAudioManager

    override fun onCreate() {
        super.onCreate()
        car = Car.createCar(this)
        carAudioManager = car.getCarManager(Car.AUDIO_SERVICE) as CarAudioManager

        // Check current Audio Zone
        val zoneId = carAudioManager.getZoneIdForUid(Process.myUid())
        Log.d(TAG, "Current Audio Zone: $zoneId")

        // Check volume groups per zone
        val volumeGroupCount = carAudioManager.getVolumeGroupCount(zoneId)
        for (groupId in 0 until volumeGroupCount) {
            val volume = carAudioManager.getGroupVolume(zoneId, groupId)
            val maxVolume = carAudioManager.getGroupMaxVolume(zoneId, groupId)
            Log.d(TAG, "Zone $zoneId, Group $groupId: $volume / $maxVolume")
        }
    }

    // CarAudioFocus request (Zone-aware)
    fun requestCarAudioFocus(): Boolean {
        val audioAttributes = AudioAttributes.Builder()
            .setUsage(AudioAttributes.USAGE_MEDIA)
            .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)
            .build()

        // In AAOS, requests via AudioManager are
        // processed per-zone by CarAudioService
        val result = audioManager.requestAudioFocus(
            AudioFocusRequest.Builder(AudioManager.AUDIOFOCUS_GAIN)
                .setAudioAttributes(audioAttributes)
                .setOnAudioFocusChangeListener { focusChange ->
                    handleCarAudioFocusChange(focusChange)
                }
                .build()
        )

        return result == AudioManager.AUDIOFOCUS_REQUEST_GRANTED
    }

    private fun handleCarAudioFocusChange(focusChange: Int) {
        when (focusChange) {
            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -> {
                // In AAOS, behavior varies by Duck Policy
                // Check car_audio_configuration.xml settings
                Log.d(TAG, "AAOS: Focus loss transient (BT Call, etc.)")
                // Based on CarAudioService Duck Policy:
                // - DUCK_MEDIA: Only reduce volume (continue playback)
                // - PAUSE_MEDIA: Pause
                // - MUTE_MEDIA: Mute
                player.pause()  // Safe to pause
            }

            AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK -> {
                // Navigation TBT, etc.
                Log.d(TAG, "AAOS: Focus loss can duck (Navigation)")
                // AAOS supports auto ducking
                // No additional app processing needed
            }

            AudioManager.AUDIOFOCUS_GAIN -> {
                Log.d(TAG, "AAOS: Focus gained, resume playback")
                player.play()
            }
        }
    }
}</code></pre>

            <div class="highlight-box" style="margin-top: 30px;">
                <strong>üí° External Interrupt Debugging</strong>
                <pre style="margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;"><code># Track audio focus changes
adb logcat -s AudioManager:V AudioFocus:V | grep -i focus

# Check TelecomManager call state
adb shell dumpsys telecom | grep -E "state|Call"

# AAOS CarAudioService state
adb shell dumpsys car_service --services CarAudioService

# Bluetooth HFP connection status
adb shell dumpsys bluetooth_manager | grep -i hfp</code></pre>
            </div>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">üíª Implementation Examples</h3>

            <h4 style="color: var(--text-primary); margin: 20px 0 15px 0;">1. Detect Inter-App Session Switch (MediaController)</h4>
            <pre style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; overflow-x: auto; margin: 20px 0;"><code style="color: var(--text-primary); font-family: var(--font-mono);">// Detect active session changes via MediaSessionManager
val mediaSessionManager = getSystemService(Context.MEDIA_SESSION_SERVICE) as MediaSessionManager

// Active session change listener
val sessionListener = MediaSessionManager.OnActiveSessionsChangedListener { controllers ->
    if (controllers.isNullOrEmpty()) {
        Log.d(TAG, "No active sessions")
        return@OnActiveSessionsChangedListener
    }

    // Highest priority session (first one)
    val activeController = controllers[0]
    Log.d(TAG, "Active session changed: ${activeController.packageName}")

    // Register callback to new session
    activeController.registerCallback(object : MediaController.Callback() {
        override fun onPlaybackStateChanged(state: PlaybackState?) {
            Log.d(TAG, "Playback state: ${state?.state}")
        }

        override fun onMetadataChanged(metadata: MediaMetadata?) {
            val title = metadata?.getString(MediaMetadata.METADATA_KEY_TITLE)
            val artist = metadata?.getString(MediaMetadata.METADATA_KEY_ARTIST)
            Log.d(TAG, "Now playing: $title - $artist")
        }

        override fun onSessionDestroyed() {
            Log.d(TAG, "Session destroyed, waiting for new session")
        }
    })
}

// Register listener (requires MEDIA_CONTENT_CONTROL permission)
mediaSessionManager.addOnActiveSessionsChangedListener(
    sessionListener,
    ComponentName(this, NotificationListenerService::class.java)
)</code></pre>

            <h4 style="color: var(--text-primary); margin: 20px 0 15px 0;">2. ExoPlayer In-App Source Change</h4>
            <pre style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; overflow-x: auto; margin: 20px 0;"><code style="color: var(--text-primary); font-family: var(--font-mono);">// Create ExoPlayer instance and MediaSession
val player = ExoPlayer.Builder(context).build()

val mediaSession = MediaSession.Builder(context, player)
    .setSessionCallback(MySessionCallback())
    .build()

// Detect source transitions with Player.Listener
player.addListener(object : Player.Listener {
    override fun onMediaItemTransition(mediaItem: MediaItem?, reason: Int) {
        val reasonStr = when (reason) {
            Player.MEDIA_ITEM_TRANSITION_REASON_AUTO -> "AUTO (auto transition)"
            Player.MEDIA_ITEM_TRANSITION_REASON_SEEK -> "SEEK (user seek)"
            Player.MEDIA_ITEM_TRANSITION_REASON_PLAYLIST_CHANGED -> "PLAYLIST_CHANGED"
            Player.MEDIA_ITEM_TRANSITION_REASON_REPEAT -> "REPEAT"
            else -> "UNKNOWN"
        }
        Log.d(TAG, "Media item transition: ${mediaItem?.mediaId}, reason: $reasonStr")

        // MediaSession metadata is auto-updated by ExoPlayer
        // Set custom metadata if needed
        updateCustomMetadata(mediaItem)
    }

    override fun onPlaybackStateChanged(playbackState: Int) {
        val stateStr = when (playbackState) {
            Player.STATE_IDLE -> "IDLE"
            Player.STATE_BUFFERING -> "BUFFERING"
            Player.STATE_READY -> "READY"
            Player.STATE_ENDED -> "ENDED"
            else -> "UNKNOWN"
        }
        Log.d(TAG, "Playback state: $stateStr")
    }
})

// Programmatic source change
fun switchToNewSource(newUri: Uri) {
    val newMediaItem = MediaItem.Builder()
        .setUri(newUri)
        .setMediaMetadata(
            MediaMetadata.Builder()
                .setTitle("New Track Title")
                .setArtist("Artist Name")
                .build()
        )
        .build()

    // Replace currently playing source with new source
    player.setMediaItem(newMediaItem)
    player.prepare()
    player.play()
}

// Move to next track in playlist
fun playNextTrack() {
    if (player.hasNextMediaItem()) {
        player.seekToNextMediaItem()
    }
}</code></pre>

            <h4 style="color: var(--text-primary); margin: 20px 0 15px 0;">3. AAOS CarMediaManager Source Change</h4>
            <pre style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; overflow-x: auto; margin: 20px 0;"><code style="color: var(--text-primary); font-family: var(--font-mono);">// Get CarMediaManager
val car = Car.createCar(context)
val carMediaManager = car.getCarManager(Car.CAR_MEDIA_SERVICE) as CarMediaManager

// Query current media source
val currentSource = carMediaManager.getMediaSource(CarMediaManager.MEDIA_SOURCE_MODE_PLAYBACK)
Log.d(TAG, "Current source: ${currentSource?.packageName}")

// Register source change listener
carMediaManager.registerMediaSourceListener(
    object : CarMediaManager.MediaSourceChangedListener {
        override fun onMediaSourceChanged(componentName: ComponentName?) {
            Log.d(TAG, "===== MEDIA SOURCE CHANGED =====")
            Log.d(TAG, "New source: ${componentName?.flattenToShortString()}")
            Log.d(TAG, "Package: ${componentName?.packageName}")
            Log.d(TAG, "Class: ${componentName?.className}")

            // UI update or additional processing
            componentName?.let { updateMediaUI(it) }
        }
    }
)

// Programmatic source change
fun switchMediaSource(packageName: String, className: String) {
    val newSource = ComponentName(packageName, className)

    // MEDIA_SOURCE_MODE_PLAYBACK: Playback source
    // MEDIA_SOURCE_MODE_BROWSE: Browse source
    carMediaManager.setMediaSource(newSource, CarMediaManager.MEDIA_SOURCE_MODE_PLAYBACK)

    Log.d(TAG, "Requested source change to: ${newSource.flattenToShortString()}")
}

// Query last media source history
fun getRecentSources(): List<ComponentName> {
    return carMediaManager.getLastMediaSources(CarMediaManager.MEDIA_SOURCE_MODE_PLAYBACK)
}

// Example: Switch source to Spotify
switchMediaSource(
    "com.spotify.music",
    "com.spotify.music.MainActivity"
)</code></pre>

            <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0; font-size: 1.4rem;">‚ö†Ô∏è Source Change Considerations</h3>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üéß</span>
                        Audio Focus Handling
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Always request audio focus before source change</li>
                            <li>Stop playback on <code>AUDIOFOCUS_LOSS</code></li>
                            <li>Pause on <code>AUDIOFOCUS_LOSS_TRANSIENT</code></li>
                            <li>Reduce volume on <code>AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK</code></li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üíæ</span>
                        State Save/Restore
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Save current playback position before source change</li>
                            <li>AAOS CarMediaService auto-saves Last Media</li>
                            <li>Consider state persistence on app termination</li>
                            <li>Use SharedPreferences or Database</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">‚è±Ô∏è</span>
                        Transition Time Optimization
                    </h3>
                    <div class="card-description">
                        <ul>
                            <li>Minimize gaps during source change</li>
                            <li>Reduce transition time with pre-buffering</li>
                            <li>AAOS recommends transition within 5 seconds</li>
                            <li>Consider gapless playback support</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="highlight-box" style="margin-top: 30px;">
                <strong>üí° Debugging Tips</strong>
                <pre style="margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;"><code># Check active MediaSessions
adb shell dumpsys media_session

# Track AAOS media source changes
adb logcat -s CarMediaService:V | grep -E "setMediaSource|onMediaSourceChanged"

# Track audio focus changes
adb logcat -s AudioManager:V AudioFocus:V</code></pre>
            </div>
        </section>

        <!-- Section 14: Related Documentation -->
        <section class="content-section section">
            <h2 class="section-title">
                <span class="section-number">14</span>
                Related Documentation
            </h2>
            <p class="section-description">
                Navigate to other detailed documentation pages related to MediaSession.
            </p>

            <div class="content-grid">
                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üèóÔ∏è</span>
                        Media Framework Core
                    </h3>
                    <div class="card-description">
                        <p>Explains the overall architecture and layer structure of Android media framework.</p>
                        <ul style="margin-top: 10px;">
                            <li>Framework ‚Üí Native layer interaction</li>
                            <li>MediaPlayer, MediaRecorder API</li>
                            <li>Binder IPC communication</li>
                        </ul>
                        <a href="media-framework-core.html" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            View Details ‚Üí
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üé•</span>
                        Media Playback Pipeline
                    </h3>
                    <div class="card-description">
                        <p>Explains media playback pipeline, NuPlayer, and buffer management.</p>
                        <ul style="margin-top: 10px;">
                            <li>NuPlayer architecture</li>
                            <li>Buffer management and Zero-Copy</li>
                            <li>PTS-based A/V Sync</li>
                        </ul>
                        <a href="media-playback.html" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            View Details ‚Üí
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üîä</span>
                        Audio Framework
                    </h3>
                    <div class="card-description">
                        <p>Covers the audio stack including AudioFlinger and AudioPolicyService.</p>
                        <ul style="margin-top: 10px;">
                            <li>AudioTrack/AudioRecord API</li>
                            <li>AudioFlinger mixing pipeline</li>
                            <li>Audio routing policy</li>
                        </ul>
                        <a href="audio-framework.html" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            View Details ‚Üí
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üöó</span>
                        Car Media Service
                    </h3>
                    <div class="card-description">
                        <p>Explains Android Automotive's Car Media Service and MediaSession integration.</p>
                        <ul style="margin-top: 10px;">
                            <li>CarMediaService architecture</li>
                            <li>MediaSession priority</li>
                            <li>Last Media & Autoplay</li>
                        </ul>
                        <a href="carmedia.html" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            View Details ‚Üí
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üìÅ</span>
                        MediaProvider
                    </h3>
                    <div class="card-description">
                        <p>Explains media storage access, MediaStore, and Scoped Storage.</p>
                        <ul style="margin-top: 10px;">
                            <li>MediaStore API</li>
                            <li>Scoped Storage mechanism</li>
                            <li>FUSE Passthrough</li>
                        </ul>
                        <a href="mediaprovider.html" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            View Details ‚Üí
                        </a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <span class="card-icon">üì±</span>
                        Media App Layer
                    </h3>
                    <div class="card-description">
                        <p>Compares app layer APIs like MediaPlayer, ExoPlayer, and Media3.</p>
                        <ul style="margin-top: 10px;">
                            <li>MediaPlayer vs ExoPlayer</li>
                            <li>Media3 integrated library</li>
                            <li>Best Practices</li>
                        </ul>
                        <a href="media-app-layer.html" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem;">
                            View Details ‚Üí
                        </a>
                    </div>
                </div>
            </div>

            <div class="highlight-box" style="margin-top: 40px;">
                <h3 style="color: var(--accent-primary); font-size: 1.2rem; margin-bottom: 15px;">
                    üìö Additional Learning Resources
                </h3>
                <ul style="padding-left: 20px;">
                    <li><strong>Android Developer - MediaSession</strong>: <a href="https://developer.android.com/guide/topics/media-apps/working-with-a-media-session" target="_blank" style="color: var(--accent-primary);">developer.android.com/guide/topics/media-apps</a></li>
                    <li><strong>Media3 Official Documentation</strong>: <a href="https://developer.android.com/jetpack/androidx/releases/media3" target="_blank" style="color: var(--accent-primary);">androidx.media3</a></li>
                    <li><strong>Android Auto Developer Guide</strong>: <a href="https://developer.android.com/training/cars/media" target="_blank" style="color: var(--accent-primary);">developer.android.com/training/cars/media</a></li>
                    <li><strong>Universal Android Music Player (UAMP) Sample</strong>: <a href="https://github.com/android/uamp" target="_blank" style="color: var(--accent-primary);">github.com/android/uamp</a></li>
                </ul>
            </div>
        </section>

        <!-- Footer -->
        <footer
            style="text-align: center; padding: 40px 20px; color: var(--text-muted); border-top: 1px solid var(--border-color); margin-top: 60px;">
            <p>Android MediaSession Framework</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                Unified Media Playback Control Framework
            </p>
            <div style="margin-top: 25px; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <a href="mediasession-api.html"
                    style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(0, 212, 255, 0.2)); border: 2px solid #f97316; border-radius: 12px; color: #f97316; text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;">
                    MediaSession API Flow ‚Üí
                </a>
                <a href="index.html"
                    style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: rgba(26, 31, 53, 0.5); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); text-decoration: none; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;">
                    ‚Üê AOSP Media Framework
                </a>
            </div>
        </footer>
    </div>

    <script src="../scripts/mermaid-theme.js"></script>
    <script>
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.section').forEach(section => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(30px)';
            section.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            observer.observe(section);
        });
    </script>
    <!-- Navigation & Copy Features -->
    <script src="../scripts/copy-code.js"></script>
    <script src="../scripts/toc-generator.js"></script>
    <script src="../scripts/page-navigation.js"></script>
    <!-- Interactive Diagram Features -->
    <script src="../scripts/diagram-data.js"></script>
    <script src="../scripts/diagram-data-en-partial.js"></script>
    <script src="../scripts/diagram-interactive.js"></script>

    <script src="../scripts/theme-toggle.js"></script>
    <script src="../scripts/lang-switch.js"></script>
</body>

</html>
