<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Extension Development Guide - Android Media Framework</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;900&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/design-system.css">
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-button">
            ← Android Media Framework
        </a>
    </nav>
    <div class="container">
        <header>
            <h1 class="page-title">Vendor Extension Development Guide</h1>
            <p class="page-subtitle">Media stack extension methods for OEM/SoC vendors</p>
        </header>

        <!-- Section 1: Overview -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">01</span>Overview</h2>

            <p>The Android media framework is designed with an <strong>extensible architecture</strong>. SoC vendors and OEMs can add their own codecs, formats, and features while maintaining standard interfaces.</p>

            <h3>1.1 Extensible Areas</h3>
            <div class="mermaid">
flowchart TB
    subgraph APP["App Layer"]
        A1[Third-party Apps]
        A2[System Apps]
    end

    subgraph FW["Framework - AOSP"]
        F1[MediaCodec API]
        F2[MediaExtractor API]
        F3[AudioManager]
    end

    subgraph VENDOR["Vendor Extension"]
        V1[Custom Codec Plugin]
        V2[Custom Extractor]
        V3[Vendor HAL Extension]
    end

    subgraph HAL["HAL Layer"]
        H1[Codec2 HAL]
        H2[Audio HAL]
    end

    subgraph HW["Hardware"]
        HW1[HW Codec IP]
        HW2[DSP]
    end

    A1 --> F1
    A2 --> F1
    F1 --> V1
    F2 --> V2
    V1 --> H1
    V2 --> H1
    V3 --> H1
    V3 --> H2
    H1 --> HW1
    H2 --> HW2

            </div>

            <h3>1.2 Extension Types</h3>
            <table>
                <thead>
                    <tr>
                        <th>Extension Type</th>
                        <th>Purpose</th>
                        <th>Difficulty</th>
                        <th>VTS Required</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Codec2 Plugin</strong></td>
                        <td>Register custom HW codec</td>
                        <td>High</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><strong>Custom Extractor</strong></td>
                        <td>Support proprietary container formats</td>
                        <td>Medium</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><strong>HAL Extension</strong></td>
                        <td>Extend HIDL/AIDL interfaces</td>
                        <td>High</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><strong>Vendor Service</strong></td>
                        <td>Independent media service</td>
                        <td>Medium</td>
                        <td>No</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box warning">
                <strong>Note: Treble Compatibility</strong>
                <p>All Vendor Extensions must comply with the <strong>Treble architecture</strong>. Maintain separation between Framework partition (system) and Vendor partition.</p>
            </div>
        </section>

        <!-- Section 2: HAL Extension -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">02</span>HAL Interface Extension</h2>

            <h3>2.1 AIDL vs HIDL</h3>
            <table>
                <thead>
                    <tr>
                        <th>Characteristic</th>
                        <th>HIDL (Legacy)</th>
                        <th>AIDL (Android 12+)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Recommended Version</strong></td>
                        <td>Android 8~11</td>
                        <td>Android 12+</td>
                    </tr>
                    <tr>
                        <td><strong>Performance</strong></td>
                        <td>Good</td>
                        <td>Better (optimized)</td>
                    </tr>
                    <tr>
                        <td><strong>Syntax</strong></td>
                        <td>.hal files</td>
                        <td>.aidl files</td>
                    </tr>
                    <tr>
                        <td><strong>New Development</strong></td>
                        <td>Not recommended</td>
                        <td>Recommended</td>
                    </tr>
                </tbody>
            </table>

            <h3>2.2 AIDL HAL Extension Example</h3>
            <pre><code>// hardware/interfaces/media/c2/aidl/vendor/
// android/hardware/media/c2/IVendorComponent.aidl

package android.hardware.media.c2;

import android.hardware.media.c2.IComponent;

@VintfStability
interface IVendorComponent extends IComponent {
    /**
     * Apply vendor-specific settings
     * @param key Setting key
     * @param value Setting value
     */
    void setVendorParameter(in String key, in ParcelableHolder value);

    /**
     * Query vendor-specific settings
     */
    ParcelableHolder getVendorParameter(in String key);

    /**
     * Enable HW acceleration feature
     */
    void enableHardwareAcceleration(in HwAccelConfig config);
}

@VintfStability
parcelable HwAccelConfig {
    boolean useGpuPostProcessing;
    boolean enableLowLatencyMode;
    int maxConcurrentInstances;
}</code></pre>

            <h3>2.3 VINTF Manifest Registration</h3>
            <pre><code>&lt;!-- device/vendor/manifest.xml --&gt;
&lt;manifest version="2.0" type="device"&gt;
    &lt;hal format="aidl"&gt;
        &lt;name&gt;android.hardware.media.c2&lt;/name&gt;
        &lt;version&gt;1&lt;/version&gt;
        &lt;fqname&gt;IComponentStore/vendor&lt;/fqname&gt;
    &lt;/hal&gt;

    &lt;!-- Vendor Extension --&gt;
    &lt;hal format="aidl"&gt;
        &lt;name&gt;vendor.hardware.media.c2&lt;/name&gt;
        &lt;version&gt;1&lt;/version&gt;
        &lt;fqname&gt;IVendorComponent/default&lt;/fqname&gt;
    &lt;/hal&gt;
&lt;/manifest&gt;</code></pre>
        </section>

        <!-- Section 3: Codec2 Plugin -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">03</span>Codec2 Plugin Development</h2>

            <h3>3.1 Plugin Architecture</h3>
            <div class="mermaid">
flowchart TB
    subgraph FW["Framework"]
        MC[MediaCodec]
    end

    subgraph C2["Codec2 Framework"]
        CS[C2ComponentStore]
        CF[C2ComponentFactory]
    end

    subgraph PLUGIN["Vendor Plugin"]
        VP[VendorPlugin.so]
        VC[VendorCodecComponent]
    end

    subgraph HAL["HAL"]
        CH[Codec2 HAL Service]
    end

    MC --> CS
    CS -->|loadPlugin| VP
    VP --> CF
    CF -->|create| VC
    VC --> CH
            </div>

            <h3>3.2 Plugin Implementation</h3>
            <pre><code>// vendor/lib/libvendor_c2_plugin.so

#include &lt;C2Component.h&gt;
#include &lt;C2ComponentFactory.h&gt;

namespace vendor {
namespace c2 {

// Codec component implementation
class VendorAvcDecoder : public C2Component {
public:
    static std::shared_ptr&lt;C2Component&gt; Create(
            c2_node_id_t id,
            const std::shared_ptr&lt;C2ReflectorHelper&gt;&amp; helper) {
        return std::make_shared&lt;VendorAvcDecoder&gt;(id, helper);
    }

    c2_status_t queue_nb(std::list&lt;std::unique_ptr&lt;C2Work&gt;&gt;* work) override {
        // Queue decoding work
        for (auto&amp; w : *work) {
            processWork(std::move(w));
        }
        return C2_OK;
    }

private:
    void processWork(std::unique_ptr&lt;C2Work&gt; work) {
        // Call HW decoder
        // ...
    }
};

// Factory implementation
class VendorCodecFactory : public C2ComponentFactory {
public:
    c2_status_t createComponent(
            c2_node_id_t id,
            std::shared_ptr&lt;C2Component&gt;* component,
            ComponentDeleter deleter) override {
        *component = VendorAvcDecoder::Create(id, mHelper);
        return C2_OK;
    }

    c2_status_t createInterface(
            c2_node_id_t id,
            std::shared_ptr&lt;C2ComponentInterface&gt;* interface,
            InterfaceDeleter deleter) override {
        // Create interface
        return C2_OK;
    }
};

}  // namespace c2
}  // namespace vendor

// Plugin entry point
extern "C" ::C2ComponentFactory* CreateCodec2Factory() {
    return new vendor::c2::VendorCodecFactory();
}

extern "C" void DestroyCodec2Factory(::C2ComponentFactory* factory) {
    delete factory;
}</code></pre>

            <h3>3.3 media_codecs.xml Registration</h3>
            <pre><code>&lt;!-- vendor/etc/media_codecs.xml --&gt;
&lt;MediaCodecs&gt;
    &lt;Decoders&gt;
        &lt;!-- Vendor HW AVC Decoder --&gt;
        &lt;MediaCodec name="c2.vendor.avc.decoder"
                    type="video/avc"
                    rank="0"&gt;  &lt;!-- rank 0 = highest priority --&gt;
            &lt;Limit name="size" min="16x16" max="4096x2160" /&gt;
            &lt;Limit name="alignment" value="2x2" /&gt;
            &lt;Limit name="block-size" value="16x16" /&gt;
            &lt;Limit name="bitrate" range="1-120000000" /&gt;
            &lt;Feature name="adaptive-playback" /&gt;
            &lt;Feature name="secure-playback" required="true" /&gt;
            &lt;Attribute name="software-codec" value="false" /&gt;
        &lt;/MediaCodec&gt;

        &lt;!-- Vendor HW HEVC Decoder --&gt;
        &lt;MediaCodec name="c2.vendor.hevc.decoder"
                    type="video/hevc"
                    rank="0"&gt;
            &lt;Limit name="size" min="16x16" max="8192x4320" /&gt;
            &lt;Limit name="bitrate" range="1-160000000" /&gt;
            &lt;Feature name="adaptive-playback" /&gt;
        &lt;/MediaCodec&gt;
    &lt;/Decoders&gt;

    &lt;Encoders&gt;
        &lt;MediaCodec name="c2.vendor.avc.encoder"
                    type="video/avc"
                    rank="0"&gt;
            &lt;Limit name="size" min="16x16" max="4096x2160" /&gt;
            &lt;Limit name="bitrate" range="1-80000000" /&gt;
        &lt;/MediaCodec&gt;
    &lt;/Encoders&gt;
&lt;/MediaCodecs&gt;</code></pre>
        </section>

        <!-- Section 4: Custom Extractor -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">04</span>Custom Extractor Development</h2>

            <h3>4.1 Extractor Plugin Structure</h3>
            <pre><code>// vendor/lib/extractors/libvendor_extractor.so

#include &lt;media/MediaExtractorPluginApi.h&gt;
#include &lt;media/MediaExtractorPluginHelper.h&gt;

namespace vendor {

class VendorExtractor : public MediaExtractorPluginHelper {
public:
    explicit VendorExtractor(DataSourceHelper* source)
        : mDataSource(source) {
        parseHeader();
    }

    size_t countTracks() override {
        return mTracks.size();
    }

    MediaTrackHelper* getTrack(size_t index) override {
        if (index >= mTracks.size()) return nullptr;
        return new VendorMediaTrack(mTracks[index]);
    }

    media_status_t getTrackMetaData(
            AMediaFormat* meta,
            size_t index,
            uint32_t flags) override {
        if (index >= mTracks.size()) {
            return AMEDIA_ERROR_UNKNOWN;
        }
        return mTracks[index].fillMetaData(meta);
    }

    media_status_t getMetaData(AMediaFormat* meta) override {
        AMediaFormat_setString(meta, AMEDIAFORMAT_KEY_MIME,
                              "video/x-vendor-container");
        AMediaFormat_setInt64(meta, AMEDIAFORMAT_KEY_DURATION,
                             mDurationUs);
        return AMEDIA_OK;
    }

private:
    void parseHeader() {
        // Parse container header
        // Extract track information
    }

    DataSourceHelper* mDataSource;
    std::vector&lt;TrackInfo&gt; mTracks;
    int64_t mDurationUs;
};

}  // namespace vendor

// Plugin entry point
extern "C" {

__attribute__((visibility("default")))
ExtractorDef GETEXTRACTORDEF() {
    return {
        .def_version = EXTRACTORDEF_VERSION,
        .uuid = {
            0x12, 0x34, 0x56, 0x78,
            0x9a, 0xbc, 0xde, 0xf0,
            0x11, 0x22, 0x33, 0x44,
            0x55, 0x66, 0x77, 0x88
        },
        .version = 1,
        .name = "Vendor Container Extractor",
        .sniff = [](
                DataSourceHelper* source,
                float* confidence,
                void**,
                FreeMetaFunc*) -> CreatorFunc {
            // Check file signature
            uint8_t header[4];
            if (source->readAt(0, header, 4) != 4) {
                return nullptr;
            }

            // Check "VNDR" magic number
            if (memcmp(header, "VNDR", 4) == 0) {
                *confidence = 0.9f;
                return [](DataSourceHelper* source,
                          void*) -> CMediaExtractor* {
                    return wrap(new vendor::VendorExtractor(source));
                };
            }
            return nullptr;
        }
    };
}

}  // extern "C"</code></pre>

            <h3>4.2 Extractor Registration</h3>
            <pre><code>&lt;!-- vendor/etc/media_codecs.xml or separate config --&gt;
&lt;!-- Android.bp build configuration --&gt;

// vendor/media/extractors/Android.bp
cc_library_shared {
    name: "libvendor_extractor",
    vendor: true,

    srcs: [
        "VendorExtractor.cpp",
        "VendorMediaTrack.cpp",
    ],

    shared_libs: [
        "liblog",
        "libmediandk",
        "libstagefright_foundation",
    ],

    cflags: [
        "-Werror",
        "-Wall",
    ],

    // Install in extractor plugin directory
    relative_install_path: "extractors",
}</code></pre>
        </section>

        <!-- Section 5: Vendor Partition -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">05</span>Vendor Partition Structure</h2>

            <h3>5.1 File Placement</h3>
            <pre><code>/vendor/
├── bin/
│   └── hw/
│       └── android.hardware.media.c2@1.0-service-vendor
├── etc/
│   ├── media_codecs.xml
│   ├── media_codecs_performance.xml
│   └── vintf/
│       └── manifest.xml
├── lib/
│   ├── libvendor_c2_plugin.so
│   └── extractors/
│       └── libvendor_extractor.so
└── lib64/
    ├── libvendor_c2_plugin.so
    └── extractors/
        └── libvendor_extractor.so</code></pre>

            <h3>5.2 SELinux Policy</h3>
            <pre><code># vendor/sepolicy/file_contexts
/vendor/bin/hw/android\.hardware\.media\.c2@1\.0-service-vendor u:object_r:hal_codec2_default_exec:s0
/vendor/lib(64)?/libvendor_c2_plugin\.so u:object_r:same_process_hal_file:s0
/vendor/lib(64)?/extractors/libvendor_extractor\.so u:object_r:same_process_hal_file:s0

# vendor/sepolicy/hal_codec2_default.te
# Add necessary permissions
allow hal_codec2_default vendor_media_data_file:file { read write };
allow hal_codec2_default gpu_device:chr_file { read write ioctl };</code></pre>

            <h3>5.3 Init Script</h3>
            <pre><code># vendor/etc/init/android.hardware.media.c2@1.0-service-vendor.rc
service vendor-media-c2-hal /vendor/bin/hw/android.hardware.media.c2@1.0-service-vendor
    class hal
    user mediacodec
    group camera drmrpc mediadrm
    ioprio rt 4
    capabilities SYS_NICE
    writepid /dev/cpuset/foreground/tasks</code></pre>
        </section>

        <!-- Section 6: VTS Testing -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">06</span>VTS Pass Strategy</h2>

            <h3>6.1 Required VTS Tests</h3>
            <table>
                <thead>
                    <tr>
                        <th>Test Module</th>
                        <th>Verification Items</th>
                        <th>Importance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>VtsHalMediaC2V1_0TargetTest</code></td>
                        <td>Codec2 HAL interface compliance</td>
                        <td>Required</td>
                    </tr>
                    <tr>
                        <td><code>VtsHalMediaOmxV1_0TargetTest</code></td>
                        <td>OMX HAL (legacy compatibility)</td>
                        <td>Optional</td>
                    </tr>
                    <tr>
                        <td><code>VtsVndkDependency</code></td>
                        <td>VNDK dependency verification</td>
                        <td>Required</td>
                    </tr>
                    <tr>
                        <td><code>VtsTrebleVintfTest</code></td>
                        <td>VINTF manifest verification</td>
                        <td>Required</td>
                    </tr>
                </tbody>
            </table>

            <h3>6.2 VTS Execution</h3>
            <pre><code># Run VTS test
atest VtsHalMediaC2V1_0TargetTest

# Run specific test only
atest VtsHalMediaC2V1_0TargetTest:DecodeTest

# Full media VTS
vts-tradefed run commandAndExit vts \
    --module VtsHalMediaC2V1_0TargetTest \
    --module VtsHalMediaOmxV1_0TargetTest

# Check logs
adb logcat -s VtsHalMediaC2</code></pre>

            <h3>6.3 Common VTS Failure Causes</h3>
            <div class="info-box warning">
                <strong>VTS Failure Checklist</strong>
                <ul>
                    <li><strong>VINTF mismatch</strong>: Mismatch between manifest.xml and actual HAL service</li>
                    <li><strong>SELinux denial</strong>: Missing required permissions</li>
                    <li><strong>Buffer format</strong>: Returning unsupported pixel format</li>
                    <li><strong>Timeout</strong>: Response time exceeded (default 5 seconds)</li>
                    <li><strong>Memory leak</strong>: Missing resource release</li>
                </ul>
            </div>
        </section>

        <!-- Section 7: Practical Cases -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">07</span>Practical Extension Cases</h2>

            <h3>Case 1: Proprietary HDR Format Support</h3>
            <div class="case-study">
                <h4>Requirements</h4>
                <p>Process vendor-specific HDR metadata format in existing HEVC decoder</p>

                <h4>Implementation Method</h4>
                <ol>
                    <li>Define custom HDR parameter with C2Param extension</li>
                    <li>Parse parameter in Codec2 component</li>
                    <li>Pass to HW through HAL</li>
                </ol>

                <pre><code>// Custom HDR parameter
struct C2VendorHdrMetadata : public C2Param {
    uint32_t vendorHdrType;
    uint8_t metadata[256];

    DEFINE_AND_DESCRIBE_C2PARAM(
        C2VendorHdrMetadata,
        0x80000001 | C2Param::PARAM_KIND_INPUT
    );
};</code></pre>
            </div>

            <h3>Case 2: Low Latency Encoding Mode</h3>
            <div class="case-study">
                <h4>Requirements</h4>
                <p>Encoding latency under 20ms for real-time streaming</p>

                <h4>Implementation Method</h4>
                <ol>
                    <li>Add low latency mode flag via HAL Extension</li>
                    <li>Optimize HW encoder settings (1-frame buffer)</li>
                    <li>Register with separate codec name (c2.vendor.avc.encoder.lowlatency)</li>
                </ol>
            </div>

            <h3>Case 3: Multi-instance Optimization</h3>
            <div class="case-study">
                <h4>Requirements</h4>
                <p>Simultaneous 4-stream decoding (vehicle surround view)</p>

                <h4>Implementation Method</h4>
                <ol>
                    <li>Instance pool management in C2ComponentStore</li>
                    <li>Dynamic HW resource allocation</li>
                    <li>Priority-based scheduling</li>
                </ol>
            </div>
        </section>

        <!-- Section 8: Checklist -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">08</span>Development Checklist</h2>

            <h3>HAL Development</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Define AIDL/HIDL interface</li>
                <li><input type="checkbox"> Register VINTF manifest</li>
                <li><input type="checkbox"> Add SELinux policy</li>
                <li><input type="checkbox"> Write init script</li>
            </ul>

            <h3>Codec Development</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Implement C2Component</li>
                <li><input type="checkbox"> Implement C2ComponentFactory</li>
                <li><input type="checkbox"> Register in media_codecs.xml</li>
                <li><input type="checkbox"> Write performance XML</li>
            </ul>

            <h3>Testing</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Pass VTS tests</li>
                <li><input type="checkbox"> Pass CTS media tests</li>
                <li><input type="checkbox"> Memory leak testing</li>
                <li><input type="checkbox"> Stress testing</li>
            </ul>

            <h3>Documentation</h3>
            <ul class="checklist">
                <li><input type="checkbox"> API documentation</li>
                <li><input type="checkbox"> Integration guide</li>
                <li><input type="checkbox"> Release notes</li>
            </ul>
        </section>

        <!-- Related Documents -->
        <section class="content-section section">
            <h2 class="section-title"><span class="section-number">09</span>Related Documents</h2>
            <ul>
                <li><a href="codec2.html">Codec 2.0 & Media HAL</a> - Codec2 architecture details</li>
                <li><a href="media-extractor.html">MediaExtractor & Container</a> - Extractor structure</li>
                <li><a href="media-porting-checklist.html">Media Stack Porting Checklist</a> - Complete porting guide</li>
                <li><a href="cts.html">CTS / VTS / GTS</a> - Test suite guide</li>
            </ul>
        </section>
    </div>

    <script src="../scripts/mermaid-theme.js"></script>
    <script src="../scripts/copy-code.js"></script>
    <script src="../scripts/toc-generator.js"></script>
    <script src="../scripts/page-navigation.js"></script>
    <script src="../scripts/diagram-data.js"></script>
    <script src="../scripts/diagram-data-en-partial.js"></script>
    <script src="../scripts/diagram-interactive.js"></script>
    <script src="../scripts/theme-toggle.js"></script>
    <script src="../scripts/lang-switch.js"></script>
</body>

</html>
