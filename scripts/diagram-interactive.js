/**
 * Diagram Interactive - Mermaid ë‹¤ì´ì–´ê·¸ë¨ ì¸í„°ë™í‹°ë¸Œ ê¸°ëŠ¥
 * ë…¸ë“œ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ ë° í˜¸ë²„ íˆ´íŒ ê¸°ëŠ¥ ì œê³µ
 */

/**
 * ë””ë²„ê·¸ ëª¨ë“œ ì„¤ì •
 * - localhost, 127.0.0.1, ë˜ëŠ” íŒŒì¼ í”„ë¡œí† ì½œì—ì„œ console.log í™œì„±í™”
 * - í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹ˆ í•¨ìˆ˜ë¡œ ëŒ€ì²´í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”
 */
const DEBUG = (function() {
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    return hostname === 'localhost' ||
           hostname === '127.0.0.1' ||
           hostname === '' ||
           protocol === 'file:';
})();
const log = DEBUG ? console.log.bind(console) : () => {};
const warn = DEBUG ? console.warn.bind(console) : () => {};

/**
 * iOS standalone ëª¨ë“œ ê°ì§€ (í™ˆ í™”ë©´ì— ì¶”ê°€ëœ ì›¹ì•±)
 */
const isIOSStandalone = (function() {
    return ('standalone' in window.navigator) && window.navigator.standalone === true;
})();

/**
 * í„°ì¹˜ ë””ë°”ì´ìŠ¤ ê°ì§€
 */
const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

/**
 * í˜„ì¬ ì–¸ì–´ ê°ì§€
 */
function getCurrentLanguage() {
    const path = window.location.pathname;
    return path.startsWith('/en/') || path === '/en' ? 'en' : 'ko';
}

/**
 * ì–¸ì–´ë³„ fallback ë©”ì‹œì§€
 */
const FALLBACK_MESSAGES = {
    ko: {
        noData: 'ì´ ë…¸ë“œì— ëŒ€í•œ ìƒì„¸ ì •ë³´ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
        title: 'ì •ë³´ ì—†ìŒ',
        description: 'ìƒì„¸ ì •ë³´ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'
    },
    en: {
        noData: 'Detailed information for this node is not yet available.',
        title: 'No Information',
        description: 'Detailed information is being prepared.'
    }
};

/**
 * ì–¸ì–´ë³„ UI í…ìŠ¤íŠ¸
 */
const UI_TEXTS = {
    ko: {
        // ëª¨ë‹¬
        close: 'ë‹«ê¸°',
        autoGenerated: 'ìë™ ìƒì„±',
        autoGeneratedInfo: 'â„¹ï¸ ì´ ì •ë³´ëŠ” ë‹¤ì´ì–´ê·¸ë¨ì—ì„œ ìë™ìœ¼ë¡œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ë” ìƒì„¸í•œ ì •ë³´ê°€ ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.',

        // ì„¹ì…˜ ì œëª©
        components: 'ì£¼ìš” ì»´í¬ë„ŒíŠ¸',
        codeExample: 'ì½”ë“œ ì˜ˆì œ',
        relatedIssues: 'ê´€ë ¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…',
        aosp_path: 'AOSP ê²½ë¡œ',

        // ë²„íŠ¼
        viewDocs: 'ë¬¸ì„œ ë³´ê¸°',
        viewSource: 'AOSP ì†ŒìŠ¤',

        // íˆ´íŒ
        clickForDetails: 'í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸° â†’'
    },
    en: {
        // Modal
        close: 'Close',
        autoGenerated: 'Auto-generated',
        autoGeneratedInfo: 'â„¹ï¸ This information was automatically extracted from the diagram. More detailed information will be added soon.',

        // Section titles
        components: 'Key Components',
        codeExample: 'Code Example',
        relatedIssues: 'Related Troubleshooting',
        aosp_path: 'AOSP Path',

        // Buttons
        viewDocs: 'View Documentation',
        viewSource: 'View AOSP Source',

        // Tooltip
        clickForDetails: 'Click for details â†’'
    }
};

// ì „ì—­ ë³€ìˆ˜
let activeModal = null;
let activeTooltip = null;
const currentLang = getCurrentLanguage();

/**
 * ì–¸ì–´ë³„ ë‹¤ì´ì–´ê·¸ë¨ ë°ì´í„° ì„ íƒ
 */
function getDiagramData() {
    if (currentLang === 'en') {
        // ì˜ë¬¸ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ í•œê¸€ fallback
        return typeof DIAGRAM_NODE_DATA_EN !== 'undefined'
            ? DIAGRAM_NODE_DATA_EN
            : DIAGRAM_NODE_DATA;
    }

    return DIAGRAM_NODE_DATA;
}

/**
 * Mermaid ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°
 * - ëª¨ë°”ì¼: 2.5ì´ˆ ëŒ€ê¸° (ë Œë”ë§ ëŠë¦¼)
 * - ë°ìŠ¤í¬í†±: 1.5ì´ˆ ëŒ€ê¸°
 * - SVGê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰í•˜ë˜ ì•ˆì •í™” ë”œë ˆì´ ì ìš©
 */
function waitForMermaidRender() {
    return new Promise((resolve) => {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const BASE_DELAY = isMobile ? 2500 : 1500; // ëª¨ë°”ì¼ì€ ë” ê¸´ ëŒ€ê¸° ì‹œê°„
        const STABILIZATION_DELAY = isMobile ? 800 : 500; // ì•ˆì •í™” ë”œë ˆì´

        log(`ğŸ“± ë””ë°”ì´ìŠ¤: ${isMobile ? 'ëª¨ë°”ì¼' : 'ë°ìŠ¤í¬í†±'}, ëŒ€ê¸°ì‹œê°„: ${BASE_DELAY}ms`);

        // ì´ë¯¸ Mermaid SVGê°€ ë Œë”ë§ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        const existingSvgs = document.querySelectorAll('.mermaid svg');
        if (existingSvgs.length > 0) {
            log('âœ… Mermaid SVG ì´ë¯¸ ë Œë”ë§ë¨, ì•ˆì •í™” ëŒ€ê¸° ì¤‘...');
            setTimeout(() => {
                log('âœ… ì•ˆì •í™” ë”œë ˆì´ ì™„ë£Œ');
                resolve();
            }, STABILIZATION_DELAY);
            return;
        }

        // SVGê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ëŒ€ê¸° ì‹œê°„ ì ìš©
        log('â³ Mermaid SVG ëŒ€ê¸° ì¤‘...');
        setTimeout(() => {
            const svgs = document.querySelectorAll('.mermaid svg');
            if (svgs.length > 0) {
                log('âœ… Mermaid SVG ë Œë”ë§ ì™„ë£Œ');
            } else {
                warn('âš ï¸ Mermaid SVGë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            resolve();
        }, BASE_DELAY);
    });
}

// DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    log('ğŸš€ diagram-interactive.js ë¡œë“œë¨!');
    log('ğŸ“¦ DIAGRAM_NODE_DATA:', typeof DIAGRAM_NODE_DATA !== 'undefined');
    log('ğŸ”§ DEBUG:', DEBUG);
    log('ğŸ“± Touch:', isTouchDevice);
    log('ğŸ“± iOS Standalone:', isIOSStandalone);

    // Mermaid ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸° í›„ ì´ˆê¸°í™”
    waitForMermaidRender().then(() => {
        log('â° ëŒ€ê¸° ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
        initializeDiagramInteractivity();
    });
});

/**
 * ë‹¤ì´ì–´ê·¸ë¨ ì¸í„°ë™í‹°ë¸Œ ê¸°ëŠ¥ ì´ˆê¸°í™”
 */
function initializeDiagramInteractivity() {
    const mermaidContainers = document.querySelectorAll('.mermaid');

    if (mermaidContainers.length === 0) {
        log('ğŸ“Š ì¸í„°ë™í‹°ë¸Œ ë‹¤ì´ì–´ê·¸ë¨: Mermaid ë‹¤ì´ì–´ê·¸ë¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    log(`ğŸ“Š ì¸í„°ë™í‹°ë¸Œ ë‹¤ì´ì–´ê·¸ë¨: ${mermaidContainers.length}ê°œì˜ ë‹¤ì´ì–´ê·¸ë¨ ë°œê²¬`);

    mermaidContainers.forEach((container, index) => {
        attachInteractiveHandlers(container, index);
    });

    log('âœ… ì¸í„°ë™í‹°ë¸Œ ë‹¤ì´ì–´ê·¸ë¨ ì´ˆê¸°í™” ì™„ë£Œ');
}

/**
 * ë‹¤ì´ì–´ê·¸ë¨ì— í´ë¦­/í˜¸ë²„ ì´ë²¤íŠ¸ ì¶”ê°€
 */
function attachInteractiveHandlers(container, diagramIndex) {
    const svg = container.querySelector('svg');

    if (!svg) {
        warn(`âš ï¸ SVGë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ë‹¤ì´ì–´ê·¸ë¨ ${diagramIndex})`);
        return;
    }

    // Mermaidê°€ ìƒì„±í•œ ëª¨ë“  ë…¸ë“œ ì°¾ê¸°
    const nodes = svg.querySelectorAll('.node');

    log(`  ë‹¤ì´ì–´ê·¸ë¨ ${diagramIndex}: ${nodes.length}ê°œ ë…¸ë“œ ë°œê²¬`);

    nodes.forEach((node, nodeIndex) => {
        const nodeId = extractNodeId(node);

        if (!nodeId) {
            return;
        }

        // ëª¨ë“  ë…¸ë“œì— ì¸í„°ë™í‹°ë¸Œ ì ìš© (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±)
        // ì»¤ì„œ ë° í„°ì¹˜ ê´€ë ¨ CSS ì„¤ì •
        node.style.cursor = 'pointer';
        node.style.transition = 'opacity 0.2s ease, transform 0.2s ease';

        // iOS standalone ëª¨ë“œ ë° í„°ì¹˜ ë””ë°”ì´ìŠ¤ë¥¼ ìœ„í•œ CSS ì†ì„± ì¶”ê°€
        node.style.touchAction = 'manipulation'; // ë”ë¸”íƒ­ ì¤Œ ë°©ì§€, íƒ­ì€ í—ˆìš©
        node.style.webkitTouchCallout = 'none';  // ê¸¸ê²Œ ëˆ„ë¥´ê¸° ì½œì•„ì›ƒ ë°©ì§€
        node.style.webkitUserSelect = 'none';    // í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
        node.style.userSelect = 'none';

        // SVG ìš”ì†Œì— pointer-events ëª…ì‹œì  ì„¤ì •
        node.setAttribute('pointer-events', 'all');

        // í„°ì¹˜/í´ë¦­ ìƒíƒœ ê´€ë¦¬
        let interactionStartTime = 0;
        let interactionStartX = 0;
        let interactionStartY = 0;
        let isInteracting = false;

        /**
         * ì¸í„°ë™ì…˜ ì‹œì‘ í•¸ë“¤ëŸ¬ (í„°ì¹˜/í¬ì¸í„° ê³µìš©)
         */
        function handleInteractionStart(clientX, clientY, type) {
            isInteracting = true;
            interactionStartTime = Date.now();
            interactionStartX = clientX;
            interactionStartY = clientY;

            // ì‹œê°ì  í”¼ë“œë°±
            node.style.transform = 'scale(1.05)';
            node.style.opacity = '0.8';
            log(`ğŸ‘† ${type} start: ${nodeId}`);
        }

        /**
         * ì¸í„°ë™ì…˜ ì¢…ë£Œ í•¸ë“¤ëŸ¬ (í„°ì¹˜/í¬ì¸í„° ê³µìš©)
         */
        function handleInteractionEnd(clientX, clientY, type) {
            if (!isInteracting) return;
            isInteracting = false;

            const duration = Date.now() - interactionStartTime;
            const deltaX = Math.abs(clientX - interactionStartX);
            const deltaY = Math.abs(clientY - interactionStartY);

            // ì‹œê°ì  í”¼ë“œë°± ë³µì›
            node.style.transform = '';
            node.style.opacity = '';

            // íƒ­/í´ë¦­ íŒì •: 500ms ì´í•˜ + ì´ë™ ê±°ë¦¬ 15px ì´í•˜
            if (duration < 500 && deltaX < 15 && deltaY < 15) {
                log(`âœ… ${type} íƒ­/í´ë¦­: ${nodeId} (${duration}ms)`);
                handleNodeClick(nodeId, node);
            }
        }

        /**
         * ì¸í„°ë™ì…˜ ì·¨ì†Œ í•¸ë“¤ëŸ¬
         */
        function handleInteractionCancel() {
            isInteracting = false;
            node.style.transform = '';
            node.style.opacity = '';
        }

        // iOS standalone ëª¨ë“œì—ì„œëŠ” í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ìš°ì„  ì‚¬ìš©
        if (isIOSStandalone || isTouchDevice) {
            log(`ğŸ“± í„°ì¹˜ ì´ë²¤íŠ¸ ë“±ë¡: ${nodeId} (iOS Standalone: ${isIOSStandalone})`);

            node.addEventListener('touchstart', (e) => {
                // ë‹¨ì¼ í„°ì¹˜ë§Œ ì²˜ë¦¬
                if (e.touches.length !== 1) return;

                const touch = e.touches[0];
                handleInteractionStart(touch.clientX, touch.clientY, 'touch');

                // iOS standaloneì—ì„œ ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ìŠ¤í¬ë¡¤ ì œì™¸)
                // e.preventDefault()ëŠ” passive ë¦¬ìŠ¤ë„ˆì—ì„œ ì‚¬ìš© ë¶ˆê°€
            }, { passive: true });

            node.addEventListener('touchend', (e) => {
                if (e.changedTouches.length !== 1) return;

                const touch = e.changedTouches[0];
                handleInteractionEnd(touch.clientX, touch.clientY, 'touch');

                // í´ë¦­ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
                e.preventDefault();
            }, { passive: false });

            node.addEventListener('touchcancel', handleInteractionCancel, { passive: true });

            node.addEventListener('touchmove', (e) => {
                // í„°ì¹˜ ì´ë™ ì‹œ ìƒí˜¸ì‘ìš© ì·¨ì†Œ
                if (isInteracting && e.touches.length === 1) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - interactionStartX);
                    const deltaY = Math.abs(touch.clientY - interactionStartY);

                    // 15px ì´ìƒ ì´ë™í•˜ë©´ ì·¨ì†Œ
                    if (deltaX > 15 || deltaY > 15) {
                        handleInteractionCancel();
                    }
                }
            }, { passive: true });
        }

        // Pointer Events (ë°ìŠ¤í¬í†± ë° ë°±ì—…ìš©)
        if (!isIOSStandalone) {
            node.addEventListener('pointerdown', (e) => {
                // í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ ì‚¬ìš© ì¤‘ì´ë©´ ë¬´ì‹œ
                if (isTouchDevice && e.pointerType === 'touch') return;

                handleInteractionStart(e.clientX, e.clientY, `pointer(${e.pointerType})`);
            });

            node.addEventListener('pointerup', (e) => {
                if (isTouchDevice && e.pointerType === 'touch') return;

                handleInteractionEnd(e.clientX, e.clientY, `pointer(${e.pointerType})`);
            });

            node.addEventListener('pointercancel', handleInteractionCancel);

            node.addEventListener('pointerleave', () => {
                if (isInteracting) {
                    handleInteractionCancel();
                }
            });
        }

        // ë°ìŠ¤í¬í†± í´ë¦­ ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤ ì „ìš© ë°±ì—…)
        if (!isTouchDevice) {
            node.addEventListener('click', (e) => {
                // ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ë¬´ì‹œ
                if (!isInteracting) {
                    log(`ğŸ–±ï¸ click ì´ë²¤íŠ¸: ${nodeId}`);
                    handleNodeClick(nodeId, node);
                }
            });
        }

        // í˜¸ë²„ ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤/ë°ìŠ¤í¬í†± ì „ìš©)
        if (!isTouchDevice) {
            node.addEventListener('mouseenter', (e) => {
                handleNodeHover(e, nodeId, node);
            });

            node.addEventListener('mouseleave', () => {
                handleNodeLeave(node);
            });
        }

        // ë°ì´í„° ìœ ë¬´ í‘œì‹œ (ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ)
        if (DEBUG) {
            const diagramData = getDiagramData();
            const hasData = !!diagramData[nodeId];
            const mode = isIOSStandalone ? 'iOS-standalone' : (isTouchDevice ? 'í„°ì¹˜' : 'ë§ˆìš°ìŠ¤');
            log(`    âœ“ ë…¸ë“œ "${nodeId}" ì¸í„°ë™í‹°ë¸Œ í™œì„±í™” (${mode} ëª¨ë“œ, ë°ì´í„°: ${hasData ? 'ìˆìŒ' : 'ìë™ìƒì„±'})`);
        }
    });
}

/**
 * Mermaid ë…¸ë“œì—ì„œ IDì™€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
 */
function extractNodeId(node) {
    // Mermaidì˜ ë…¸ë“œ IDëŠ” ì—¬ëŸ¬ ë°©ì‹ìœ¼ë¡œ ì €ì¥ë  ìˆ˜ ìˆìŒ
    // 1. id ì†ì„± (ê°€ì¥ í™•ì‹¤í•¨)
    // 2. class ì†ì„±
    // 3. data-id ì†ì„±

    let rawId = null;

    // 1. id ì†ì„± ì‹œë„ (ì˜ˆ: "flowchart-APP-123")
    if (node.id) {
        rawId = node.id;
        log(`      [ID ì¶”ì¶œ] id ì†ì„±: "${rawId}"`);
    }

    // 2. classì—ì„œ ì¶”ì¶œ ì‹œë„
    if (!rawId && node.classList) {
        const classList = Array.from(node.classList);
        const nodeClass = classList.find(c => c !== 'node' && c !== 'default');
        if (nodeClass) {
            rawId = nodeClass;
            log(`      [ID ì¶”ì¶œ] class ì†ì„±: "${rawId}"`);
        }
    }

    // 3. data-id ì‹œë„
    if (!rawId && node.dataset && node.dataset.id) {
        rawId = node.dataset.id;
        log(`      [ID ì¶”ì¶œ] data-id ì†ì„±: "${rawId}"`);
    }

    if (!rawId) {
        warn('      [ID ì¶”ì¶œ ì‹¤íŒ¨] ë…¸ë“œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return null;
    }

    // ID ì •ë¦¬
    const cleanedId = cleanNodeId(rawId);
    log(`      [ID ì •ë¦¬] "${rawId}" â†’ "${cleanedId}"`);

    // ë§¤í•‘ í…Œì´ë¸”ì—ì„œ ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” ì´ë¦„ìœ¼ë¡œ ë³€í™˜
    if (typeof NODE_ID_MAPPING !== 'undefined' && NODE_ID_MAPPING[cleanedId]) {
        const mappedId = NODE_ID_MAPPING[cleanedId];
        log(`      [ID ë§¤í•‘] "${cleanedId}" â†’ "${mappedId}"`);
        return mappedId;
    }

    // ë§¤í•‘ì´ ì—†ìœ¼ë©´ ì •ë¦¬ëœ ID ê·¸ëŒ€ë¡œ ë°˜í™˜
    return cleanedId;
}

/**
 * ë…¸ë“œì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (fallback ë°ì´í„° ìƒì„±ìš©)
 */
function extractNodeText(node) {
    const textElement = node.querySelector('text');
    if (textElement) {
        return textElement.textContent.trim();
    }
    return null;
}

/**
 * ë…¸ë“œ ID ì •ë¦¬ (Mermaidê°€ ì¶”ê°€í•˜ëŠ” ì ‘ë‘ì‚¬ ì œê±°)
 */
function cleanNodeId(id) {
    // MermaidëŠ” "flowchart-XXX-" ê°™ì€ ì ‘ë‘ì‚¬ë¥¼ ë¶™ì„
    // ì˜ˆ: "flowchart-MediaPlayer-123" -> "MediaPlayer"

    // ìˆ«ìë¡œ ëë‚˜ëŠ” ë¶€ë¶„ ì œê±°
    let cleaned = id.replace(/-\d+$/, '');

    // flowchart- ê°™ì€ ì ‘ë‘ì‚¬ ì œê±°
    cleaned = cleaned.replace(/^(flowchart|graph)-/i, '');

    // HTML ì—”í‹°í‹° ë””ì½”ë”© (&lt; -> <)
    const textarea = document.createElement('textarea');
    textarea.innerHTML = cleaned;
    cleaned = textarea.value;

    return cleaned;
}

/**
 * ë…¸ë“œ í´ë¦­ í•¸ë“¤ëŸ¬
 */
function handleNodeClick(nodeId, node) {
    log(`\nğŸ–±ï¸ ë…¸ë“œ í´ë¦­: "${nodeId}"`);

    const diagramData = getDiagramData();
    let nodeData = diagramData[nodeId];

    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë…¸ë“œ í…ìŠ¤íŠ¸ì—ì„œ ìë™ ìƒì„±
    if (!nodeData) {
        warn(`âš ï¸ ë…¸ë“œ ë°ì´í„° ì—†ìŒ. ê¸°ë³¸ ì •ë³´ ìë™ ìƒì„±...`);
        nodeData = generateFallbackNodeData(nodeId, node);
    }

    // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê¸°
    if (activeModal) {
        activeModal.remove();
    }

    // ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
    highlightNode(node);

    // ëª¨ë‹¬ í‘œì‹œ
    showNodeModal(nodeData);
}

/**
 * ë°ì´í„°ê°€ ì—†ëŠ” ë…¸ë“œë¥¼ ìœ„í•œ ê¸°ë³¸ ì •ë³´ ìƒì„±
 */
function generateFallbackNodeData(nodeId, node) {
    // ë…¸ë“œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
    const nodeText = extractNodeText(node);
    const lines = nodeText ? nodeText.split('\n').map(l => l.trim()).filter(l => l) : [];

    // ì²« ë²ˆì§¸ ì¤„ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
    const title = lines[0] || nodeId;

    // ë‚˜ë¨¸ì§€ ì¤„ì„ ì„¤ëª…ìœ¼ë¡œ ì‚¬ìš©
    const fallbackMsg = FALLBACK_MESSAGES[currentLang];
    const description = lines.slice(1).join(' â€¢ ') || fallbackMsg.description;

    // ë ˆì´ì–´ ìë™ íŒë‹¨ (ë…¸ë“œ ID ë˜ëŠ” í…ìŠ¤íŠ¸ ê¸°ë°˜)
    let layer = 'Component';
    if (nodeId.includes('APP') || title.includes('App')) {
        layer = 'Application Layer';
    } else if (nodeId.includes('FW') || nodeId.includes('FRAMEWORK') || title.includes('Framework')) {
        layer = 'Framework Layer';
    } else if (nodeId.includes('HAL') || title.includes('HAL')) {
        layer = 'HAL Layer';
    } else if (nodeId.includes('KERNEL') || nodeId.includes('DRIVER') || title.includes('Kernel') || title.includes('Driver')) {
        layer = 'Kernel Layer';
    } else if (nodeId.includes('SERVICE') || title.includes('Service')) {
        layer = 'System Service';
    } else if (nodeId.includes('NATIVE') || nodeId.includes('LIB') || title.includes('Native')) {
        layer = 'Native Layer';
    }

    return {
        title: title,
        layer: layer,
        description: description,
        components: lines.slice(1).length > 0 ? lines.slice(1) : [fallbackMsg.noData],
        autoGenerated: true
    };
}

/**
 * ë…¸ë“œ í˜¸ë²„ í•¸ë“¤ëŸ¬
 */
function handleNodeHover(event, nodeId, node) {
    const diagramData = getDiagramData();
    const nodeData = diagramData[nodeId];

    if (!nodeData) {
        return;
    }

    // ë…¸ë“œ íš¨ê³¼ (ìŠ¤ì¼€ì¼ ëŒ€ì‹  opacityì™€ shadow ì‚¬ìš©í•˜ì—¬ ë–¨ë¦¼ ë°©ì§€)
    node.style.opacity = '0.8';
    node.style.filter = 'drop-shadow(0 0 6px rgba(59, 130, 246, 0.6))';

    // íˆ´íŒ í‘œì‹œ
    showTooltip(event, nodeData);
}

/**
 * ë…¸ë“œ ë– ë‚  ë•Œ í•¸ë“¤ëŸ¬
 */
function handleNodeLeave(node) {
    // í•´ë‹¹ ë…¸ë“œë§Œ íš¨ê³¼ ì´ˆê¸°í™” (ë–¨ë¦¼ ë°©ì§€)
    if (node) {
        node.style.transform = '';
        node.style.opacity = '';
        node.style.filter = '';
    }

    // íˆ´íŒ ìˆ¨ê¸°ê¸°
    hideTooltip();
}

/**
 * ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸ (í´ë¦­ ì‹œ)
 */
function highlightNode(node) {
    // ëª¨ë“  ë…¸ë“œ ë°˜íˆ¬ëª…
    document.querySelectorAll('.mermaid svg .node').forEach(n => {
        n.style.opacity = '0.3';
    });

    // í´ë¦­í•œ ë…¸ë“œë§Œ ê°•ì¡°
    node.style.opacity = '1';
    node.style.filter = 'drop-shadow(0 0 8px rgba(0, 212, 255, 0.8))';

    // 3ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ
    setTimeout(() => {
        document.querySelectorAll('.mermaid svg .node').forEach(n => {
            n.style.opacity = '1';
            n.style.filter = '';
        });
    }, 3000);
}

/**
 * ëª¨ë‹¬ í‘œì‹œ
 */
function showNodeModal(nodeData) {
    const t = UI_TEXTS[currentLang]; // ì–¸ì–´ë³„ UI í…ìŠ¤íŠ¸

    // ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ ìƒì„±
    const modal = document.createElement('div');
    modal.className = 'diagram-modal';
    modal.id = 'diagramModal';

    // ê´€ë ¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë§í¬ URL (ì–¸ì–´ë³„)
    const issuesUrl = currentLang === 'en' ? '/en/common-media-issues.html' : 'common-media-issues.html';

    // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
    modal.innerHTML = `
        <div class="diagram-modal-overlay"></div>
        <div class="diagram-modal-content">
            <button class="diagram-modal-close" aria-label="${t.close}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="diagram-modal-header">
                <h2 class="diagram-modal-title">${nodeData.title}</h2>
                <span class="diagram-layer-badge">${nodeData.layer}</span>
                ${nodeData.autoGenerated ? `<span class="diagram-auto-badge">${t.autoGenerated}</span>` : ''}
            </div>

            <div class="diagram-modal-body">
                ${nodeData.autoGenerated ? `<div class="diagram-info-box">${t.autoGeneratedInfo}</div>` : ''}
                <p class="diagram-modal-description">${nodeData.description}</p>

                ${nodeData.components ? `
                    <div class="diagram-modal-section">
                        <h3>${t.components}</h3>
                        <ul class="diagram-component-list">
                            ${nodeData.components.map(comp => `<li>${comp}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${nodeData.codeExample ? `
                    <div class="diagram-modal-section">
                        <h3>${t.codeExample}</h3>
                        <pre class="diagram-code-block"><code>${escapeHtml(nodeData.codeExample)}</code></pre>
                    </div>
                ` : ''}

                ${nodeData.relatedIssues && nodeData.relatedIssues.length > 0 ? `
                    <div class="diagram-modal-section">
                        <h3>${t.relatedIssues}</h3>
                        <ul class="diagram-related-issues">
                            ${nodeData.relatedIssues.map(issue => `
                                <li>
                                    <a href="${issuesUrl}#${issue.id}" target="_blank" rel="noopener noreferrer">
                                        ${issue.title}
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${nodeData.path ? `
                    <div class="diagram-modal-section">
                        <h3>${t.aosp_path}</h3>
                        <code class="diagram-path">${nodeData.path}</code>
                    </div>
                ` : ''}
            </div>

            <div class="diagram-modal-footer">
                ${nodeData.doc ? `
                    <a href="${nodeData.doc}" target="_blank" rel="noopener noreferrer" class="diagram-btn diagram-btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                        </svg>
                        ${t.viewDocs}
                    </a>
                ` : ''}
                ${nodeData.path ? `
                    <a href="https://cs.android.com/android/platform/superproject/main/+/main:${nodeData.path}" target="_blank" rel="noopener noreferrer" class="diagram-btn diagram-btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
                        </svg>
                        ${t.viewSource}
                    </a>
                ` : ''}
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    activeModal = modal;

    log(`ğŸš¨ ëª¨ë‹¬ ìƒì„±: ${nodeData.title}`);

    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    requestAnimationFrame(() => {
        modal.classList.add('show');
    });

    // ë‹«ê¸° ì´ë²¤íŠ¸
    const closeBtn = modal.querySelector('.diagram-modal-close');
    const overlay = modal.querySelector('.diagram-modal-overlay');

    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }

    if (overlay) {
        overlay.addEventListener('click', closeModal);
    }

    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', handleEscKey);
}

/**
 * ëª¨ë‹¬ ë‹«ê¸°
 */
function closeModal() {
    if (!activeModal) return;

    activeModal.classList.remove('show');

    setTimeout(() => {
        if (activeModal) {
            activeModal.remove();
            activeModal = null;
        }
    }, 300);

    document.removeEventListener('keydown', handleEscKey);

    // í•˜ì´ë¼ì´íŠ¸ í•´ì œ
    document.querySelectorAll('.mermaid svg .node').forEach(n => {
        n.style.opacity = '1';
        n.style.filter = '';
    });
}

/**
 * ESC í‚¤ í•¸ë“¤ëŸ¬
 */
function handleEscKey(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
}

/**
 * íˆ´íŒ í‘œì‹œ
 */
function showTooltip(event, nodeData) {
    const t = UI_TEXTS[currentLang]; // ì–¸ì–´ë³„ UI í…ìŠ¤íŠ¸

    // ê¸°ì¡´ íˆ´íŒ ì œê±°
    hideTooltip();

    const tooltip = document.createElement('div');
    tooltip.className = 'diagram-tooltip';
    tooltip.innerHTML = `
        <strong>${nodeData.title}</strong>
        <span>${nodeData.layer}</span>
        <p>${t.clickForDetails}</p>
    `;

    // ìœ„ì¹˜ ê³„ì‚°
    tooltip.style.left = event.pageX + 15 + 'px';
    tooltip.style.top = event.pageY - 10 + 'px';

    document.body.appendChild(tooltip);
    activeTooltip = tooltip;

    // ì• ë‹ˆë©”ì´ì…˜
    requestAnimationFrame(() => {
        tooltip.classList.add('show');
    });
}

/**
 * íˆ´íŒ ìˆ¨ê¸°ê¸°
 */
function hideTooltip() {
    if (activeTooltip) {
        activeTooltip.classList.remove('show');
        setTimeout(() => {
            if (activeTooltip) {
                activeTooltip.remove();
                activeTooltip = null;
            }
        }, 200);
    }
}

/**
 * HTML ì´ìŠ¤ì¼€ì´í”„
 */
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
